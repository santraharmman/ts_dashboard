---
title: "Pre and Posttest Analysis - Telangana"
format: dashboard
logo: "plots/ihrptm.jpg"
fig-width: 10
fig-height: 8
dpi: 600
theme: journal
css: styles.css
scrolling: true
---

```{r}
#| echo: false
#| warning: false
#| message: false

# Load necessary libraries
library(tidyverse)
library(here)
library(rio)
library(dplyr)
library(ggplot2)
library(gtsummary)
library(gt)
library(tidyr)
library(viridis)
library(glue)

# Define the file paths
filepaths <- c(
here::here('data','ts_cleaned_data','anm_cleaned_qanc_ts.csv'),
here::here('data','ts_cleaned_data','anm_cleaned_ane_ts.csv'),
here::here('data','ts_cleaned_data','anm_cleaned_htn_ts.csv'),
here::here('data','ts_cleaned_data','anm_cleaned_gdm_ts.csv'),
here::here('data','ts_cleaned_data','anm_cleaned_aph_ts.csv')
)
 

# Import all files as data frames
data_frames_anm1 <- lapply(filepaths, read.csv)

# Bind all data frames into a single data frame
df_anm1 <- do.call(rbind, data_frames_anm1)

# Clean the data
df_anm1 <- df_anm1 |>
  janitor::clean_names()

# Remove unwanted columns
df_anm1 <- df_anm1 |>
  select(-c("number",
            "name_post", 
            "age_post", 
            "entry_post", 
            "districts_post", 
            "phc_name_post", 
            "experience_post", 
            "mobile_no_post",
            "date_post"))

# Ensure age_pre is a character type, then numeric
df_anm1$age_pre <- as.character(df_anm1$age_pre)

# Convert to numeric
df_anm1$age_pre <- as.numeric(df_anm1$age_pre)

# Current year
current_year <- as.numeric(format(Sys.Date(), "%Y"))

# Identify year values in `age_pre` and convert them to age
df_anm1$age_pre <- ifelse(df_anm1$age_pre >= 1900 & df_anm1$age_pre <= current_year,  # Year format
                     current_year - df_anm1$age_pre,  # Convert year to age
                     df_anm1$age_pre)  # Keep other values unchanged

#Change the district names and mutate a column with the concerned district names

df_anm1 <- df_anm1 %>%
  mutate(district_name = case_when(
    districts_pre == 1 ~ "Adilabad",
    districts_pre == 2 ~ "Bhadradri Kothagudem",
    districts_pre == 3 ~ "Hyderabad",
    districts_pre == 4 ~ "Jagtial",
    districts_pre == 5 ~ "Jangaon",
    districts_pre == 6 ~ "Jayashankar Bhupalpally",
    districts_pre == 7 ~ "Jogulamba Gadwal",
    districts_pre == 8 ~ "Kamareddy",
    districts_pre == 9 ~ "Karimnagar",
    districts_pre == 10 ~ "Khammam",
    districts_pre == 11 ~ "Komaram Bheem Asifabad",
    districts_pre == 12 ~ "Mahabubabad",
    districts_pre == 13 ~ "Mahabubnagar",
    districts_pre == 14 ~ "Mancherial",
    districts_pre == 15 ~ "Medak",
    districts_pre == 16 ~ "Medchal Malkajgiri",
    districts_pre == 17 ~ "Mulugu",
    districts_pre == 18 ~ "Nagarkurnool",
    districts_pre == 19 ~ "Nalgonda",
    districts_pre == 20 ~ "Narayanpet",
    districts_pre == 21 ~ "Nirmal",
    districts_pre == 22 ~ "Nizamabad",
    districts_pre == 23 ~ "Peddapalli",
    districts_pre == 24 ~ "Rajanna Sircilla",
    districts_pre == 25 ~ "Rangareddy",
    districts_pre == 26 ~ "Sangareddy",
    districts_pre == 27 ~ "Siddipet",
    districts_pre == 28 ~ "Suryapet",
    districts_pre == 29 ~ "Vikarabad",
    districts_pre == 30 ~ "Wanaparthy",
    districts_pre == 31 ~ "Warangal Rural",
    districts_pre == 32 ~ "Warangal Urban",
    districts_pre == 33 ~ "Yadadri Bhuvanagiri",
    TRUE ~ NA_character_
  ))

#QANC Correct answers 
#Pre 
df_anm1 <- df_anm1 %>%
  mutate(
    q1_pre = ifelse(condition == "qanc", ifelse(q1_pre == 4, 1, 0), q1_pre),
    q2_pre = ifelse(condition == "qanc", ifelse(q2_pre == 3, 1, 0), q2_pre),
    q3_pre = ifelse(condition == "qanc", ifelse(q3_pre == 1, 1, 0), q3_pre),
    q4_pre = ifelse(condition == "qanc", ifelse(q4_pre == 4, 1, 0), q4_pre),
    q5_pre = ifelse(condition == "qanc", ifelse(q5_pre == 1, 1, 0), q5_pre),
    q6_pre = ifelse(condition == "qanc", ifelse(q6_pre == 4, 1, 0), q6_pre),
    q7_pre = ifelse(condition == "qanc", ifelse(q7_pre == 2, 1, 0), q7_pre),
    q8_pre = ifelse(condition == "qanc", ifelse(q8_pre == 1, 1, 0), q8_pre),
    q9_pre = ifelse(condition == "qanc", ifelse(q9_pre == 2, 1, 0), q9_pre),
    q10_pre = ifelse(condition == "qanc", ifelse(q10_pre == 1, 1, 0), q10_pre))
   

#Post
df_anm1 <- df_anm1 %>%
  mutate(
    q1_post = ifelse(condition == "qanc", ifelse(q1_post == 4, 1, 0), q1_post),
    q2_post = ifelse(condition == "qanc", ifelse(q2_post == 3, 1, 0), q2_post),
    q3_post = ifelse(condition == "qanc", ifelse(q3_post == 1, 1, 0), q3_post),
    q4_post = ifelse(condition == "qanc", ifelse(q4_post == 4, 1, 0), q4_post),
    q5_post = ifelse(condition == "qanc", ifelse(q5_post == 1, 1, 0), q5_post),
    q6_post = ifelse(condition == "qanc", ifelse(q6_post == 4, 1, 0), q6_post),
    q7_post = ifelse(condition == "qanc", ifelse(q7_post == 2, 1, 0), q7_post),
    q8_post = ifelse(condition == "qanc", ifelse(q8_post == 1, 1, 0), q8_post),
    q9_post = ifelse(condition == "qanc", ifelse(q9_post == 2, 1, 0), q9_post),
    q10_post = ifelse(condition == "qanc", ifelse(q10_post == 1, 1, 0), q10_post))

#Anaemia correct answers
#pre

df_anm1 <- df_anm1 %>%
  mutate(
    q1_pre = ifelse(condition == "ane", ifelse(q1_pre == 1, 1, 0), q1_pre),
    q2_pre = ifelse(condition == "ane", ifelse(q2_pre == 1, 1, 0), q2_pre),
    q3_pre = ifelse(condition == "ane", ifelse(q3_pre == 4, 1, 0), q3_pre),
    q4_pre = ifelse(condition == "ane", ifelse(q4_pre == 1, 1, 0), q4_pre),
    q5_pre = ifelse(condition == "ane", ifelse(q5_pre == 1, 1, 0), q5_pre),
    q6_pre = ifelse(condition == "ane", ifelse(q6_pre == 3, 1, 0), q6_pre),
    q7_pre = ifelse(condition == "ane", ifelse(q7_pre == 2, 1, 0), q7_pre),
    q8_pre = ifelse(condition == "ane", ifelse(q8_pre == 4, 1, 0), q8_pre),
    q9_pre = ifelse(condition == "ane", ifelse(q9_pre == 5, 1, 0), q9_pre),
    q10_pre = ifelse(condition == "ane", ifelse(q10_pre == 4, 1, 0), q10_pre))
  


#Post
df_anm1 <- df_anm1 %>%
  mutate(
    q1_post = ifelse(condition == "ane", ifelse(q1_post == 1, 1, 0), q1_post),
    q2_post = ifelse(condition == "ane", ifelse(q2_post == 1, 1, 0), q2_post),
    q3_post = ifelse(condition == "ane", ifelse(q3_post == 4, 1, 0), q3_post),
    q4_post = ifelse(condition == "ane", ifelse(q4_post == 1, 1, 0), q4_post),
    q5_post = ifelse(condition == "ane", ifelse(q5_post == 1, 1, 0), q5_post),
    q6_post = ifelse(condition == "ane", ifelse(q6_post == 3, 1, 0), q6_post),
    q7_post = ifelse(condition == "ane", ifelse(q7_post == 2, 1, 0), q7_post),
    q8_post = ifelse(condition == "ane", ifelse(q8_post == 4, 1, 0), q8_post),
    q9_post = ifelse(condition == "ane", ifelse(q9_post == 5, 1, 0), q9_post),
    q10_post = ifelse(condition == "ane", ifelse(q10_post == 4, 1, 0), q10_post))
  

#HTN correct answers
#Pre

df_anm1 <- df_anm1 %>%
  mutate(
    q1_pre = ifelse(condition == "htn", ifelse(q1_pre == 1, 1, 0), q1_pre),
    q2_pre = ifelse(condition == "htn", ifelse(q2_pre == 4, 1, 0), q2_pre),
    q3_pre = ifelse(condition == "htn", ifelse(q3_pre == 4, 1, 0), q3_pre),
    q4_pre = ifelse(condition == "htn", ifelse(q4_pre == 3, 1, 0), q4_pre),
    q5_pre = ifelse(condition == "htn", ifelse(q5_pre == 1, 1, 0), q5_pre),
    q6_pre = ifelse(condition == "htn", ifelse(q6_pre == 4, 1, 0), q6_pre),
    q7_pre = ifelse(condition == "htn", ifelse(q7_pre == 3, 1, 0), q7_pre),
    q8_pre = ifelse(condition == "htn", ifelse(q8_pre == 3, 1, 0), q8_pre),
    q9_pre = ifelse(condition == "htn", ifelse(q9_pre == 4, 1, 0), q9_pre),
    q10_pre = ifelse(condition == "htn", ifelse(q10_pre == 4, 1, 0), q10_pre))
    

#Post
df_anm1 <- df_anm1 %>%
  mutate(
    q1_post = ifelse(condition == "htn", ifelse(q1_post == 1, 1, 0), q1_post),
    q2_post = ifelse(condition == "htn", ifelse(q2_post == 4, 1, 0), q2_post),
    q3_post = ifelse(condition == "htn", ifelse(q3_post == 4, 1, 0), q3_post),
    q4_post = ifelse(condition == "htn", ifelse(q4_post == 3, 1, 0), q4_post),
    q5_post = ifelse(condition == "htn", ifelse(q5_post == 1, 1, 0), q5_post),
    q6_post = ifelse(condition == "htn", ifelse(q6_post == 4, 1, 0), q6_post),
    q7_post = ifelse(condition == "htn", ifelse(q7_post == 3, 1, 0), q7_post),
    q8_post = ifelse(condition == "htn", ifelse(q8_post == 3, 1, 0), q8_post),
    q9_post = ifelse(condition == "htn", ifelse(q9_post == 4, 1, 0), q9_post),
    q10_post = ifelse(condition == "htn", ifelse(q10_post == 4, 1, 0), q10_post))
   

#GDM Correct answers 
#Pre 

df_anm1 <- df_anm1 %>%
  mutate(
    q1_pre = ifelse(condition == "gdm", ifelse(q1_pre == 3, 1, 0), q1_pre),
    q2_pre = ifelse(condition == "gdm", ifelse(q2_pre == 3, 1, 0), q2_pre),
    q3_pre = ifelse(condition == "gdm", ifelse(q3_pre == 1, 1, 0), q3_pre),
    q4_pre = ifelse(condition == "gdm", ifelse(q4_pre == 2, 1, 0), q4_pre),
    q5_pre = ifelse(condition == "gdm", ifelse(q5_pre == 1, 1, 0), q5_pre),
    q6_pre = ifelse(condition == "gdm", ifelse(q6_pre == 4, 1, 0), q6_pre),
    q7_pre = ifelse(condition == "gdm", ifelse(q7_pre == 2, 1, 0), q7_pre),
    q8_pre = ifelse(condition == "gdm", ifelse(q8_pre == 2, 1, 0), q8_pre),
    q9_pre = ifelse(condition == "gdm", ifelse(q9_pre == 4, 1, 0), q9_pre),
    q10_pre = ifelse(condition == "gdm", ifelse(q10_pre == 2, 1, 0), q10_pre))
   

#Post

df_anm1 <- df_anm1 %>%
  mutate(
    q1_post = ifelse(condition == "gdm", ifelse(q1_post == 3, 1, 0), q1_post),
    q2_post = ifelse(condition == "gdm", ifelse(q2_post == 3, 1, 0), q2_post),
    q3_post = ifelse(condition == "gdm", ifelse(q3_post == 1, 1, 0), q3_post),
    q4_post = ifelse(condition == "gdm", ifelse(q4_post == 2, 1, 0), q4_post),
    q5_post = ifelse(condition == "gdm", ifelse(q5_post == 1, 1, 0), q5_post),
    q6_post = ifelse(condition == "gdm", ifelse(q6_post == 4, 1, 0), q6_post),
    q7_post = ifelse(condition == "gdm", ifelse(q7_post == 2, 1, 0), q7_post),
    q8_post = ifelse(condition == "gdm", ifelse(q8_post == 2, 1, 0), q8_post),
    q9_post = ifelse(condition == "gdm", ifelse(q9_post == 4, 1, 0), q9_post),
    q10_post = ifelse(condition == "gdm", ifelse(q10_post == 2, 1, 0), q10_post))
    
#APH Correct answers 

#Pre
df_anm1 <- df_anm1 %>%
  mutate(
    q1_pre = ifelse(condition == "aph", ifelse(q1_pre == 2, 1, 0), q1_pre),
    q2_pre = ifelse(condition == "aph", ifelse(q2_pre == 1, 1, 0), q2_pre),
    q3_pre = ifelse(condition == "aph", ifelse(q3_pre == 4, 1, 0), q3_pre),
    q4_pre = ifelse(condition == "aph", ifelse(q4_pre == 3, 1, 0), q4_pre),
    q5_pre = ifelse(condition == "aph", ifelse(q5_pre == 4, 1, 0), q5_pre),
    q6_pre = ifelse(condition == "aph", ifelse(q6_pre == 4, 1, 0), q6_pre),
    q7_pre = ifelse(condition == "aph", ifelse(q7_pre == 4, 1, 0), q7_pre),
    q8_pre = ifelse(condition == "aph", ifelse(q8_pre == 3, 1, 0), q8_pre),
    q9_pre = ifelse(condition == "aph", ifelse(q9_pre == 4, 1, 0), q9_pre),
    q10_pre = ifelse(condition == "aph", ifelse(q10_pre == 3, 1, 0), q10_pre))
    
#Post

df_anm1 <- df_anm1 %>%
  mutate(
    q1_post = ifelse(condition == "aph", ifelse(q1_post == 2, 1, 0), q1_post),
    q2_post = ifelse(condition == "aph", ifelse(q2_post == 1, 1, 0), q2_post),
    q3_post = ifelse(condition == "aph", ifelse(q3_post == 4, 1, 0), q3_post),
    q4_post = ifelse(condition == "aph", ifelse(q4_post == 3, 1, 0), q4_post),
    q5_post = ifelse(condition == "aph", ifelse(q5_post == 4, 1, 0), q5_post),
    q6_post = ifelse(condition == "aph", ifelse(q6_post == 4, 1, 0), q6_post),
    q7_post = ifelse(condition == "aph", ifelse(q7_post == 4, 1, 0), q7_post),
    q8_post = ifelse(condition == "aph", ifelse(q8_post == 3, 1, 0), q8_post),
    q9_post = ifelse(condition == "aph", ifelse(q9_post == 4, 1, 0), q9_post),
    q10_post = ifelse(condition == "aph", ifelse(q10_post == 3, 1, 0), q10_post))
                                    

# Sum of Pre and post total correct scores
df_anm1 <- df_anm1 %>%
  mutate(
    pre_total_correct = rowSums(select(., starts_with("q") & ends_with("pre"))),
    post_total_correct = rowSums(select(., starts_with("q") & ends_with("post")))
  )

df_anm1 <- df_anm1 |> 
  mutate(relative_change = post_total_correct - pre_total_correct)

# Adding relative change column and creating code for the same
df_anm1 <- df_anm1 %>%
  mutate(rc_code = case_when(
    relative_change == 0 ~ "No Change",
    relative_change %in% c(-1, -2) ~ "-1 to -2",
    relative_change %in% c(1, 2) ~ "1 to 2",
    relative_change >= 3 ~ "+3 and above",
    relative_change <= -3 ~ "-3 and below",
    TRUE ~ NA_character_  # Ensure that the NA type is character to match the other outcomes
  ))

df_anm1 <- df_anm1 %>%
  mutate(rc_positive_negative_code = case_when(
    relative_change == 0 ~ "No Change",
    relative_change %in% c(-1, -2) ~ "Negative change",
    relative_change %in% c(1, 2) ~ "Positive change",
    relative_change >= 3 ~ "Positive change",
    relative_change <= -3 ~ "Negative change",
    TRUE ~ NA_character_  # Ensure that the NA type is character to match the other outcomes
  ))

# Create summary statistics grouped by district_name and condition
sta1_anm1 <- df_anm1 %>%
  group_by(district_name, condition) %>%
  summarise(
    pre_mean = round(mean(pre_total_correct, na.rm = TRUE), 1),
    pre_std = round(sd(pre_total_correct, na.rm = TRUE), 1),
    pre_mean_pct = round((mean(pre_total_correct, na.rm = TRUE) / 10) * 100, 1),  # Pre-test percentage
    post_mean = round(mean(post_total_correct, na.rm = TRUE), 1),
    post_std = round(sd(post_total_correct, na.rm = TRUE), 1),
    post_mean_pct = round((mean(post_total_correct, na.rm = TRUE) / 10) * 100, 1),  # Post-test percentage
    p_value = ifelse(
      sum(!is.na(pre_total_correct)) > 1 & sum(!is.na(post_total_correct)) > 1, 
      round(t.test(pre_total_correct, post_total_correct)$p.value, 6), 
      NA
    )
  )
# Calculate state average (overall mean, std, and percentage grouped by condition)
state_avg_anm1 <- df_anm1 %>%
  group_by(condition) %>%
  summarise(
    pre_mean = round(mean(pre_total_correct, na.rm = TRUE), 1),
    pre_std = round(sd(pre_total_correct, na.rm = TRUE), 1),
    pre_mean_pct = round((mean(pre_total_correct, na.rm = TRUE) / 10) * 100, 1),  # Pre-test percentage
    post_mean = round(mean(post_total_correct, na.rm = TRUE), 1),
    post_std = round(sd(post_total_correct, na.rm = TRUE), 1),
    post_mean_pct = round((mean(post_total_correct, na.rm = TRUE) / 10) * 100, 1)  # Post-test percentage
  ) %>%
  mutate(district_name = "Overall Average")  # Add state average label

# Combine district-level and state-level data
sta1_anm1 <- bind_rows(sta1_anm1, state_avg_anm1)


# Save sta1 as a CSV file
write.csv(sta1_anm1, "tables/sta1_summary_anm1_ts_1.csv", row.names = FALSE)

# Overall mean, std and percentage grouped by condition
sta2_anm1 <- df_anm1 %>%
  group_by(condition) %>%
  summarise(
    n = n(),  # Count of rows for each condition
    pre_mean = round(mean(pre_total_correct, na.rm = TRUE), 1),
    pre_std = round(sd(pre_total_correct, na.rm = TRUE), 1),
    pre_mean_pct = round((mean(pre_total_correct, na.rm = TRUE) / 10) * 100, 1),  # Pre-test percentage
    post_mean = round(mean(post_total_correct, na.rm = TRUE), 1),
    post_std = round(sd(post_total_correct, na.rm = TRUE), 1),
    post_mean_pct = round((mean(post_total_correct, na.rm = TRUE) / 10) * 100, 1)  # Post-test percentage
  )

# Calculate state average (same as above)
state_avg_anm1 <- df_anm1 %>%
  summarise(
    pre_mean = round(mean(pre_total_correct, na.rm = TRUE), 1),
    pre_std = round(sd(pre_total_correct, na.rm = TRUE), 1),
    pre_mean_pct = round((mean(pre_total_correct, na.rm = TRUE) / 10) * 100, 1),  # Pre-test percentage
    post_mean = round(mean(post_total_correct, na.rm = TRUE), 1),
    post_std = round(sd(post_total_correct, na.rm = TRUE), 1),
    post_mean_pct = round((mean(post_total_correct, na.rm = TRUE) / 10) * 100, 1)  # Post-test percentage
  ) %>%
  mutate(condition = "Overall Average")  # Add state average label

# Combine condition-level and state-level data
sta2_anm1 <- bind_rows(sta2_anm1, state_avg_anm1)

# Save sta2 as a CSV file
write.csv(sta2_anm1, "tables/sta2_summary_anm1_ts_1.csv", row.names = FALSE)

# Reorder condition factor based on post-test mean percentage in descending order
sta2_anm1 <- sta2_anm1 %>%
  arrange(desc(post_mean_pct)) %>%
  mutate(condition = factor(condition, levels = condition))

# Reshape the data from wide to long format using tidyr's pivot_longer
sta2_long_anm1 <- tidyr::pivot_longer(sta2_anm1, 
                                 cols = c("pre_mean_pct", "post_mean_pct"), 
                                 names_to = "Time", 
                                 values_to = "Mean_Pct")

# Calculate the gain in knowledge for each condition
knowledge_gain_anm1 <- sta2_anm1 %>%
  mutate(Gain = post_mean_pct - pre_mean_pct) %>%
  select(condition, Gain)

# Reorder 'Time' factor levels to ensure 'pre' comes before 'post'
sta2_long_anm1$Time <- factor(sta2_long_anm1$Time, levels = c("pre_mean_pct", "post_mean_pct"))

# Combine data for all conditions
relative_change_combined_anm1 <- df_anm1 %>%
  count(condition, rc_positive_negative_code) %>%  # Count occurrences for each condition and change type
  group_by(condition) %>%  # Group by condition
  mutate(percentage = n / sum(n) * 100)  # Calculate percentage

# Reorder 'condition' based on descending percentage of "Positive change"
positive_order_anm1 <- relative_change_combined_anm1 %>%
  filter(rc_positive_negative_code == "Positive change") %>%
  arrange(percentage) %>%  # Sort in ascending order
  pull(condition)  # Extract the ordered conditions

relative_change_combined_anm1 <- relative_change_combined_anm1 %>%
  mutate(condition = factor(condition, levels = positive_order_anm1))  # Reorder factor levels

# Replace condition abbreviations with full names
sta2_anm1 <- sta2_anm1 %>%
  mutate(condition_name = case_when(
    condition == "ane" ~ "Anaemia",
    condition == "aph" ~ "Antepartum Haemorrhage",
    condition == "gdm" ~ "Gestational Diabetes",
    condition == "htn" ~ "Hypertension",
    condition == "qanc" ~ "Quality ANC",
    TRUE ~ condition  # Keep other values unchanged (if any)
  ))

# Map - Trainings happening in districts

library(sf)

# Load the GeoJSON file
telangana_sf_anm1 <- st_read(here::here("data", "ts_cleaned_data", "telangana.json"), quiet = TRUE)

# Create district responses from your dataset (df_anm1)
# Pull number of responses
district_responses_anm1 <- df_anm1 %>%
  group_by(district_name) %>%
  summarise(no_of_responses = n())

# Mutate the District column in telangana_sf to match district_responses
telangana_sf_anm1 <- telangana_sf_anm1 %>%
  mutate(district_name = case_when(
    District == "ADILABAD" ~ "Adilabad",
    District == "BHADRADRI KOTHAGUDEM" ~ "Bhadradri Kothagudem",
    District == "HYDERABAD" ~ "Hyderabad",
    District == "JAGTIAL" ~ "Jagtial",
    District == "JANGAON" ~ "Jangaon",
    District == "JAYASHANKAR BHUPALAPALLY" ~ "Jayashankar Bhupalpally",
    District == "JOGULAMBA GADWAL" ~ "Jogulamba Gadwal",
    District == "KAMAREDDY" ~ "Kamareddy",
    District == "KARIMNAGAR" ~ "Karimnagar",
    District == "KHAMMAM" ~ "Khammam",
    District == "KUMURAM BHEEM" ~ "Komaram Bheem Asifabad",
    District == "MAHABUBABAD" ~ "Mahabubabad",
    District == "MAHABUBNAGAR" ~ "Mahabubnagar",
    District == "MANCHERIAL" ~ "Mancherial",
    District == "MEDAK" ~ "Medak",
    District == "MEDCHAL-MALKAJGIRI" ~ "Medchal Malkajgiri",
    District == "MULUGU" ~ "Mulugu",
    District == "NAGARKURNOOL" ~ "Nagarkurnool",
    District == "NALGONDA" ~ "Nalgonda",
    District == "NARAYANPET" ~ "Narayanpet",
    District == "NIRMAL" ~ "Nirmal",
    District == "NIZAMABAD" ~ "Nizamabad",
    District == "PEDDAPALLI" ~ "Peddapalli",
    District == "RANJANNA SIRCILLA" ~ "Rajanna Sircilla",
    District == "RANGAREDDY" ~ "Rangareddy",
    District == "SANGAREDDY" ~ "Sangareddy",
    District == "SIDDIPET" ~ "Siddipet",
    District == "SURYAPET" ~ "Suryapet",
    District == "VIKARABAD" ~ "Vikarabad",
    District == "WANAPARTHY" ~ "Wanaparthy",
    District == "WARANGAL (RURAL)" ~ "Warangal Rural",
    District == "WARANGAL (URBAN)" ~ "Warangal Urban",
    District == "YADADRI BHUVANAGIRI" ~ "Yadadri Bhuvanagiri",
    TRUE ~ District  # Keep original value if no match
  ))

# Join the standardized district_responses with telangana_sf
merged_tg_sf_anm1 <- telangana_sf_anm1 %>%
  left_join(district_responses_anm1, by = "district_name")

# Identify districts with responses
merged_tg_sf_anm1 <- merged_tg_sf_anm1 %>%
  mutate(map = ifelse(!is.na(no_of_responses), 1, 0))

# Plot the map
telangana_map_plot_anm1 <- ggplot(merged_tg_sf_anm1) +
  geom_sf(aes(fill = factor(map)), color = "black") +
  scale_fill_manual(values = c("0" = "grey90", "1" = "lightgreen")) +
  geom_sf_text(data = merged_tg_sf_anm1 %>% filter(map == 1), aes(label = District), size = 3) + 
  theme_void() +
  theme(legend.position = "none")

# Plot the map
telangana_map_plot_anm1 <- ggplot(merged_tg_sf_anm1) +
  geom_sf(aes(fill = factor(map)), color = "black") +
  scale_fill_manual(values = c("0" = "grey90", "1" = "lightgreen")) +
  geom_sf_text(data = merged_tg_sf_anm1 %>% filter(map == 1), aes(label = District), size = 3) + 
  theme_void() +
  theme(legend.position = "none")

# Save the plot in the "images" folder using ggsave
ggsave("plots/telangana_map_plot_anm1_1.png", plot = telangana_map_plot_anm1, width = 8, height = 6, dpi = 300)

# Create a new column to differentiate the state average from other conditions
sta2_long_anm1 <- sta2_long_anm1 %>%
  mutate(state_avg = ifelse(condition == "Overall Average", "Overall Average", "Conditions"))

# Create the ggplot bar chart with adjustments for spacing and legibility
pre_post_mean_pct_anm1 <- ggplot(sta2_long_anm1, aes(x = condition, y = Mean_Pct, fill = interaction(Time, state_avg))) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.8), width = 0.7) +  # Increase spacing
  scale_fill_manual(values = c("pre_mean_pct.Conditions" = "blue", 
                               "post_mean_pct.Conditions" = "orange",
                               "pre_mean_pct.Overall Average" = "lightskyblue", 
                               "post_mean_pct.Overall Average" = "lightgreen")) +
  geom_text(aes(label = round(Mean_Pct, 1)), 
            position = position_dodge(width = 0.8),  # Adjust text position to align with the new dodge width
            vjust = -0.5) +  # Adjust label position
  labs(x = "Condition", y = "Mean %") +
  theme_minimal() +
  theme(
    legend.title = element_blank(),
    axis.text.x = element_text(size = 12, face = "bold", angle = 45, hjust = 1),  # Rotate axis labels for better legibility
    axis.title.x = element_text(size = 14, face = "bold"),
    plot.margin = margin(10, 20, 10, 20),  # Add space around the plot
    panel.grid.major.x = element_blank(),  # Optional: remove vertical grid lines for clarity
    panel.grid.minor.x = element_blank()
  ) +
  # Add gain in knowledge as annotations below the x-axis labels
  annotate("text", 
           x = knowledge_gain_anm1$condition, 
           y = -5,  # Position slightly below the x-axis
           label = paste0(round(knowledge_gain_anm1$Gain, 1), "%"),
           size = 3.5, 
           color = "red")

# Save the plot in the "plots" directory
ggsave("plots/pre_post_mean_pct_anm1_1.png", 
       plot = pre_post_mean_pct_anm1, 
       width = 10, 
       height = 6, 
       dpi = 300)


# Create the plot object
plot_relative_change_anm1 <- ggplot(relative_change_combined_anm1, aes(x = percentage, y = condition, fill = rc_positive_negative_code)) +
  geom_bar(stat = "identity", position = "dodge", width = 0.7) +
  geom_text(aes(label = sprintf("%.1f%%", percentage)), 
            position = position_dodge(width = 0.9), 
            hjust = -0.2, 
            size = 3) +
  labs(x = "Percentage (%)", y = "Condition") +
  scale_fill_manual(values = c("Positive change" = "darkgreen", 
                               "Negative change" = "red", 
                               "No Change" = "orange")) +
  scale_x_continuous(expand = expansion(mult = c(0, 0.1))) +
  theme_minimal(base_size = 12) +
  theme(
    axis.text.y = element_text(size = 10),
    axis.text.x = element_text(size = 10),
    axis.title.x = element_text(size = 12, face = "bold"),
    axis.title.y = element_text(size = 12, face = "bold"),
    plot.title = element_text(size = 14, face = "bold", hjust = 0.5),
    legend.title = element_blank(),
    legend.text = element_text(size = 10)
  )

# Save the plot in the "plots" directory
ggsave("plots/plot_relative_change_anm1_1.png", 
       plot = plot_relative_change_anm1, 
       width = 10, 
       height = 6, 
       dpi = 300)


# Add condition names
relative_change_combined_anm1 <- relative_change_combined_anm1 %>%
  mutate(condition_name = case_when(
    condition == "qanc" ~ "Quality ANC",
    condition == "ane" ~ "Anaemia",
    condition == "gdm" ~ "Gestational Diabetes",
    condition == "aph" ~ "Antepartum Hemorrhage",
    condition == "htn" ~ "Hypertension",
    TRUE ~ condition
  ))

# Filter for 'Positive change'
positive_changes_anm1 <- relative_change_combined_anm1 %>% 
  filter(rc_positive_negative_code == "Positive change")

# Find the index of the maximum percentage
max_index_anm1 <- which.max(positive_changes_anm1$percentage)

# Extract the row with the highest percentage
highest_positive_change_anm1 <- positive_changes_anm1[max_index_anm1, ]

# Extract the corresponding condition name
condition_name1_anm1 <- highest_positive_change_anm1$condition_name

# Filter for 'Negative change'
negative_changes_anm1 <- relative_change_combined_anm1 %>% 
  filter(rc_positive_negative_code == "Negative change")

# Find the index of the maximum percentage
max_index_anm1 <- which.max(negative_changes_anm1$percentage)

# Extract the row with the highest percentage
highest_negative_change_anm1 <- negative_changes_anm1[max_index_anm1, ]

# Extract the corresponding condition name
condition_name_neg_anm1 <- highest_negative_change_anm1$condition_name


# Calculate the district-wise mean percentage for pre and post test scores
district_wise_combined_anm1 <- df_anm1 |>
  group_by(district_name) |>
  summarise(mean_pre_test = mean(pre_total_correct, na.rm = TRUE) * 100 / max(pre_total_correct, na.rm = TRUE), 
            mean_post_test = mean(post_total_correct, na.rm = TRUE) * 100 / max(post_total_correct, na.rm = TRUE))

# Calculate Overall Average and add it to the data
overall_avg <- df_anm1 |>
  summarise(mean_pre_test = mean(pre_total_correct, na.rm = TRUE) * 100 / max(pre_total_correct, na.rm = TRUE), 
            mean_post_test = mean(post_total_correct, na.rm = TRUE) * 100 / max(post_total_correct, na.rm = TRUE)) |>
  mutate(district_name = "Overall Average")

# Combine the overall average with the district-wise data
district_wise_combined_anm1 <- bind_rows(district_wise_combined_anm1, overall_avg)

# Reorder district_name factor by post-test mean percentage in descending order
district_wise_combined_anm1 <- district_wise_combined_anm1 |>
  arrange(desc(mean_post_test)) |>
  mutate(district_name = factor(district_name, levels = district_name))

# Reshape the data to long format
district_wise_combined_long_anm1 <- district_wise_combined_anm1 |>
  pivot_longer(cols = starts_with("mean_"), names_to = "test_type", values_to = "mean_percentage")

# Reorder 'test_type' factor levels to ensure 'pre' comes before 'post'
district_wise_combined_long_anm1$test_type <- factor(district_wise_combined_long_anm1$test_type, 
                                                levels = c("mean_pre_test", "mean_post_test"),
                                                labels = c("pre", "post"))

# Create a new column for color mapping based on test type and overall average
district_wise_combined_long_anm1 <- district_wise_combined_long_anm1 |>
  mutate(color_group = case_when(
    district_name == "Overall Average" & test_type == "pre" ~ "Overall Average Pre",
    district_name == "Overall Average" & test_type == "post" ~ "Overall Average Post",
    test_type == "pre" ~ "Pre",
    test_type == "post" ~ "Post",
    TRUE ~ "Other"
  ))

# Reorder district names based on "Post" mean percentage in descending order
district_wise_combined_long_anm1 <- district_wise_combined_long_anm1 %>%
  # Create a temporary column to store "Post" mean percentage
  dplyr::mutate(post_percentage = ifelse(color_group == "Post", mean_percentage, NA)) %>%
  # Group by district_name and get the max of post_percentage (for sorting)
  dplyr::group_by(district_name) %>%
  dplyr::mutate(post_percentage_max = max(post_percentage, na.rm = TRUE)) %>%
  # Arrange districts based on the max post_percentage in descending order
  dplyr::arrange(dplyr::desc(post_percentage_max)) %>%
  # Set district_name as a factor in the order of the arranged rows
  dplyr::mutate(district_name = factor(district_name, levels = unique(district_name))) %>%
  # Clean up the temporary columns
  dplyr::select(-post_percentage, -post_percentage_max)

# Set factor levels to ensure 'Pre' comes before 'Post' for each district
district_wise_combined_long_anm1$color_group <- factor(district_wise_combined_long_anm1$color_group, 
                                                      levels = c("Pre", "Post", "Overall Average Pre", "Overall Average Post"))

# Create the ggplot bar chart
districtwise_combined_percentage_plot_anm1 <- ggplot(district_wise_combined_long_anm1, aes(x = district_name, y = mean_percentage, fill = color_group)) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.7), width = 0.7) +
  geom_text(aes(label = round(mean_percentage, 1)), 
            position = position_dodge(width = 0.9), 
            vjust = -0.5,
            size = 3) +  # Reduce the data label size
  labs(x = "District Name",
       y = "Mean Percentage Score",
       fill = "Test Type") +  # Add legend title
  scale_fill_manual(values = c("Pre" = "coral", "Post" = "cyan3", 
                               "Overall Average Pre" = "purple", "Overall Average Post" = "blue")) +  # Set colors for pre, post, and overall averages
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 10, face = "bold"),
    axis.title.x = element_text(size = 12, face = "bold"),
    axis.title.y = element_text(size = 12, face = "bold"),
    legend.title = element_text(size = 10, face = "bold"),
    legend.text = element_text(size = 9)
  )

# Save the plot in the "plots" directory
ggsave("plots/districtwise_combined_percentage_plot_anm1.png", 
       plot = districtwise_combined_percentage_plot_anm1, 
       width = 10, 
       height = 6, 
       dpi = 300)

####Question wise analysis

#QANC
# Assuming df has a 'condition' column and we're filtering for rows where condition is 'qanc'
df_qanc_anm1 <- subset(df_anm1, condition == "qanc")

# Calculate total_n for the filtered data
total_n_anm1 <- nrow(df_qanc_anm1)

# Create the data frame with pre and post percentages for each question
st3_qanc_anm1 <- data.frame(
  question = paste("Q", 1:10),
  qanc_pre = c(
    (sum(df_qanc_anm1$q1_pre) / total_n_anm1) * 100,
    (sum(df_qanc_anm1$q2_pre) / total_n_anm1) * 100,
    (sum(df_qanc_anm1$q3_pre) / total_n_anm1) * 100,
    (sum(df_qanc_anm1$q4_pre) / total_n_anm1) * 100,
    (sum(df_qanc_anm1$q5_pre) / total_n_anm1) * 100,
    (sum(df_qanc_anm1$q6_pre) / total_n_anm1) * 100,
    (sum(df_qanc_anm1$q7_pre) / total_n_anm1) * 100,
    (sum(df_qanc_anm1$q8_pre) / total_n_anm1) * 100,
    (sum(df_qanc_anm1$q9_pre) / total_n_anm1) * 100,
    (sum(df_qanc_anm1$q10_pre) / total_n_anm1) * 100
  ),
  qanc_post = c(
    (sum(df_qanc_anm1$q1_post) / total_n_anm1) * 100,
    (sum(df_qanc_anm1$q2_post) / total_n_anm1) * 100,
    (sum(df_qanc_anm1$q3_post) / total_n_anm1) * 100,
    (sum(df_qanc_anm1$q4_post) / total_n_anm1) * 100,
    (sum(df_qanc_anm1$q5_post) / total_n_anm1) * 100,
    (sum(df_qanc_anm1$q6_post) / total_n_anm1) * 100,
    (sum(df_qanc_anm1$q7_post) / total_n_anm1) * 100,
    (sum(df_qanc_anm1$q8_post) / total_n_anm1) * 100,
    (sum(df_qanc_anm1$q9_post) / total_n_anm1) * 100,
    (sum(df_qanc_anm1$q10_post) / total_n_anm1) * 100
  )
)

# Anaemia
# Assuming df has a 'condition' column and we're filtering for rows where condition is 'ane'
df_ane_anm1 <- subset(df_anm1, condition == "ane")

# Calculate total_n for the filtered data
total_n_anm1 <- nrow(df_ane_anm1)

# Create the data frame with pre and post percentages for each question
st3_ane_anm1 <- data.frame(
  question = paste("Q", 1:10),
  ane_pre = c(
    (sum(df_ane_anm1$q1_pre) / total_n_anm1) * 100,
    (sum(df_ane_anm1$q2_pre) / total_n_anm1) * 100,
    (sum(df_ane_anm1$q3_pre) / total_n_anm1) * 100,
    (sum(df_ane_anm1$q4_pre) / total_n_anm1) * 100,
    (sum(df_ane_anm1$q5_pre) / total_n_anm1) * 100,
    (sum(df_ane_anm1$q6_pre) / total_n_anm1) * 100,
    (sum(df_ane_anm1$q7_pre) / total_n_anm1) * 100,
    (sum(df_ane_anm1$q8_pre) / total_n_anm1) * 100,
    (sum(df_ane_anm1$q9_pre) / total_n_anm1) * 100,
    (sum(df_ane_anm1$q10_pre) / total_n_anm1) * 100
  ),
  ane_post = c(
    (sum(df_ane_anm1$q1_post) / total_n_anm1) * 100,
    (sum(df_ane_anm1$q2_post) / total_n_anm1) * 100,
    (sum(df_ane_anm1$q3_post) / total_n_anm1) * 100,
    (sum(df_ane_anm1$q4_post) / total_n_anm1) * 100,
    (sum(df_ane_anm1$q5_post) / total_n_anm1) * 100,
    (sum(df_ane_anm1$q6_post) / total_n_anm1) * 100,
    (sum(df_ane_anm1$q7_post) / total_n_anm1) * 100,
    (sum(df_ane_anm1$q8_post) / total_n_anm1) * 100,
    (sum(df_ane_anm1$q9_post) / total_n_anm1) * 100,
    (sum(df_ane_anm1$q10_post) / total_n_anm1) * 100
  )
)

# Hypertension
df_htn_anm1 <- subset(df_anm1, condition == "htn")
total_n_anm1 <- nrow(df_htn_anm1)

# Create the data frame with pre and post percentages for each question
st3_htn_anm1 <- data.frame(
  question = paste("Q", 1:10),
  htn_pre = c(
    (sum(df_htn_anm1$q1_pre) / total_n_anm1) * 100,
    (sum(df_htn_anm1$q2_pre) / total_n_anm1) * 100,
    (sum(df_htn_anm1$q3_pre) / total_n_anm1) * 100,
    (sum(df_htn_anm1$q4_pre) / total_n_anm1) * 100,
    (sum(df_htn_anm1$q5_pre) / total_n_anm1) * 100,
    (sum(df_htn_anm1$q6_pre) / total_n_anm1) * 100,
    (sum(df_htn_anm1$q7_pre) / total_n_anm1) * 100,
    (sum(df_htn_anm1$q8_pre) / total_n_anm1) * 100,
    (sum(df_htn_anm1$q9_pre) / total_n_anm1) * 100,
    (sum(df_htn_anm1$q10_pre) / total_n_anm1) * 100
  ),
  htn_post = c(
    (sum(df_htn_anm1$q1_post) / total_n_anm1) * 100,
    (sum(df_htn_anm1$q2_post) / total_n_anm1) * 100,
    (sum(df_htn_anm1$q3_post) / total_n_anm1) * 100,
    (sum(df_htn_anm1$q4_post) / total_n_anm1) * 100,
    (sum(df_htn_anm1$q5_post) / total_n_anm1) * 100,
    (sum(df_htn_anm1$q6_post) / total_n_anm1) * 100,
    (sum(df_htn_anm1$q7_post) / total_n_anm1) * 100,
    (sum(df_htn_anm1$q8_post) / total_n_anm1) * 100,
    (sum(df_htn_anm1$q9_post) / total_n_anm1) * 100,
    (sum(df_htn_anm1$q10_post) / total_n_anm1) * 100
  )
)

# Gestational Diabetes
df_gdm_anm1 <- subset(df_anm1, condition == "gdm")
total_n_anm1 <- nrow(df_gdm_anm1)

# Create the data frame with pre and post percentages for each question
st3_gdm_anm1 <- data.frame(
  question = paste("Q", 1:10),
  gdm_pre = c(
    (sum(df_gdm_anm1$q1_pre) / total_n_anm1) * 100,
    (sum(df_gdm_anm1$q2_pre) / total_n_anm1) * 100,
    (sum(df_gdm_anm1$q3_pre) / total_n_anm1) * 100,
    (sum(df_gdm_anm1$q4_pre) / total_n_anm1) * 100,
    (sum(df_gdm_anm1$q5_pre) / total_n_anm1) * 100,
    (sum(df_gdm_anm1$q6_pre) / total_n_anm1) * 100,
    (sum(df_gdm_anm1$q7_pre) / total_n_anm1) * 100,
    (sum(df_gdm_anm1$q8_pre) / total_n_anm1) * 100,
    (sum(df_gdm_anm1$q9_pre) / total_n_anm1) * 100,
    (sum(df_gdm_anm1$q10_pre) / total_n_anm1) * 100
  ),
  gdm_post = c(
    (sum(df_gdm_anm1$q1_post) / total_n_anm1) * 100,
    (sum(df_gdm_anm1$q2_post) / total_n_anm1) * 100,
    (sum(df_gdm_anm1$q3_post) / total_n_anm1) * 100,
    (sum(df_gdm_anm1$q4_post) / total_n_anm1) * 100,
    (sum(df_gdm_anm1$q5_post) / total_n_anm1) * 100,
    (sum(df_gdm_anm1$q6_post) / total_n_anm1) * 100,
    (sum(df_gdm_anm1$q7_post) / total_n_anm1) * 100,
    (sum(df_gdm_anm1$q8_post) / total_n_anm1) * 100,
    (sum(df_gdm_anm1$q9_post) / total_n_anm1) * 100,
    (sum(df_gdm_anm1$q10_post) / total_n_anm1) * 100
  )
)

# Antepartum Hemorrhage
df_aph_anm1 <- subset(df_anm1, condition == "aph")
total_n_anm1 <- nrow(df_aph_anm1)

# Create the data frame with pre and post percentages for each question
st3_aph_anm1 <- data.frame(
  question = paste("Q", 1:10),
  aph_pre = c(
    (sum(df_aph_anm1$q1_pre) / total_n_anm1) * 100,
    (sum(df_aph_anm1$q2_pre) / total_n_anm1) * 100,
    (sum(df_aph_anm1$q3_pre) / total_n_anm1) * 100,
    (sum(df_aph_anm1$q4_pre) / total_n_anm1) * 100,
    (sum(df_aph_anm1$q5_pre) / total_n_anm1) * 100,
    (sum(df_aph_anm1$q6_pre) / total_n_anm1) * 100,
    (sum(df_aph_anm1$q7_pre) / total_n_anm1) * 100,
    (sum(df_aph_anm1$q8_pre) / total_n_anm1) * 100,
    (sum(df_aph_anm1$q9_pre) / total_n_anm1) * 100,
    (sum(df_aph_anm1$q10_pre) / total_n_anm1) * 100
  ),
  aph_post = c(
    (sum(df_aph_anm1$q1_post) / total_n_anm1) * 100,
    (sum(df_aph_anm1$q2_post) / total_n_anm1) * 100,
    (sum(df_aph_anm1$q3_post) / total_n_anm1) * 100,
    (sum(df_aph_anm1$q4_post) / total_n_anm1) * 100,
    (sum(df_aph_anm1$q5_post) / total_n_anm1) * 100,
    (sum(df_aph_anm1$q6_post) / total_n_anm1) * 100,
    (sum(df_aph_anm1$q7_post) / total_n_anm1) * 100,
    (sum(df_aph_anm1$q8_post) / total_n_anm1) * 100,
    (sum(df_aph_anm1$q9_post) / total_n_anm1) * 100,
    (sum(df_aph_anm1$q10_post) / total_n_anm1) * 100
  )
)

df_questions_combined_anm1 <- cbind(
  st3_qanc_anm1["question"],   # Include question column
  st3_qanc_anm1[, c("qanc_pre", "qanc_post")],
  st3_ane_anm1[, c("ane_pre", "ane_post")],
  st3_htn_anm1[, c("htn_pre", "htn_post")],
  st3_gdm_anm1[, c("gdm_pre", "gdm_post")],
  st3_aph_anm1[, c("aph_pre", "aph_post")]
)


# Round all percentage columns to 2 decimal places
df_questions_combined_anm1[, 2:ncol(df_questions_combined_anm1)] <- round(df_questions_combined_anm1[, 2:ncol(df_questions_combined_anm1)], 1)

df_questions_combined_anm1_gt <- df_questions_combined_anm1 %>%
  gt() %>%
  cols_label(
    question = "Question",
    qanc_pre = "QANC Pre",
    qanc_post = "QANC Post",
    ane_pre = "ANE Pre",
    ane_post = "ANE Post",
    gdm_pre = "GDM Pre",
    gdm_post = "GDM Post",
    htn_pre = "HTN Pre",
    htn_post = "HTN Post",
    aph_pre = "APH Pre",
    aph_post = "APH Post"
  ) %>%
  tab_spanner(
    label = "Pre-Post Score Percentage",
    columns = c("qanc_pre", "qanc_post", "ane_pre", "ane_post", "gdm_pre", "gdm_post", "htn_pre", "htn_post", "aph_pre", "aph_post") )

# Apply `tab_style()` only to individual columns where values are < 50
for (col in c("qanc_pre", "qanc_post", "ane_pre", "ane_post", "gdm_pre", "gdm_post", "htn_pre", "htn_post", "aph_pre", "aph_post")) {
  df_questions_combined_anm1_gt <- df_questions_combined_anm1_gt %>%
    tab_style(
      style = list(
        cell_fill(color = "yellow"),  # Highlight only the specific cells
        cell_text(weight = "bold")  # Make text bold
      ),
      locations = cells_body(
        columns = col, 
        rows = df_questions_combined_anm1[[col]] < 50  # Apply condition per column
      )
    )
}

# Save the data frame to a CSV file
write.csv(df_questions_combined_anm1, "tables/df_questions_combined_anm1_gt_1.csv", row.names = FALSE)
```

```{r}
#| echo: false
#| warning: false
#| message: false

# Define the file paths
filepaths <- c(
  here::here('data','ts_cleaned_data','anm_cleaned_tb_ts.csv'),
  here::here('data','ts_cleaned_data','anm_cleaned_sob_ts.csv'),
  here::here('data','ts_cleaned_data','anm_cleaned_lscs_ts.csv'),
  here::here('data','ts_cleaned_data','anm_cleaned_jau_ts.csv'),
  here::here('data','ts_cleaned_data','anm_cleaned_hrt_ts.csv'),
  here::here('data','ts_cleaned_data','anm_cleaned_epi_ts.csv')
)

# Import all files as data frames
data_frames_anm2 <- lapply(filepaths, read.csv)

# Bind all data frames into a single data frame
df_anm2 <- do.call(rbind, data_frames_anm2)

# Clean the data
df_anm2 <- df_anm2 |>
  janitor::clean_names()

# Remove unwanted columns
df_anm2 <- df_anm2 |>
  select(-c("number",
            "name_post", 
            "age_post", 
            "entry_post", 
            "districts_post", 
            "phc_name_post", 
            "experience_post", 
            "mobile_no_post",
            "date_post"))

# Ensure age_pre is a character type, then numeric
df_anm2$age_pre <- as.character(df_anm2$age_pre)

# Convert to numeric
df_anm2$age_pre <- as.numeric(df_anm2$age_pre)

# Current year
current_year <- as.numeric(format(Sys.Date(), "%Y"))

# Identify year values in `age_pre` and convert them to age
df_anm2$age_pre <- ifelse(df_anm2$age_pre >= 1900 & df_anm2$age_pre <= current_year,  # Year format
                          current_year - df_anm2$age_pre,  # Convert year to age
                          df_anm2$age_pre)  # Keep other values unchanged

# Change the district names and mutate a column with the concerned district names
df_anm2 <- df_anm2 %>%
  mutate(district_name = case_when(
    districts_pre == 1 ~ "Adilabad",
    districts_pre == 2 ~ "Bhadradri Kothagudem",
    districts_pre == 3 ~ "Hyderabad",
    districts_pre == 4 ~ "Jagtial",
    districts_pre == 5 ~ "Jangaon",
    districts_pre == 6 ~ "Jayashankar Bhupalpally",
    districts_pre == 7 ~ "Jogulamba Gadwal",
    districts_pre == 8 ~ "Kamareddy",
    districts_pre == 9 ~ "Karimnagar",
    districts_pre == 10 ~ "Khammam",
    districts_pre == 11 ~ "Komaram Bheem Asifabad",
    districts_pre == 12 ~ "Mahabubabad",
    districts_pre == 13 ~ "Mahabubnagar",
    districts_pre == 14 ~ "Mancherial",
    districts_pre == 15 ~ "Medak",
    districts_pre == 16 ~ "Medchal Malkajgiri",
    districts_pre == 17 ~ "Mulugu",
    districts_pre == 18 ~ "Nagarkurnool",
    districts_pre == 19 ~ "Nalgonda",
    districts_pre == 20 ~ "Narayanpet",
    districts_pre == 21 ~ "Nirmal",
    districts_pre == 22 ~ "Nizamabad",
    districts_pre == 23 ~ "Peddapalli",
    districts_pre == 24 ~ "Rajanna Sircilla",
    districts_pre == 25 ~ "Rangareddy",
    districts_pre == 26 ~ "Sangareddy",
    districts_pre == 27 ~ "Siddipet",
    districts_pre == 28 ~ "Suryapet",
    districts_pre == 29 ~ "Vikarabad",
    districts_pre == 30 ~ "Wanaparthy",
    districts_pre == 31 ~ "Warangal Rural",
    districts_pre == 32 ~ "Warangal Urban",
    districts_pre == 33 ~ "Yadadri Bhuvanagiri",
    TRUE ~ NA_character_
  ))

# Prev LSCS Correct answers 
# Pre 
df_anm2 <- df_anm2 %>%
  mutate(
    q1_pre = ifelse(condition == "lscs", ifelse(q1_pre == 4, 1, 0), q1_pre),
    q2_pre = ifelse(condition == "lscs", ifelse(q2_pre == 3, 1, 0), q2_pre),
    q3_pre = ifelse(condition == "lscs", ifelse(q3_pre == 4, 1, 0), q3_pre),
    q4_pre = ifelse(condition == "lscs", ifelse(q4_pre == 4, 1, 0), q4_pre),
    q5_pre = ifelse(condition == "lscs", ifelse(q5_pre == 3, 1, 0), q5_pre),
    q6_pre = ifelse(condition == "lscs", ifelse(q6_pre == 4, 1, 0), q6_pre),
    q7_pre = ifelse(condition == "lscs", ifelse(q7_pre == 3, 1, 0), q7_pre),
    q8_pre = ifelse(condition == "lscs", ifelse(q8_pre == 3, 1, 0), q8_pre),
    q9_pre = ifelse(condition == "lscs", ifelse(q9_pre == 4, 1, 0), q9_pre),
    q10_pre = ifelse(condition == "lscs", ifelse(q10_pre == 3, 1, 0), q10_pre)
  )

# Post
df_anm2 <- df_anm2 %>%
  mutate(
    q1_post = ifelse(condition == "lscs", ifelse(q1_post == 4, 1, 0), q1_post),
    q2_post = ifelse(condition == "lscs", ifelse(q2_post == 3, 1, 0), q2_post),
    q3_post = ifelse(condition == "lscs", ifelse(q3_post == 4, 1, 0), q3_post),
    q4_post = ifelse(condition == "lscs", ifelse(q4_post == 4, 1, 0), q4_post),
    q5_post = ifelse(condition == "lscs", ifelse(q5_post == 3, 1, 0), q5_post),
    q6_post = ifelse(condition == "lscs", ifelse(q6_post == 4, 1, 0), q6_post),
    q7_post = ifelse(condition == "lscs", ifelse(q7_post == 3, 1, 0), q7_post),
    q8_post = ifelse(condition == "lscs", ifelse(q8_post == 3, 1, 0), q8_post),
    q9_post = ifelse(condition == "lscs", ifelse(q9_post == 4, 1, 0), q9_post),
    q10_post = ifelse(condition == "lscs", ifelse(q10_post == 3, 1, 0), q10_post)
  )

# Jaundice correct answers
# Pre
df_anm2 <- df_anm2 %>%
  mutate(
    q1_pre = ifelse(condition == "jau", ifelse(q1_pre == 1, 1, 0), q1_pre),
    q2_pre = ifelse(condition == "jau", ifelse(q2_pre == 3, 1, 0), q2_pre),
    q3_pre = ifelse(condition == "jau", ifelse(q3_pre == 1, 1, 0), q3_pre),
    q4_pre = ifelse(condition == "jau", ifelse(q4_pre == 4, 1, 0), q4_pre),
    q5_pre = ifelse(condition == "jau", ifelse(q5_pre == 1, 1, 0), q5_pre),
    q6_pre = ifelse(condition == "jau", ifelse(q6_pre == 1, 1, 0), q6_pre),
    q7_pre = ifelse(condition == "jau", ifelse(q7_pre == 4, 1, 0), q7_pre),
    q8_pre = ifelse(condition == "jau", ifelse(q8_pre == 2, 1, 0), q8_pre),
    q9_pre = ifelse(condition == "jau", ifelse(q9_pre == 3, 1, 0), q9_pre),
    q10_pre = ifelse(condition == "jau", ifelse(q10_pre == 0, 0, 1), q10_pre)
  )

# Post
df_anm2 <- df_anm2 %>%
  mutate(
    q1_post = ifelse(condition == "jau", ifelse(q1_post == 1, 1, 0), q1_post),
    q2_post = ifelse(condition == "jau", ifelse(q2_post == 3, 1, 0), q2_post),
    q3_post = ifelse(condition == "jau", ifelse(q3_post == 1, 1, 0), q3_post),
    q4_post = ifelse(condition == "jau", ifelse(q4_post == 4, 1, 0), q4_post),
    q5_post = ifelse(condition == "jau", ifelse(q5_post == 1, 1, 0), q5_post),
    q6_post = ifelse(condition == "jau", ifelse(q6_post == 1, 1, 0), q6_post),
    q7_post = ifelse(condition == "jau", ifelse(q7_post == 4, 1, 0), q7_post),
    q8_post = ifelse(condition == "jau", ifelse(q8_post == 2, 1, 0), q8_post),
    q9_post = ifelse(condition == "jau", ifelse(q9_post == 3, 1, 0), q9_post),
    q10_post = ifelse(condition == "jau", ifelse(q10_post == 0, 0, 1), q10_post)
  )

# SOB Correct answers
# Pre
df_anm2 <- df_anm2 %>%
  mutate(
    q1_pre = ifelse(condition == "sob", ifelse(q1_pre == 2, 1, 0), q1_pre),
    q2_pre = ifelse(condition == "sob", ifelse(q2_pre == 4, 1, 0), q2_pre),
    q3_pre = ifelse(condition == "sob", ifelse(q3_pre == 3, 1, 0), q3_pre),
    q4_pre = ifelse(condition == "sob", ifelse(q4_pre == 4, 1, 0), q4_pre),
    q5_pre = ifelse(condition == "sob", ifelse(q5_pre == 4, 1, 0), q5_pre),
    q6_pre = ifelse(condition == "sob", ifelse(q6_pre == 2, 1, 0), q6_pre),
    q7_pre = ifelse(condition == "sob", ifelse(q7_pre == 4, 1, 0), q7_pre),
    q8_pre = ifelse(condition == "sob", ifelse(q8_pre == 1, 1, 0), q8_pre),
    q9_pre = ifelse(condition == "sob", ifelse(q9_pre == 4, 1, 0), q9_pre),
    q10_pre = ifelse(condition == "sob", ifelse(q10_pre == 4, 1, 0), q10_pre)
  )

# Post
df_anm2 <- df_anm2 %>%
  mutate(
    q1_post = ifelse(condition == "sob", ifelse(q1_post == 2, 1, 0), q1_post),
    q2_post = ifelse(condition == "sob", ifelse(q2_post == 4, 1, 0), q2_post),
    q3_post = ifelse(condition == "sob", ifelse(q3_post == 3, 1, 0), q3_post),
    q4_post = ifelse(condition == "sob", ifelse(q4_post == 4, 1, 0), q4_post),
    q5_post = ifelse(condition == "sob", ifelse(q5_post == 4, 1, 0), q5_post),
    q6_post = ifelse(condition == "sob", ifelse(q6_post == 2, 1, 0), q6_post),
    q7_post = ifelse(condition == "sob", ifelse(q7_post == 4, 1, 0), q7_post),
    q8_post = ifelse(condition == "sob", ifelse(q8_post ==1 , 1, 0), q8_post),
    q9_post = ifelse(condition == "sob", ifelse(q9_post == 4, 1, 0), q9_post),
    q10_post = ifelse(condition == "sob", ifelse(q10_post == 4, 1, 0), q10_post)
  )

# Heart Disease
# Pre
df_anm2 <- df_anm2 %>%
  mutate(
    q1_pre = ifelse(condition == "hrt", ifelse(q1_pre == 5, 1, 0), q1_pre),
    q2_pre = ifelse(condition == "hrt", ifelse(q2_pre == 3, 1, 0), q2_pre),
    q3_pre = ifelse(condition == "hrt", ifelse(q3_pre == 3, 1, 0), q3_pre),
    q4_pre = ifelse(condition == "hrt", ifelse(q4_pre == 4, 1, 0), q4_pre),
    q5_pre = ifelse(condition == "hrt", ifelse(q5_pre == 1, 1, 0), q5_pre),
    q6_pre = ifelse(condition == "hrt", ifelse(q6_pre == 5, 1, 0), q6_pre),
    q7_pre = ifelse(condition == "hrt", ifelse(q7_pre == 3, 1, 0), q7_pre),
    q8_pre = ifelse(condition == "hrt", ifelse(q8_pre == 5, 1, 0), q8_pre),
    q9_pre = ifelse(condition == "hrt", ifelse(q9_pre == 5, 1, 0), q9_pre),
    q10_pre = ifelse(condition == "hrt", ifelse(q10_pre == 0, 0, 1), q10_pre)
  )

# Post
df_anm2 <- df_anm2 %>%
  mutate(
    q1_post = ifelse(condition == "hrt", ifelse(q1_post == 5, 1, 0), q1_post),
    q2_post = ifelse(condition == "hrt", ifelse(q2_post == 3, 1, 0), q2_post),
    q3_post = ifelse(condition == "hrt", ifelse(q3_post == 3, 1, 0), q3_post),
    q4_post = ifelse(condition == "hrt", ifelse(q4_post == 4, 1, 0), q4_post),
    q5_post = ifelse(condition == "hrt", ifelse(q5_post == 1, 1, 0), q5_post),
    q6_post = ifelse(condition == "hrt", ifelse(q6_post == 5, 1, 0), q6_post),
    q7_post = ifelse(condition == "hrt", ifelse(q7_post == 3, 1, 0), q7_post),
    q8_post = ifelse(condition == "hrt", ifelse(q8_post == 5, 1, 0), q8_post),
    q9_post = ifelse(condition == "hrt", ifelse(q9_post == 5, 1, 0), q9_post),
    q10_post = ifelse(condition == "hrt", ifelse(q10_post == 0, 0, 1), q10_post)
  )

# TB Correct answers
# Pre
df_anm2 <- df_anm2 %>%
  mutate(
    q1_pre = ifelse(condition == "tb", ifelse(q1_pre == 4, 1, 0), q1_pre),
    q2_pre = ifelse(condition == "tb", ifelse(q2_pre == 4, 1, 0), q2_pre),
    q3_pre = ifelse(condition == "tb", ifelse(q3_pre == 3, 1, 0), q3_pre),
    q4_pre = ifelse(condition == "tb", ifelse(q4_pre == 4, 1, 0), q4_pre),
    q5_pre = ifelse(condition == "tb", ifelse(q5_pre == 4, 1, 0), q5_pre),
    q6_pre = ifelse(condition == "tb", ifelse(q6_pre == 2, 1, 0), q6_pre),
    q7_pre = ifelse(condition == "tb", ifelse(q7_pre == 4, 1, 0), q7_pre),
    q8_pre = ifelse(condition == "tb", ifelse(q8_pre == 3, 1, 0), q8_pre),
    q9_pre = ifelse(condition == "tb", ifelse(q9_pre == 4, 1, 0), q9_pre),
    q10_pre = ifelse(condition == "tb", ifelse(q10_pre == 0, 0, 1), q10_pre)
  )

# Post
df_anm2 <- df_anm2 %>%
  mutate(
    q1_post = ifelse(condition == "tb", ifelse(q1_post == 4, 1, 0), q1_post),
    q2_post = ifelse(condition == "tb", ifelse(q2_post == 4, 1, 0), q2_post),
    q3_post = ifelse(condition == "tb", ifelse(q3_post == 3, 1, 0), q3_post),
    q4_post = ifelse(condition == "tb", ifelse(q4_post == 4, 1, 0), q4_post),
    q5_post = ifelse(condition == "tb", ifelse(q5_post == 4, 1, 0), q5_post),
    q6_post = ifelse(condition == "tb", ifelse(q6_post == 2, 1, 0), q6_post),
    q7_post = ifelse(condition == "tb", ifelse(q7_post == 4, 1, 0), q7_post),
    q8_post = ifelse(condition == "tb", ifelse(q8_post == 3, 1, 0), q8_post),
    q9_post = ifelse(condition == "tb", ifelse(q9_post == 4, 1, 0), q9_post),
    q10_post = ifelse(condition == "tb", ifelse(q10_post == 0, 0, 1), q10_post)
  )

# Epi Correct answers
# Pre
df_anm2 <- df_anm2 %>%
  mutate(
    q1_pre = ifelse(condition == "epi", ifelse(q1_pre == 3, 1, 0), q1_pre),
    q2_pre = ifelse(condition == "epi", ifelse(q2_pre == 5, 1, 0), q2_pre),
    q3_pre = ifelse(condition == "epi", ifelse(q3_pre == 4, 1, 0), q3_pre),
    q4_pre = ifelse(condition == "epi", ifelse(q4_pre == 5, 1, 0), q4_pre),
    q5_pre = ifelse(condition == "epi", ifelse(q5_pre == 2, 1, 0), q5_pre),
    q6_pre = ifelse(condition == "epi", ifelse(q6_pre == 2, 1, 0), q6_pre),
    q7_pre = ifelse(condition == "epi", ifelse(q7_pre == 5, 1, 0), q7_pre),
    q8_pre = ifelse(condition == "epi", ifelse(q8_pre == 3, 1, 0), q8_pre),
    q9_pre = ifelse(condition == "epi", ifelse(q9_pre == 2, 1, 0), q9_pre),
    q10_pre = ifelse(condition == "epi", ifelse(q10_pre == 0, 0, 1), q10_pre)
  )

# Post
df_anm2 <- df_anm2 %>%
  mutate(
    q1_post = ifelse(condition == "epi", ifelse(q1_post == 3, 1, 0), q1_post),
    q2_post = ifelse(condition == "epi", ifelse(q2_post == 5, 1, 0), q2_post),
    q3_post = ifelse(condition == "epi", ifelse(q3_post == 4, 1, 0), q3_post),
    q4_post = ifelse(condition == "epi", ifelse(q4_post == 5, 1, 0), q4_post),
    q5_post = ifelse(condition == "epi", ifelse(q5_post == 2, 1, 0), q5_post),
    q6_post = ifelse(condition == "epi", ifelse(q6_post == 2, 1, 0), q6_post),
    q7_post = ifelse(condition == "epi", ifelse(q7_post == 5, 1, 0), q7_post),
    q8_post = ifelse(condition == "epi", ifelse(q8_post == 3, 1, 0), q8_post),
    q9_post = ifelse(condition == "epi", ifelse(q9_post == 2, 1, 0), q9_post),
    q10_post = ifelse(condition == "epi", ifelse(q10_post == 0, 0, 1), q10_post)
  )

# Sum of Pre and post total correct scores
df_anm2 <- df_anm2 %>%
  mutate(
    pre_total_correct = rowSums(select(., starts_with("q") & ends_with("pre"))),
    post_total_correct = rowSums(select(., starts_with("q") & ends_with("post")))
  )

df_anm2 <- df_anm2 |> 
  mutate(relative_change = post_total_correct - pre_total_correct)

# Adding relative change column and creating code for the same
df_anm2 <- df_anm2 %>%
  mutate(rc_code = case_when(
    relative_change == 0 ~ "No Change",
    relative_change %in% c(-1, -2) ~ "-1 to -2",
    relative_change %in% c(1, 2) ~ "1 to 2",
    relative_change >= 3 ~ "+3 and above",
    relative_change <= -3 ~ "-3 and below",
    TRUE ~ NA_character_  # Ensure that the NA type is character to match the other outcomes
  ))

df_anm2 <- df_anm2 %>%
  mutate(rc_positive_negative_code = case_when(
    relative_change == 0 ~ "No Change",
    relative_change %in% c(-1, -2) ~ "Negative change",
    relative_change %in% c(1, 2) ~ "Positive change",
    relative_change >= 3 ~ "Positive change",
    relative_change <= -3 ~ "Negative change",
    TRUE ~ NA_character_  # Ensure that the NA type is character to match the other outcomes
  ))

# Create summary statistics grouped by district_name and condition
sta1_anm2 <- df_anm2 %>%
  group_by(district_name, condition) %>%
  summarise(
    pre_mean = round(mean(pre_total_correct, na.rm = TRUE), 1),
    pre_std = round(sd(pre_total_correct, na.rm = TRUE), 1),
    pre_mean_pct = round((mean(pre_total_correct, na.rm = TRUE) / 10) * 100, 1),  # Pre-test percentage
    post_mean = round(mean(post_total_correct, na.rm = TRUE), 1),
    post_std = round(sd(post_total_correct, na.rm = TRUE), 1),
    post_mean_pct = round((mean(post_total_correct, na.rm = TRUE) / 10) * 100, 1),  # Post-test percentage
    p_value = ifelse(
      sum(!is.na(pre_total_correct)) > 1 & sum(!is.na(post_total_correct)) > 1, 
      round(t.test(pre_total_correct, post_total_correct)$p.value, 6), 
      NA
    )
  )

# Calculate state average (overall mean, std, and percentage grouped by condition)
state_avg_anm2 <- df_anm2 %>%
  group_by(condition) %>%
  summarise(
    pre_mean = round(mean(pre_total_correct, na.rm = TRUE), 1),
    pre_std = round(sd(pre_total_correct, na.rm = TRUE), 1),
    pre_mean_pct = round((mean(pre_total_correct, na.rm = TRUE) / 10) * 100, 1),  # Pre-test percentage
    post_mean = round(mean(post_total_correct, na.rm = TRUE), 1),
    post_std = round(sd(post_total_correct, na.rm = TRUE), 1),
    post_mean_pct = round((mean(post_total_correct, na.rm = TRUE) / 10) * 100, 1)  # Post-test percentage
  ) %>%
  mutate(district_name = "Overall Average")  # Add state average label

# Combine district-level and state-level data
sta1_anm2 <- bind_rows(sta1_anm2, state_avg_anm2)

# Save sta1 as a CSV file
write.csv(sta1_anm2, "tables/sta1_summary_anm2_ts_2.csv", row.names = FALSE)

# Overall mean, std and percentage grouped by condition
sta2_anm2 <- df_anm2 %>%
  group_by(condition) %>%
  summarise(
    n = n(),  # Count of rows for each condition
    pre_mean = round(mean(pre_total_correct, na.rm = TRUE), 1),
    pre_std = round(sd(pre_total_correct, na.rm = TRUE), 1),
    pre_mean_pct = round((mean(pre_total_correct, na.rm = TRUE) / 10) * 100, 1),  # Pre-test percentage
    post_mean = round(mean(post_total_correct, na.rm = TRUE), 1),
    post_std = round(sd(post_total_correct, na.rm = TRUE), 1),
    post_mean_pct = round((mean(post_total_correct, na.rm = TRUE) / 10) * 100, 1)  # Post-test percentage
  )

# Calculate state average (same as above)
state_avg_anm2 <- df_anm2 %>%
  summarise(
    pre_mean = round(mean(pre_total_correct, na.rm = TRUE), 1),
    pre_std = round(sd(pre_total_correct, na.rm = TRUE), 1),
    pre_mean_pct = round((mean(pre_total_correct, na.rm = TRUE) / 10) * 100, 1),  # Pre-test percentage
    post_mean = round(mean(post_total_correct, na.rm = TRUE), 1),
    post_std = round(sd(post_total_correct, na.rm = TRUE), 1),
    post_mean_pct = round((mean(post_total_correct, na.rm = TRUE) / 10) * 100, 1)  # Post-test percentage
  ) %>%
  mutate(condition = "Overall Average")  # Add state average label

# Combine condition-level and state-level data
sta2_anm2 <- bind_rows(sta2_anm2, state_avg_anm2)

# Save sta2 as a CSV file
write.csv(sta2_anm2, "tables/sta2_summary_anm2_ts_2.csv", row.names = FALSE)

# Reorder condition factor based on post-test mean percentage in descending order
sta2_anm2 <- sta2_anm2 %>%
  arrange(desc(post_mean_pct)) %>%
  mutate(condition = factor(condition, levels = condition))

# Reshape the data from wide to long format using tidyr's pivot_longer
sta2_long_anm2 <- tidyr::pivot_longer(sta2_anm2, 
                                      cols = c("pre_mean_pct", "post_mean_pct"), 
                                      names_to = "Time", 
                                      values_to = "Mean_Pct")

# Calculate the gain in knowledge for each condition
knowledge_gain_anm2 <- sta2_anm2 %>%
  mutate(Gain = post_mean_pct - pre_mean_pct) %>%
  select(condition, Gain)

# Reorder 'Time' factor levels to ensure 'pre' comes before 'post'
sta2_long_anm2$Time <- factor(sta2_long_anm2$Time, levels = c("pre_mean_pct", "post_mean_pct"))

# Combine data for all conditions
relative_change_combined_anm2 <- df_anm2 %>%
  count(condition, rc_positive_negative_code) %>%  # Count occurrences for each condition and change type
  group_by(condition) %>%  # Group by condition
  mutate(percentage = n / sum(n) * 100)  # Calculate percentage

# Reorder 'condition' based on descending percentage of "Positive change"
positive_order_anm2 <- relative_change_combined_anm2 %>%
  filter(rc_positive_negative_code == "Positive change") %>%
  arrange(percentage) %>%  # Sort in ascending order
  pull(condition)  # Extract the ordered conditions

relative_change_combined_anm2 <- relative_change_combined_anm2 %>%
  mutate(condition = factor(condition, levels = positive_order_anm2))  # Reorder factor levels

# Replace condition abbreviations with full names
sta2_anm2 <- sta2_anm2 %>%
  mutate(condition_name = case_when(
    condition == "tb" ~ "Tuberculosis",
    condition == "sob" ~ "Shortness of Breath",
    condition == "lscs" ~ "Lower Segment Caesarean Section",
    condition == "jau" ~ "Jaundice",
    condition == "hrt" ~ "Heart Disease",
    condition == "epi" ~ "Epilepsy",
    TRUE ~ condition  # Keep other values unchanged (if any)
  ))

# Map - Trainings happening in districts

library(sf)

# Load the GeoJSON file
telangana_sf_anm2 <- st_read(here::here("data", "ts_cleaned_data", "telangana.json"), quiet = TRUE)

# Create district responses from your dataset (df_anm2)
# Pull number of responses
district_responses_anm2 <- df_anm2 %>%
  group_by(district_name) %>%
  summarise(no_of_responses = n())

# Mutate the District column in telangana_sf to match district_responses
telangana_sf_anm2 <- telangana_sf_anm2 %>%
  mutate(district_name = case_when(
    District == "ADILABAD" ~ "Adilabad",
    District == "BHADRADRI KOTHAGUDEM" ~ "Bhadradri Kothagudem",
    District == "HYDERABAD" ~ "Hyderabad",
    District == "JAGTIAL" ~ "Jagtial",
    District == "JANGAON" ~ "Jangaon",
    District == "JAYASHANKAR BHUPALAPALLY" ~ "Jayashankar Bhupalpally",
    District == "JOGULAMBA GADWAL" ~ "Jogulamba Gadwal",
    District == "KAMAREDDY" ~ "Kamareddy",
    District == "KARIMNAGAR" ~ "Karimnagar",
    District == "KHAMMAM" ~ "Khammam",
    District == "KUMURAM BHEEM" ~ "Komaram Bheem Asifabad",
    District == "MAHABUBABAD" ~ "Mahabubabad",
    District == "MAHABUBNAGAR" ~ "Mahabubnagar",
    District == "MANCHERIAL" ~ "Mancherial",
    District == "MEDAK" ~ "Medak",
    District == "MEDCHAL-MALKAJGIRI" ~ "Medchal Malkajgiri",
    District == "MULUGU" ~ "Mulugu",
    District == "NAGARKURNOOL" ~ "Nagarkurnool",
    District == "NALGONDA" ~ "Nalgonda",
    District == "NARAYANPET" ~ "Narayanpet",
    District == "NIRMAL" ~ "Nirmal",
    District == "NIZAMABAD" ~ "Nizamabad",
    District == "PEDDAPALLI" ~ "Peddapalli",
    District == "RANJANNA SIRCILLA" ~ "Rajanna Sircilla",
    District == "RANGAREDDY" ~ "Rangareddy",
    District == "SANGAREDDY" ~ "Sangareddy",
    District == "SIDDIPET" ~ "Siddipet",
    District == "SURYAPET" ~ "Suryapet",
    District == "VIKARABAD" ~ "Vikarabad",
    District == "WANAPARTHY" ~ "Wanaparthy",
    District == "WARANGAL (RURAL)" ~ "Warangal Rural",
    District == "WARANGAL (URBAN)" ~ "Warangal Urban",
    District == "YADADRI BHUVANAGIRI" ~ "Yadadri Bhuvanagiri",
    TRUE ~ District  # Keep original value if no match
  ))

# Join the standardized district_responses with telangana_sf
merged_tg_sf_anm2 <- telangana_sf_anm2 %>%
  left_join(district_responses_anm2, by = "district_name")

# Identify districts with responses
merged_tg_sf_anm2 <- merged_tg_sf_anm2 %>%
  mutate(map = ifelse(!is.na(no_of_responses), 1, 0))

# Plot the map
telangana_map_plot_anm2 <- ggplot(merged_tg_sf_anm2) +
  geom_sf(aes(fill = factor(map)), color = "black") +
  scale_fill_manual(values = c("0" = "grey90", "1" = "lightgreen")) +
  geom_sf_text(data = merged_tg_sf_anm2 %>% filter(map == 1), aes(label = District), size = 3) + 
  theme_void() +
  theme(legend.position = "none")

# Plot the map
telangana_map_plot_anm2 <- ggplot(merged_tg_sf_anm2) +
  geom_sf(aes(fill = factor(map)), color = "black") +
  scale_fill_manual(values = c("0" = "grey90", "1" = "lightgreen")) +
  geom_sf_text(data = merged_tg_sf_anm2 %>% filter(map == 1), aes(label = District), size = 3) + 
  theme_void() +
  theme(legend.position = "none")

# Save the plot in the "images" folder using ggsave
ggsave("plots/telangana_map_plot_anm2_2.png", plot = telangana_map_plot_anm2, width = 8, height = 6, dpi = 300)


# Create a new column to differentiate the state average from other conditions
sta2_long_anm2 <- sta2_long_anm2 %>%
  mutate(state_avg = ifelse(condition == "Overall Average", "Overall Average", "Conditions"))

# Create the ggplot bar chart with adjustments for spacing and legibility
pre_post_mean_pct_anm2 <- ggplot(sta2_long_anm2, aes(x = condition, y = Mean_Pct, fill = interaction(Time, state_avg))) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.8), width = 0.7) +  # Increase spacing
  scale_fill_manual(values = c("pre_mean_pct.Conditions" = "blue", 
                               "post_mean_pct.Conditions" = "orange",
                               "pre_mean_pct.Overall Average" = "lightskyblue", 
                               "post_mean_pct.Overall Average" = "lightgreen")) +
  geom_text(aes(label = round(Mean_Pct, 1)), 
            position = position_dodge(width = 0.8),  # Adjust text position to align with the new dodge width
            vjust = -0.5) +  # Adjust label position
  labs(x = "Condition", y = "Mean %") +
  theme_minimal() +
  theme(
    legend.title = element_blank(),
    axis.text.x = element_text(size = 12, face = "bold", angle = 45, hjust = 1),  # Rotate axis labels for better legibility
    axis.title.x = element_text(size = 14, face = "bold"),
    plot.margin = margin(10, 20, 10, 20),  # Add space around the plot
    panel.grid.major.x = element_blank(),  # Optional: remove vertical grid lines for clarity
    panel.grid.minor.x = element_blank()
  ) +
  # Add gain in knowledge as annotations below the x-axis labels
  annotate("text", 
           x = knowledge_gain_anm2$condition, 
           y = -5,  # Position slightly below the x-axis
           label = paste0(round(knowledge_gain_anm2$Gain, 1), "%"),
           size = 3.5, 
           color = "red")

# Save the plot in the "plots" directory
ggsave("plots/pre_post_mean_pct_anm2_2.png", 
       plot = pre_post_mean_pct_anm2, 
       width = 10, 
       height = 6, 
       dpi = 300)

# Create the plot object
plot_relative_change_anm2 <- ggplot(relative_change_combined_anm2, aes(x = percentage, y = condition, fill = rc_positive_negative_code)) +
  geom_bar(stat = "identity", position = "dodge", width = 0.7) +
  geom_text(aes(label = sprintf("%.1f%%", percentage)), 
            position = position_dodge(width = 0.9), 
            hjust = -0.2, 
            size = 3) +
  labs(x = "Percentage (%)", y = "Condition") +
  scale_fill_manual(values = c("Positive change" = "darkgreen", 
                               "Negative change" = "red", 
                               "No Change" = "orange")) +
  scale_x_continuous(expand = expansion(mult = c(0, 0.1))) +
  theme_minimal(base_size = 12) +
  theme(
    axis.text.y = element_text(size = 10),
    axis.text.x = element_text(size = 10),
    axis.title.x = element_text(size = 12, face = "bold"),
    axis.title.y = element_text(size = 12, face = "bold"),
    plot.title = element_text(size = 14, face = "bold", hjust = 0.5),
    legend.title = element_blank(),
    legend.text = element_text(size = 10)
  )
# Save the plot in the "plots" directory
ggsave("plots/plot_relative_change_anm_2.png", 
       plot = plot_relative_change_anm2, 
       width = 10, 
       height = 6, 
       dpi = 300)


# Add condition names
relative_change_combined_anm2 <- relative_change_combined_anm2 %>%
  mutate(condition_name = case_when(
    condition == "qanc" ~ "Quality ANC",
    condition == "ane" ~ "Anaemia",
    condition == "gdm" ~ "Gestational Diabetes",
    condition == "aph" ~ "Antepartum Hemorrhage",
    condition == "htn" ~ "Hypertension",
    condition == "tb" ~ "Tuberculosis",
    condition == "sob" ~ "Shortness of Breath",
    condition == "lscs" ~ "Lower Segment Caesarean Section",
    condition == "jau" ~ "Jaundice",
    condition == "hrt" ~ "Heart Disease",
    condition == "epi" ~ "Epilepsy",
    TRUE ~ condition
  ))

# Filter for 'Positive change'
positive_changes_anm2 <- relative_change_combined_anm2 %>% 
  filter(rc_positive_negative_code == "Positive change")

# Find the index of the maximum percentage
max_index_anm2 <- which.max(positive_changes_anm2$percentage)

# Extract the row with the highest percentage
highest_positive_change_anm2 <- positive_changes_anm2[max_index_anm2, ]

# Extract the corresponding condition name
condition_name1_anm2 <- highest_positive_change_anm2$condition_name

# Filter for 'Negative change'
negative_changes_anm2 <- relative_change_combined_anm2 %>% 
  filter(rc_positive_negative_code == "Negative change")

# Find the index of the maximum percentage
max_index_anm2 <- which.max(negative_changes_anm2$percentage)

# Extract the row with the highest percentage
highest_negative_change_anm2 <- negative_changes_anm2[max_index_anm2, ]

# Extract the corresponding condition name
condition_name_neg_anm2 <- highest_negative_change_anm2$condition_name

# Calculate the district-wise mean percentage for pre and post test scores
district_wise_combined_anm2 <- df_anm2 |>
  group_by(district_name) |>
  summarise(mean_pre_test = mean(pre_total_correct, na.rm = TRUE) * 100 / max(pre_total_correct, na.rm = TRUE), 
            mean_post_test = mean(post_total_correct, na.rm = TRUE) * 100 / max(post_total_correct, na.rm = TRUE))

# Calculate Overall Average and add it to the data
overall_avg2 <- df_anm2 |>
  summarise(mean_pre_test = mean(pre_total_correct, na.rm = TRUE) * 100 / max(pre_total_correct, na.rm = TRUE), 
            mean_post_test = mean(post_total_correct, na.rm = TRUE) * 100 / max(post_total_correct, na.rm = TRUE)) |>
  mutate(district_name = "Overall Average")

# Combine the overall average with the district-wise data
district_wise_combined_anm2 <- bind_rows(district_wise_combined_anm2, overall_avg2)

# Reorder district_name factor by post-test mean percentage in descending order
district_wise_combined_anm2 <- district_wise_combined_anm2 |>
  arrange(desc(mean_post_test)) |>
  mutate(district_name = factor(district_name, levels = district_name))

# Reshape the data to long format
district_wise_combined_long_anm2 <- district_wise_combined_anm2 |>
  pivot_longer(cols = starts_with("mean_"), names_to = "test_type", values_to = "mean_percentage")

# Reorder 'test_type' factor levels to ensure 'pre' comes before 'post'
district_wise_combined_long_anm2$test_type <- factor(district_wise_combined_long_anm2$test_type, 
                                                levels = c("mean_pre_test", "mean_post_test"),
                                                labels = c("pre", "post"))

# Create a new column for color mapping based on test type and overall average
district_wise_combined_long_anm2 <- district_wise_combined_long_anm2 |>
  mutate(color_group = case_when(
    district_name == "Overall Average" & test_type == "pre" ~ "Overall Average Pre",
    district_name == "Overall Average" & test_type == "post" ~ "Overall Average Post",
    test_type == "pre" ~ "Pre",
    test_type == "post" ~ "Post",
    TRUE ~ "Other"
  ))


# Reorder district names based on "Post" mean percentage in descending order
district_wise_combined_long_anm2 <- district_wise_combined_long_anm2 %>%
  # Create a temporary column to store "Post" mean percentage
  dplyr::mutate(post_percentage = ifelse(color_group == "Post", mean_percentage, NA)) %>%
  # Group by district_name and get the max of post_percentage (for sorting)
  dplyr::group_by(district_name) %>%
  dplyr::mutate(post_percentage_max = max(post_percentage, na.rm = TRUE)) %>%
  # Arrange districts based on the max post_percentage in descending order
  dplyr::arrange(dplyr::desc(post_percentage_max)) %>%
  # Set district_name as a factor in the order of the arranged rows
  dplyr::mutate(district_name = factor(district_name, levels = unique(district_name))) %>%
  # Clean up the temporary columns
  dplyr::select(-post_percentage, -post_percentage_max)

# Set factor levels to ensure 'Pre' comes before 'Post' for each district
district_wise_combined_long_anm2$color_group <- factor(district_wise_combined_long_anm2$color_group, 
                                                      levels = c("Pre", "Post", "Overall Average Pre", "Overall Average Post"))

# Create the ggplot bar chart
districtwise_combined_percentage_plot_anm2 <- ggplot(district_wise_combined_long_anm2, aes(x = district_name, y = mean_percentage, fill = color_group)) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.7), width = 0.7) +
  geom_text(aes(label = round(mean_percentage, 1)), 
            position = position_dodge(width = 0.9), 
            vjust = -0.5,
            size = 3) +  # Reduce the data label size
  labs(x = "District Name",
       y = "Mean Percentage Score",
       fill = "Test Type") +  # Add legend title
  scale_fill_manual(values = c("Pre" = "coral", "Post" = "cyan3", 
                               "Overall Average Pre" = "purple", "Overall Average Post" = "blue")) +  # Set colors for pre, post, and overall averages
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 10, face = "bold"),
    axis.title.x = element_text(size = 12, face = "bold"),
    axis.title.y = element_text(size = 12, face = "bold"),
    legend.title = element_text(size = 10, face = "bold"),
    legend.text = element_text(size = 9)
  )

# Save the plot in the "plots" directory
ggsave("plots/districtwise_combined_percentage_plot_anm2_2.png", 
       plot = districtwise_combined_percentage_plot_anm2, 
       width = 10, 
       height = 6, 
       dpi = 300)

#### Question wise analysis

# TB
# Assuming df has a 'condition' column and we're filtering for rows where condition is 'tb'
df_tb_anm2 <- subset(df_anm2, condition == "tb")

# Calculate total_n for the filtered data
total_n_anm2 <- nrow(df_tb_anm2)

# Create the data frame with pre and post percentages for each question
st3_tb_anm2 <- data.frame(
  question = paste("Q", 1:10),
  tb_pre = c(
    (sum(df_tb_anm2$q1_pre) / total_n_anm2) * 100,
    (sum(df_tb_anm2$q2_pre) / total_n_anm2) * 100,
    (sum(df_tb_anm2$q3_pre) / total_n_anm2) * 100,
    (sum(df_tb_anm2$q4_pre) / total_n_anm2) * 100,
    (sum(df_tb_anm2$q5_pre) / total_n_anm2) * 100,
    (sum(df_tb_anm2$q6_pre) / total_n_anm2) * 100,
    (sum(df_tb_anm2$q7_pre) / total_n_anm2) * 100,
    (sum(df_tb_anm2$q8_pre) / total_n_anm2) * 100,
    (sum(df_tb_anm2$q9_pre) / total_n_anm2) * 100,
    (sum(df_tb_anm2$q10_pre) / total_n_anm2) * 100
  ),
  tb_post = c(
    (sum(df_tb_anm2$q1_post) / total_n_anm2) * 100,
    (sum(df_tb_anm2$q2_post) / total_n_anm2) * 100,
    (sum(df_tb_anm2$q3_post) / total_n_anm2) * 100,
    (sum(df_tb_anm2$q4_post) / total_n_anm2) * 100,
    (sum(df_tb_anm2$q5_post) / total_n_anm2) * 100,
    (sum(df_tb_anm2$q6_post) / total_n_anm2) * 100,
    (sum(df_tb_anm2$q7_post) / total_n_anm2) * 100,
    (sum(df_tb_anm2$q8_post) / total_n_anm2) * 100,
    (sum(df_tb_anm2$q9_post) / total_n_anm2) * 100,
    (sum(df_tb_anm2$q10_post) / total_n_anm2) * 100
  )
)

# SOB
# Assuming df has a 'condition' column and we're filtering for rows where condition is 'sob'
df_sob_anm2 <- subset(df_anm2, condition == "sob")

# Calculate total_n for the filtered data
total_n_anm2 <- nrow(df_sob_anm2)

# Create the data frame with pre and post percentages for each question
st3_sob_anm2 <- data.frame(
  question = paste("Q", 1:10),
  sob_pre = c(
    (sum(df_sob_anm2$q1_pre) / total_n_anm2) * 100,
    (sum(df_sob_anm2$q2_pre) / total_n_anm2) * 100,
    (sum(df_sob_anm2$q3_pre) / total_n_anm2) * 100,
    (sum(df_sob_anm2$q4_pre) / total_n_anm2) * 100,
    (sum(df_sob_anm2$q5_pre) / total_n_anm2) * 100,
    (sum(df_sob_anm2$q6_pre) / total_n_anm2) * 100,
    (sum(df_sob_anm2$q7_pre) / total_n_anm2) * 100,
    (sum(df_sob_anm2$q8_pre) / total_n_anm2) * 100,
    (sum(df_sob_anm2$q9_pre) / total_n_anm2) * 100,
    (sum(df_sob_anm2$q10_pre) / total_n_anm2) * 100
  ),
  sob_post = c(
    (sum(df_sob_anm2$q1_post) / total_n_anm2) * 100,
    (sum(df_sob_anm2$q2_post) / total_n_anm2) * 100,
    (sum(df_sob_anm2$q3_post) / total_n_anm2) * 100,
    (sum(df_sob_anm2$q4_post) / total_n_anm2) * 100,
    (sum(df_sob_anm2$q5_post) / total_n_anm2) * 100,
    (sum(df_sob_anm2$q6_post) / total_n_anm2) * 100,
    (sum(df_sob_anm2$q7_post) / total_n_anm2) * 100,
    (sum(df_sob_anm2$q8_post) / total_n_anm2) * 100,
    (sum(df_sob_anm2$q9_post) / total_n_anm2) * 100,
    (sum(df_sob_anm2$q10_post) / total_n_anm2) * 100
  )
)

# LSCS
# Assuming df has a 'condition' column and we're filtering for rows where condition is 'lscs'
df_lscs_anm2 <- subset(df_anm2, condition == "lscs")

# Calculate total_n for the filtered data
total_n_anm2 <- nrow(df_lscs_anm2)

# Create the data frame with pre and post percentages for each question
st3_lscs_anm2 <- data.frame(
  question = paste("Q", 1:10),
  lscs_pre = c(
    (sum(df_lscs_anm2$q1_pre) / total_n_anm2) * 100,
    (sum(df_lscs_anm2$q2_pre) / total_n_anm2) * 100,
    (sum(df_lscs_anm2$q3_pre) / total_n_anm2) * 100,
    (sum(df_lscs_anm2$q4_pre) / total_n_anm2) * 100,
    (sum(df_lscs_anm2$q5_pre) / total_n_anm2) * 100,
    (sum(df_lscs_anm2$q6_pre) / total_n_anm2) * 100,
    (sum(df_lscs_anm2$q7_pre) / total_n_anm2) * 100,
    (sum(df_lscs_anm2$q8_pre) / total_n_anm2) * 100,
    (sum(df_lscs_anm2$q9_pre) / total_n_anm2) * 100,
    (sum(df_lscs_anm2$q10_pre) / total_n_anm2) * 100
  ),
  lscs_post = c(
    (sum(df_lscs_anm2$q1_post) / total_n_anm2) * 100,
    (sum(df_lscs_anm2$q2_post) / total_n_anm2) * 100,
    (sum(df_lscs_anm2$q3_post) / total_n_anm2) * 100,
    (sum(df_lscs_anm2$q4_post) / total_n_anm2) * 100,
    (sum(df_lscs_anm2$q5_post) / total_n_anm2) * 100,
    (sum(df_lscs_anm2$q6_post) / total_n_anm2) * 100,
    (sum(df_lscs_anm2$q7_post) / total_n_anm2) * 100,
    (sum(df_lscs_anm2$q8_post) / total_n_anm2) * 100,
    (sum(df_lscs_anm2$q9_post) / total_n_anm2) * 100,
    (sum(df_lscs_anm2$q10_post) / total_n_anm2) * 100
  )
)

# Jaundice (Jau)
# Assuming df has a 'condition' column and we're filtering for rows where condition is 'jau'
df_jau_anm2 <- subset(df_anm2, condition == "jau")

# Calculate total_n for the filtered data
total_n_anm2 <- nrow(df_jau_anm2)

# Create the data frame with pre and post percentages for each question
st3_jau_anm2 <- data.frame(
  question = paste("Q", 1:10),
  jau_pre = c(
    (sum(df_jau_anm2$q1_pre) / total_n_anm2) * 100,
    (sum(df_jau_anm2$q2_pre) / total_n_anm2) * 100,
    (sum(df_jau_anm2$q3_pre) / total_n_anm2) * 100,
    (sum(df_jau_anm2$q4_pre) / total_n_anm2) * 100,
    (sum(df_jau_anm2$q5_pre) / total_n_anm2) * 100,
    (sum(df_jau_anm2$q6_pre) / total_n_anm2) * 100,
    (sum(df_jau_anm2$q7_pre) / total_n_anm2) * 100,
    (sum(df_jau_anm2$q8_pre) / total_n_anm2) * 100,
    (sum(df_jau_anm2$q9_pre) / total_n_anm2) * 100,
    (sum(df_jau_anm2$q10_pre) / total_n_anm2) * 100
  ),
  jau_post = c(
    (sum(df_jau_anm2$q1_post) / total_n_anm2) * 100,
    (sum(df_jau_anm2$q2_post) / total_n_anm2) * 100,
    (sum(df_jau_anm2$q3_post) / total_n_anm2) * 100,
    (sum(df_jau_anm2$q4_post) / total_n_anm2) * 100,
    (sum(df_jau_anm2$q5_post) / total_n_anm2) * 100,
    (sum(df_jau_anm2$q6_post) / total_n_anm2) * 100,
    (sum(df_jau_anm2$q7_post) / total_n_anm2) * 100,
    (sum(df_jau_anm2$q8_post) / total_n_anm2) * 100,
    (sum(df_jau_anm2$q9_post) / total_n_anm2) * 100,
    (sum(df_jau_anm2$q10_post) / total_n_anm2) * 100
  )
)

# HRT
# Assuming df has a 'condition' column and we're filtering for rows where condition is 'hrt'
df_hrt_anm2 <- subset(df_anm2, condition == "hrt")

# Calculate total_n for the filtered data
total_n_anm2 <- nrow(df_hrt_anm2)

# Create the data frame with pre and post percentages for each question
st3_hrt_anm2 <- data.frame(
  question = paste("Q", 1:10),
  hrt_pre = c(
    (sum(df_hrt_anm2$q1_pre) / total_n_anm2) * 100,
    (sum(df_hrt_anm2$q2_pre) / total_n_anm2) * 100,
    (sum(df_hrt_anm2$q3_pre) / total_n_anm2) * 100,
    (sum(df_hrt_anm2$q4_pre) / total_n_anm2) * 100,
    (sum(df_hrt_anm2$q5_pre) / total_n_anm2) * 100,
    (sum(df_hrt_anm2$q6_pre) / total_n_anm2) * 100,
    (sum(df_hrt_anm2$q7_pre) / total_n_anm2) * 100,
    (sum(df_hrt_anm2$q8_pre) / total_n_anm2) * 100,
    (sum(df_hrt_anm2$q9_pre) / total_n_anm2) * 100,
    (sum(df_hrt_anm2$q10_pre) / total_n_anm2) * 100
  ),
  hrt_post = c(
    (sum(df_hrt_anm2$q1_post) / total_n_anm2) * 100,
    (sum(df_hrt_anm2$q2_post) / total_n_anm2) * 100,
    (sum(df_hrt_anm2$q3_post) / total_n_anm2) * 100,
    (sum(df_hrt_anm2$q4_post) / total_n_anm2) * 100,
    (sum(df_hrt_anm2$q5_post) / total_n_anm2) * 100,
    (sum(df_hrt_anm2$q6_post) / total_n_anm2) * 100,
    (sum(df_hrt_anm2$q7_post) / total_n_anm2) * 100,
    (sum(df_hrt_anm2$q8_post) / total_n_anm2) * 100,
    (sum(df_hrt_anm2$q9_post) / total_n_anm2) * 100,
    (sum(df_hrt_anm2$q10_post) / total_n_anm2) * 100
  )
)

# EPI
# Assuming df has a 'condition' column and we're filtering for rows where condition is 'epi'
df_epi_anm2 <- subset(df_anm2, condition == "epi")

# Calculate total_n for the filtered data
total_n_anm2 <- nrow(df_epi_anm2)

# Create the data frame with pre and post percentages for each question
st3_epi_anm2 <- data.frame(
  question = paste("Q", 1:10),
  epi_pre = c(
    (sum(df_epi_anm2$q1_pre) / total_n_anm2) * 100,
    (sum(df_epi_anm2$q2_pre) / total_n_anm2) * 100,
    (sum(df_epi_anm2$q3_pre) / total_n_anm2) * 100,
    (sum(df_epi_anm2$q4_pre) / total_n_anm2) * 100,
    (sum(df_epi_anm2$q5_pre) / total_n_anm2) * 100,
    (sum(df_epi_anm2$q6_pre) / total_n_anm2) * 100,
    (sum(df_epi_anm2$q7_pre) / total_n_anm2) * 100,
    (sum(df_epi_anm2$q8_pre) / total_n_anm2) * 100,
    (sum(df_epi_anm2$q9_pre) / total_n_anm2) * 100,
    (sum(df_epi_anm2$q10_pre) / total_n_anm2) * 100
  ),
  epi_post = c(
    (sum(df_epi_anm2$q1_post) / total_n_anm2) * 100,
    (sum(df_epi_anm2$q2_post) / total_n_anm2) * 100,
    (sum(df_epi_anm2$q3_post) / total_n_anm2) * 100,
    (sum(df_epi_anm2$q4_post) / total_n_anm2) * 100,
    (sum(df_epi_anm2$q5_post) / total_n_anm2) * 100,
    (sum(df_epi_anm2$q6_post) / total_n_anm2) * 100,
    (sum(df_epi_anm2$q7_post) / total_n_anm2) * 100,
    (sum(df_epi_anm2$q8_post) / total_n_anm2) * 100,
    (sum(df_epi_anm2$q9_post) / total_n_anm2) * 100,
    (sum(df_epi_anm2$q10_post) / total_n_anm2) * 100
  )
)
df_questions_combined_anm2 <- cbind(
  st3_tb_anm2["question"],   # Include question column
  st3_tb_anm2[, c("tb_pre", "tb_post")],
  st3_sob_anm2[, c("sob_pre", "sob_post")],
  st3_lscs_anm2[, c("lscs_pre", "lscs_post")],
  st3_jau_anm2[, c("jau_pre", "jau_post")],
  st3_hrt_anm2[, c("hrt_pre", "hrt_post")],
  st3_epi_anm2[, c("epi_pre", "epi_post")]
)


# Round all percentage columns to 2 decimal places
df_questions_combined_anm2[, 2:ncol(df_questions_combined_anm2)] <- round(df_questions_combined_anm2[, 2:ncol(df_questions_combined_anm2)], 1)

df_questions_combined_anm2_gt <- df_questions_combined_anm2 %>%
  gt() %>%
  cols_label(
    question = "Question",
    tb_pre = "TB Pre",
    tb_post = "TB Post",
    sob_pre = "SOB Pre",
    sob_post = "SOB Post",
    lscs_pre = "LSCS Pre",
    lscs_post = "LSCS Post",
    jau_pre = "JAU Pre",
    jau_post = "JAU Post",
    hrt_pre = "HRT Pre",
    hrt_post = "HRT Post",
    epi_pre = "EPI Pre",
    epi_post = "EPI Post"
  ) %>%
  tab_spanner(
    label = "Pre-Post Score Percentage",
    columns = c("tb_pre", "tb_post", 
                "sob_pre", "sob_post", "lscs_pre", "lscs_post", 
                "jau_pre", "jau_post", "hrt_pre", "hrt_post", 
                "epi_pre", "epi_post")
  ) 

# Apply `tab_style()` only to individual columns where values are < 50
for (col in c("tb_pre", "tb_post", "sob_pre", "sob_post", "lscs_pre", "lscs_post",
              "jau_pre", "jau_post", "hrt_pre", "hrt_post", "epi_pre", "epi_post")) {
  df_questions_combined_anm2_gt <- df_questions_combined_anm2_gt %>%
    tab_style(
      style = list(
        cell_fill(color = "yellow"),  # Highlight only the specific cells
        cell_text(weight = "bold")    # Make text bold
      ),
      locations = cells_body(
        columns = col, 
        rows = df_questions_combined_anm2[[col]] < 50  # Apply condition per column
      )
    )
}

# Save the data frame to a CSV file
write.csv(df_questions_combined_anm2, "tables/df_questions_combined_anm2_gt_2.csv", row.names = FALSE)


```

```{r}
#| echo: false
#| warning: false
#| message: false

# Define the file paths
filepaths <- c(
  here::here('data','ts_cleaned_data','mo_cleaned_qanc_ts.csv'),
  here::here('data','ts_cleaned_data','mo_cleaned_ane_ts.csv'),
  here::here('data','ts_cleaned_data','mo_cleaned_htn_ts.csv'),
  here::here('data','ts_cleaned_data','mo_cleaned_gdm_ts.csv'),
  here::here('data','ts_cleaned_data','mo_cleaned_aph_ts.csv')
   )

# Import all files as data frames
data_frames_mo1 <- lapply(filepaths, read.csv)

# Bind all data frames into a single data frame
df_mo1 <- do.call(rbind, data_frames_mo1)

# Cleaning the data

df_mo1 <-
  df_mo1 |>
  janitor::clean_names()

# Remove unwanted columns

df_mo1 <- df_mo1 |> 
  select(-c("number",
            "name_post", 
            "age_post", 
            "entry_post", 
            "districts_post", 
            "phc_name_post", 
            "experience_post", 
            "mobile_no_post",
            "date_post"))

# Districts with district names

df_mo1$age_pre <- df_mo1$age_pre |> as.character()

# Ensure `age_pre` is numeric
df_mo1$age_pre <- as.numeric(df_mo1$age_pre)

# Current year
current_year <- as.numeric(format(Sys.Date(), "%Y"))

# Identify values in `age_pre` that are in the year format and convert them to age
df_mo1$age_pre <- ifelse(df_mo1$age_pre >= 1900 & df_mo1$age_pre <= current_year,  # Assuming any value between 1900 and the current year is a year
                     current_year - df_mo1$age_pre,  # Convert year to age
                     df_mo1$age_pre)  # Leave other values unchanged

df_mo1 <- df_mo1 %>%
  mutate(districts_number = case_when(
    districts_pre == "Adilabad" ~ 1,
    districts_pre == "Bhadradri Kothagudem" ~ 2,
    districts_pre == "Hyderabad" ~ 3,
    districts_pre == "Jagityal" ~ 4,
    districts_pre == "Jangaon" ~ 5,
    districts_pre == "Jayashankar Bhupalapally" ~ 6,
    districts_pre == "Jogulamba Gadwal" ~ 7,
    districts_pre == "Kamareddy" ~ 8,
    districts_pre == "Karimnagar" ~ 9,
    districts_pre == "Khammam" ~ 10,
    districts_pre == "Komarambheem Asifabad" ~ 11,
    districts_pre == "Mahabubabad" ~ 12,
    districts_pre == "Mahabubnagar" ~ 13,
    districts_pre == "Mancheriyal" ~ 14,
    districts_pre == "Medak" ~ 15,
    districts_pre == "Medchal Malkajgiri" ~ 16,
    districts_pre == "Mulugu" ~ 17,
    districts_pre == "Nagarkurnool" ~ 18,
    districts_pre == "Nalgonda" ~ 19,
    districts_pre == "Narayanpet" ~ 20,
    districts_pre == "Nirmal" ~ 21,
    districts_pre == "Nizamabad" ~ 22,
    districts_pre == "Peddapally" ~ 23,
    districts_pre == "Rajanna Siricilla" ~ 24,
    districts_pre == "Rangareddy" ~ 25,
    districts_pre == "Sangareddy" ~ 26,
    districts_pre == "Siddipet" ~ 27,
    districts_pre == "Suryapet" ~ 28,
    districts_pre == "Vikarabad" ~ 29,
    districts_pre == "Wanaparthy" ~ 30,
    districts_pre == "Warangal Rural" ~ 31,
    districts_pre == "Warangal Urban" ~ 32,
    districts_pre == "Yadadri Bhuvanagiri" ~ 33,
    TRUE ~ NA_integer_
  ))

# Change the district names and mutate a column with the concerned district names

df_mo1 <- df_mo1 %>%
  mutate(district_name = case_when(
    districts_number == 1 ~ "Adilabad",
    districts_number == 2 ~ "Bhadradri Kothagudem",
    districts_number == 3 ~ "Hyderabad",
    districts_number == 4 ~ "Jagtial",
    districts_number == 5 ~ "Jangaon",
    districts_number == 6 ~ "Jayashankar Bhupalpally",
    districts_number == 7 ~ "Jogulamba Gadwal",
    districts_number == 8 ~ "Kamareddy",
    districts_number == 9 ~ "Karimnagar",
    districts_number == 10 ~ "Khammam",
    districts_number == 11 ~ "Komaram Bheem Asifabad",
    districts_number == 12 ~ "Mahabubabad",
    districts_number == 13 ~ "Mahabubnagar",
    districts_number == 14 ~ "Mancherial",
    districts_number == 15 ~ "Medak",
    districts_number == 16 ~ "Medchal Malkajgiri",
    districts_number == 17 ~ "Mulugu",
    districts_number == 18 ~ "Nagarkurnool",
    districts_number == 19 ~ "Nalgonda",
    districts_number == 20 ~ "Narayanpet",
    districts_number == 21 ~ "Nirmal",
    districts_number == 22 ~ "Nizamabad",
    districts_number == 23 ~ "Peddapalli",
    districts_number == 24 ~ "Rajanna Sircilla",
    districts_number == 25 ~ "Rangareddy",
    districts_number == 26 ~ "Sangareddy",
    districts_number == 27 ~ "Siddipet",
    districts_number == 28 ~ "Suryapet",
    districts_number == 29 ~ "Vikarabad",
    districts_number == 30 ~ "Wanaparthy",
    districts_number == 31 ~ "Warangal Rural",
    districts_number == 32 ~ "Warangal Urban",
    districts_number == 33 ~ "Yadadri Bhuvanagiri",
    TRUE ~ NA_character_
  ))

# QANC Correct answers
# Pre
df_mo1 <- df_mo1 %>%
  mutate(
    q1_pre = ifelse(condition == "qanc", ifelse(q1_pre == 4, 1, 0), q1_pre),
    q2_pre = ifelse(condition == "qanc", ifelse(q2_pre == 3, 1, 0), q2_pre),
    q3_pre = ifelse(condition == "qanc", ifelse(q3_pre == 1, 1, 0), q3_pre),
    q4_pre = ifelse(condition == "qanc", ifelse(q4_pre == 1, 1, 0), q4_pre),
    q5_pre = ifelse(condition == "qanc", ifelse(q5_pre == 2, 1, 0), q5_pre),
    q6_pre = ifelse(condition == "qanc", ifelse(q6_pre == 4, 1, 0), q6_pre),
    q7_pre = ifelse(condition == "qanc", ifelse(q7_pre == 1, 1, 0), q7_pre),
    q8_pre = ifelse(condition == "qanc", ifelse(q8_pre == 2, 1, 0), q8_pre),
    q9_pre = ifelse(condition == "qanc", ifelse(q9_pre == 4, 1, 0), q9_pre),
    q10_pre = ifelse(condition == "qanc", ifelse(q10_pre == 1, 1, 0), q10_pre))

# Post
df_mo1 <- df_mo1 %>%
  mutate(
    q1_post = ifelse(condition == "qanc", ifelse(q1_post == 4, 1, 0), q1_post),
    q2_post = ifelse(condition == "qanc", ifelse(q2_post == 3, 1, 0), q2_post),
    q3_post = ifelse(condition == "qanc", ifelse(q3_post == 1, 1, 0), q3_post),
    q4_post = ifelse(condition == "qanc", ifelse(q4_post == 1, 1, 0), q4_post),
    q5_post = ifelse(condition == "qanc", ifelse(q5_post == 2, 1, 0), q5_post),
    q6_post = ifelse(condition == "qanc", ifelse(q6_post == 4, 1, 0), q6_post),
    q7_post = ifelse(condition == "qanc", ifelse(q7_post == 1, 1, 0), q7_post),
    q8_post = ifelse(condition == "qanc", ifelse(q8_post == 2, 1, 0), q8_post),
    q9_post = ifelse(condition == "qanc", ifelse(q9_post == 4, 1, 0), q9_post),
    q10_post = ifelse(condition == "qanc", ifelse(q10_post == 1, 1, 0), q10_post))

# Anaemia correct answers
# Pre
df_mo1 <- df_mo1 %>%
  mutate(
    q1_pre = ifelse(condition == "ane", ifelse(q1_pre == 1, 1, 0), q1_pre),
    q2_pre = ifelse(condition == "ane", ifelse(q2_pre == 1, 1, 0), q2_pre),
    q3_pre = ifelse(condition == "ane", ifelse(q3_pre == 4, 1, 0), q3_pre),
    q4_pre = ifelse(condition == "ane", ifelse(q4_pre == 4, 1, 0), q4_pre),
    q5_pre = ifelse(condition == "ane", ifelse(q5_pre == 3, 1, 0), q5_pre),
    q6_pre = ifelse(condition == "ane", ifelse(q6_pre == 1, 1, 0), q6_pre),
    q7_pre = ifelse(condition == "ane", ifelse(q7_pre == 2, 1, 0), q7_pre),
    q8_pre = ifelse(condition == "ane", ifelse(q8_pre == 4, 1, 0), q8_pre),
    q9_pre = ifelse(condition == "ane", ifelse(q9_pre == 1, 1, 0), q9_pre),
    q10_pre = ifelse(condition == "ane", ifelse(q10_pre == 4, 1, 0), q10_pre))

# Post
df_mo1 <- df_mo1 %>%
  mutate(
    q1_post = ifelse(condition == "ane", ifelse(q1_post == 1, 1, 0), q1_post),
    q2_post = ifelse(condition == "ane", ifelse(q2_post == 1, 1, 0), q2_post),
    q3_post = ifelse(condition == "ane", ifelse(q3_post == 4, 1, 0), q3_post),
    q4_post = ifelse(condition == "ane", ifelse(q4_post == 4, 1, 0), q4_post),
    q5_post = ifelse(condition == "ane", ifelse(q5_post == 3, 1, 0), q5_post),
    q6_post = ifelse(condition == "ane", ifelse(q6_post == 1, 1, 0), q6_post),
    q7_post = ifelse(condition == "ane", ifelse(q7_post == 2, 1, 0), q7_post),
    q8_post = ifelse(condition == "ane", ifelse(q8_post == 4, 1, 0), q8_post),
    q9_post = ifelse(condition == "ane", ifelse(q9_post == 1, 1, 0), q9_post),
    q10_post = ifelse(condition == "ane", ifelse(q10_post == 4, 1, 0), q10_post))

# HTN correct answers
# Pre
df_mo1 <- df_mo1 %>%
  mutate(
    q1_pre = ifelse(condition == "htn", ifelse(q1_pre == 1, 1, 0), q1_pre),
    q2_pre = ifelse(condition == "htn", ifelse(q2_pre == 4, 1, 0), q2_pre),
    q3_pre = ifelse(condition == "htn", ifelse(q3_pre == 2, 1, 0), q3_pre),
    q4_pre = ifelse(condition == "htn", ifelse(q4_pre == 1, 1, 0), q4_pre),
    q5_pre = ifelse(condition == "htn", ifelse(q5_pre == 4, 1, 0), q5_pre),
    q6_pre = ifelse(condition == "htn", ifelse(q6_pre == 4, 1, 0), q6_pre),
    q7_pre = ifelse(condition == "htn", ifelse(q7_pre == 3, 1, 0), q7_pre),
    q8_pre = ifelse(condition == "htn", ifelse(q8_pre == 4, 1, 0), q8_pre),
    q9_pre = ifelse(condition == "htn", ifelse(q9_pre == 2, 1, 0), q9_pre),
    q10_pre = ifelse(condition == "htn", ifelse(q10_pre == 4, 1, 0), q10_pre))

# Post
df_mo1 <- df_mo1 %>%
  mutate(
    q1_post = ifelse(condition == "htn", ifelse(q1_post == 1, 1, 0), q1_post),
    q2_post = ifelse(condition == "htn", ifelse(q2_post == 4, 1, 0), q2_post),
    q3_post = ifelse(condition == "htn", ifelse(q3_post == 2, 1, 0), q3_post),
    q4_post = ifelse(condition == "htn", ifelse(q4_post == 1, 1, 0), q4_post),
    q5_post = ifelse(condition == "htn", ifelse(q5_post == 4, 1, 0), q5_post),
    q6_post = ifelse(condition == "htn", ifelse(q6_post == 4, 1, 0), q6_post),
    q7_post = ifelse(condition == "htn", ifelse(q7_post == 3, 1, 0), q7_post),
    q8_post = ifelse(condition == "htn", ifelse(q8_post == 4, 1, 0), q8_post),
    q9_post = ifelse(condition == "htn", ifelse(q9_post == 2, 1, 0), q9_post),
    q10_post = ifelse(condition == "htn", ifelse(q10_post == 4, 1, 0), q10_post))

# GDM Correct answers 
# Pre
df_mo1 <- df_mo1 %>%
  mutate(
    q1_pre = ifelse(condition == "gdm", ifelse(q1_pre == 1, 1, 0), q1_pre),
    q2_pre = ifelse(condition == "gdm", ifelse(q2_pre == 3, 1, 0), q2_pre),
    q3_pre = ifelse(condition == "gdm", ifelse(q3_pre == 3, 1, 0), q3_pre),
    q4_pre = ifelse(condition == "gdm", ifelse(q4_pre == 1, 1, 0), q4_pre),
    q5_pre = ifelse(condition == "gdm", ifelse(q5_pre == 2, 1, 0), q5_pre),
    q6_pre = ifelse(condition == "gdm", ifelse(q6_pre == 1, 1, 0), q6_pre),
    q7_pre = ifelse(condition == "gdm", ifelse(q7_pre == 1, 1, 0), q7_pre),
    q8_pre = ifelse(condition == "gdm", ifelse(q8_pre == 2, 1, 0), q8_pre),
    q9_pre = ifelse(condition == "gdm", ifelse(q9_pre == 4, 1, 0), q9_pre),
    q10_pre = ifelse(condition == "gdm", ifelse(q10_pre == 1, 1, 0), q10_pre))

# Post
df_mo1 <- df_mo1 %>%
  mutate(
    q1_post = ifelse(condition == "gdm", ifelse(q1_post == 1, 1, 0), q1_post),
    q2_post = ifelse(condition == "gdm", ifelse(q2_post == 3, 1, 0), q2_post),
    q3_post = ifelse(condition == "gdm", ifelse(q3_post == 3, 1, 0), q3_post),
    q4_post = ifelse(condition == "gdm", ifelse(q4_post == 1, 1, 0), q4_post),
    q5_post = ifelse(condition == "gdm", ifelse(q5_post == 2, 1, 0), q5_post),
    q6_post = ifelse(condition == "gdm", ifelse(q6_post == 1, 1, 0), q6_post),
    q7_post = ifelse(condition == "gdm", ifelse(q7_post == 1, 1, 0), q7_post),
    q8_post = ifelse(condition == "gdm", ifelse(q8_post == 2, 1, 0), q8_post),
    q9_post = ifelse(condition == "gdm", ifelse(q9_post == 4, 1, 0), q9_post),
    q10_post = ifelse(condition == "gdm", ifelse(q10_post == 1, 1, 0), q10_post))

# APH Correct answers 
# Pre
df_mo1 <- df_mo1 %>%
  mutate(
    q1_pre = ifelse(condition == "aph", ifelse(q1_pre == 2, 1, 0), q1_pre),
    q2_pre = ifelse(condition == "aph", ifelse(q2_pre == 4, 1, 0), q2_pre),
    q3_pre = ifelse(condition == "aph", ifelse(q3_pre == 2, 1, 0), q3_pre),
    q4_pre = ifelse(condition == "aph", ifelse(q4_pre == 2, 1, 0), q4_pre),
    q5_pre = ifelse(condition == "aph", ifelse(q5_pre == 3, 1, 0), q5_pre),
    q6_pre = ifelse(condition == "aph", ifelse(q6_pre == 2, 1, 0), q6_pre),
    q7_pre = ifelse(condition == "aph", ifelse(q7_pre == 4, 1, 0), q7_pre),
    q8_pre = ifelse(condition == "aph", ifelse(q8_pre == 4, 1, 0), q8_pre),
    q9_pre = ifelse(condition == "aph", ifelse(q9_pre == 1, 1, 0), q9_pre),
    q10_pre = ifelse(condition == "aph", ifelse(q10_pre == 2, 1, 0), q10_pre))

# Post
df_mo1 <- df_mo1 %>%
  mutate(
    q1_post = ifelse(condition == "aph", ifelse(q1_post == 2, 1, 0), q1_post),
    q2_post = ifelse(condition == "aph", ifelse(q2_post == 4, 1, 0), q2_post),
    q3_post = ifelse(condition == "aph", ifelse(q3_post == 2, 1, 0), q3_post),
    q4_post = ifelse(condition == "aph", ifelse(q4_post == 2, 1, 0), q4_post),
    q5_post = ifelse(condition == "aph", ifelse(q5_post == 3, 1, 0), q5_post),
    q6_post = ifelse(condition == "aph", ifelse(q6_post == 2, 1, 0), q6_post),
    q7_post = ifelse(condition == "aph", ifelse(q7_post == 4, 1, 0), q7_post),
    q8_post = ifelse(condition == "aph", ifelse(q8_post == 4, 1, 0), q8_post),
    q9_post = ifelse(condition == "aph", ifelse(q9_post == 1, 1, 0), q9_post),
    q10_post = ifelse(condition == "aph", ifelse(q10_post == 2, 1, 0), q10_post))

# Sum of Pre and post total correct scores
df_mo1 <- df_mo1 %>%
  mutate(
    pre_total_correct = rowSums(select(., starts_with("q") & ends_with("pre"))),
    post_total_correct = rowSums(select(., starts_with("q") & ends_with("post")))
  )

df_mo1 <- df_mo1 |> 
  mutate(relative_change = post_total_correct - pre_total_correct)

# Adding relative change column and creating code for the same
df_mo1 <- df_mo1 %>%
  mutate(rc_code = case_when(
    relative_change == 0 ~ "No Change",
    relative_change %in% c(-1, -2) ~ "-1 to -2",
    relative_change %in% c(1, 2) ~ "1 to 2",
    relative_change >= 3 ~ "+3 and above",
    relative_change <= -3 ~ "-3 and below",
    TRUE ~ NA_character_  # Ensure that the NA type is character to match the other outcomes
  ))

df_mo1 <- df_mo1 %>%
  mutate(rc_positive_negative_code = case_when(
    relative_change == 0 ~ "No Change",
    relative_change %in% c(-1, -2) ~ "Negative change",
    relative_change %in% c(1, 2) ~ "Positive change",
    relative_change >= 3 ~ "Positive change",
    relative_change <= -3 ~ "Negative change",
    TRUE ~ NA_character_  # Ensure that the NA type is character to match the other outcomes
  ))

# Create summary statistics grouped by district_name and condition
sta1_mo1 <- df_mo1 %>%
  group_by(district_name, condition) %>%
  summarise(
    pre_mean = round(mean(pre_total_correct, na.rm = TRUE), 1),
    pre_std = round(sd(pre_total_correct, na.rm = TRUE), 1),
    pre_mean_pct = round((mean(pre_total_correct, na.rm = TRUE) / 10) * 100, 1),  # Pre-test percentage
    post_mean = round(mean(post_total_correct, na.rm = TRUE), 1),
    post_std = round(sd(post_total_correct, na.rm = TRUE), 1),
    post_mean_pct = round((mean(post_total_correct, na.rm = TRUE) / 10) * 100, 1),  # Post-test percentage
    p_value = ifelse(
      sum(!is.na(pre_total_correct)) > 1 & sum(!is.na(post_total_correct)) > 1, 
      round(t.test(pre_total_correct, post_total_correct)$p.value, 6), 
      NA )
  )

# Calculate state average (overall mean, std, and percentage grouped by condition)
state_avg_mo1 <- df_mo1 %>%
  group_by(condition) %>%
  summarise(
    pre_mean = round(mean(pre_total_correct, na.rm = TRUE), 1),
    pre_std = round(sd(pre_total_correct, na.rm = TRUE), 1),
    pre_mean_pct = round((mean(pre_total_correct, na.rm = TRUE) / 10) * 100, 1),  # Pre-test percentage
    post_mean = round(mean(post_total_correct, na.rm = TRUE), 1),
    post_std = round(sd(post_total_correct, na.rm = TRUE), 1),
    post_mean_pct = round((mean(post_total_correct, na.rm = TRUE) / 10) * 100, 1)  # Post-test percentage
  ) %>%
  mutate(district_name = "Overall Average")  # Add state average label

# Combine district-level and state-level data
sta1_mo1 <- bind_rows(sta1_mo1, state_avg_mo1)

# Save sta1 as a CSV file
write.csv(sta1_mo1, "tables/sta1_summary_mo1_ts_1.csv", row.names = FALSE)

# Overall mean, std, and percentage grouped by condition
sta2_mo1 <- df_mo1 %>%
  group_by(condition) %>%
  summarise(
    n = n(),  # Count of rows for each condition
    pre_mean = round(mean(pre_total_correct, na.rm = TRUE), 1),
    pre_std = round(sd(pre_total_correct, na.rm = TRUE), 1),
    pre_mean_pct = round((mean(pre_total_correct, na.rm = TRUE) / 10) * 100, 1),  # Pre-test percentage
    post_mean = round(mean(post_total_correct, na.rm = TRUE), 1),
    post_std = round(sd(post_total_correct, na.rm = TRUE), 1),
    post_mean_pct = round((mean(post_total_correct, na.rm = TRUE) / 10) * 100, 1)  # Post-test percentage
  )

# Calculate state average (same as above)
state_avg_mo1 <- df_mo1 %>%
  summarise(
    pre_mean = round(mean(pre_total_correct, na.rm = TRUE), 1),
    pre_std = round(sd(pre_total_correct, na.rm = TRUE), 1),
    pre_mean_pct = round((mean(pre_total_correct, na.rm = TRUE) / 10) * 100, 1),  # Pre-test percentage
    post_mean = round(mean(post_total_correct, na.rm = TRUE), 1),
    post_std = round(sd(post_total_correct, na.rm = TRUE), 1),
    post_mean_pct = round((mean(post_total_correct, na.rm = TRUE) / 10) * 100, 1)  # Post-test percentage
  ) %>%
  mutate(condition = "Overall Average")  # Add state average label

# Combine condition-level and state-level data
sta2_mo1 <- bind_rows(sta2_mo1, state_avg_mo1)

# Save sta2 as a CSV file
write.csv(sta2_mo1, "tables/sta2_summary_mo1_ts_1.csv", row.names = FALSE)

# Reorder condition factor based on post-test mean percentage in descending order
sta2_mo1 <- sta2_mo1 %>%
  arrange(desc(post_mean_pct)) %>%
  mutate(condition = factor(condition, levels = condition))

# Reshape the data from wide to long format using tidyr's pivot_longer
sta2_long_mo1 <- tidyr::pivot_longer(sta2_mo1, 
                                     cols = c("pre_mean_pct", "post_mean_pct"), 
                                     names_to = "Time", 
                                     values_to = "Mean_Pct")

# Calculate the gain in knowledge for each condition
knowledge_gain_mo1 <- sta2_mo1 %>%
  mutate(Gain = post_mean_pct - pre_mean_pct) %>%
  select(condition, Gain)

# Reorder 'Time' factor levels to ensure 'pre' comes before 'post'
sta2_long_mo1$Time <- factor(sta2_long_mo1$Time, levels = c("pre_mean_pct", "post_mean_pct"))

# Combine data for all conditions
relative_change_combined_mo1 <- df_mo1 %>%
  count(condition, rc_positive_negative_code) %>%  # Count occurrences for each condition and change type
  group_by(condition) %>%  # Group by condition
  mutate(percentage = n / sum(n) * 100)  # Calculate percentage

# Reorder 'condition' based on descending percentage of "Positive change"
positive_order_mo1 <- relative_change_combined_mo1 %>%
  filter(rc_positive_negative_code == "Positive change") %>%
  arrange(percentage) %>%  # Sort in ascending order
  pull(condition)  # Extract the ordered conditions

relative_change_combined_mo1 <- relative_change_combined_mo1 %>%
  mutate(condition = factor(condition, levels = positive_order_mo1))  # Reorder factor levels

# Replace condition abbreviations with full names
sta2_mo1 <- sta2_mo1 %>%
  mutate(condition_name = case_when(
    condition == "ane" ~ "Anaemia",
    condition == "aph" ~ "Antepartum Haemorrhage",
    condition == "gdm" ~ "Gestational Diabetes",
    condition == "htn" ~ "Hypertension",
    condition == "qanc" ~ "Quality ANC",
    TRUE ~ condition  # Keep other values unchanged (if any)
  ))

#Map - Trainings happening in districts

library(sf)

# Load the GeoJSON file
telangana_sf_mo1 <- st_read(here::here("data", "ts_cleaned_data", "telangana.json"), quiet = TRUE)

# Create district responses from your dataset (df)
#Pull number of responses
district_responses_mo1 <- df_mo1 %>%
  group_by(district_name) %>%
  summarise(no_of_responses = n())

# Mutate the District column in telangana_sf to match district_responses
telangana_sf_mo1 <- telangana_sf_mo1 %>%
  mutate(district_name = case_when(
    District == "ADILABAD" ~ "Adilabad",
    District == "BHADRADRI KOTHAGUDEM" ~ "Bhadradri Kothagudem",
    District == "HYDERABAD" ~ "Hyderabad",
    District == "JAGTIAL" ~ "Jagtial",
    District == "JANGAON" ~ "Jangaon",
    District == "JAYASHANKAR BHUPALAPALLY" ~ "Jayashankar Bhupalpally",
    District == "JOGULAMBA GADWAL" ~ "Jogulamba Gadwal",
    District == "KAMAREDDY" ~ "Kamareddy",
    District == "KARIMNAGAR" ~ "Karimnagar",
    District == "KHAMMAM" ~ "Khammam",
    District == "KUMURAM BHEEM" ~ "Komaram Bheem Asifabad",
    District == "MAHABUBABAD" ~ "Mahabubabad",
    District == "MAHABUBNAGAR" ~ "Mahabubnagar",
    District == "MANCHERIAL" ~ "Mancherial",
    District == "MEDAK" ~ "Medak",
    District == "MEDCHAL-MALKAJGIRI" ~ "Medchal Malkajgiri",
    District == "MULUGU" ~ "Mulugu",
    District == "NAGARKURNOOL" ~ "Nagarkurnool",
    District == "NALGONDA" ~ "Nalgonda",
    District == "NARAYANPET" ~ "Narayanpet",
    District == "NIRMAL" ~ "Nirmal",
    District == "NIZAMABAD" ~ "Nizamabad",
    District == "PEDDAPALLI" ~ "Peddapalli",
    District == "RANJANNA SIRCILLA" ~ "Rajanna Sircilla",
    District == "RANGAREDDY" ~ "Rangareddy",
    District == "SANGAREDDY" ~ "Sangareddy",
    District == "SIDDIPET" ~ "Siddipet",
    District == "SURYAPET" ~ "Suryapet",
    District == "VIKARABAD" ~ "Vikarabad",
    District == "WANAPARTHY" ~ "Wanaparthy",
    District == "WARANGAL (RURAL)" ~ "Warangal Rural",
    District == "WARANGAL (URBAN)" ~ "Warangal Urban",
    District == "YADADRI BHUVANAGIRI" ~ "Yadadri Bhuvanagiri",
    TRUE ~ District  # Keep original value if no match
  ))

# Join the standardized district_responses with telangana_sf
merged_tg_sf_mo1 <- telangana_sf_mo1 %>%
  left_join(district_responses_mo1, by = "district_name")

# Identify districts with responses
merged_tg_sf_mo1 <- merged_tg_sf_mo1 %>%
  mutate(map = ifelse(!is.na(no_of_responses), 1, 0))

# Plot the map
telangana_map_plot_mo1 <- ggplot(merged_tg_sf_mo1) +
  geom_sf(aes(fill = factor(map)), color = "black") +
  scale_fill_manual(values = c("0" = "grey90", "1" = "lightgreen")) +
  geom_sf_text(data = merged_tg_sf_mo1 %>% filter(map == 1), aes(label = District), size = 3) + 
  theme_void() +
  theme(legend.position = "none")


# Create a new column to differentiate the state average from other conditions
sta2_long_mo1 <- sta2_long_mo1 %>%
  mutate(state_avg = ifelse(condition == "Overall Average", "Overall Average", "Conditions"))

# Create the ggplot bar chart with adjustments for spacing and legibility
pre_post_mean_pct_mo1 <- ggplot(sta2_long_mo1, aes(x = condition, y = Mean_Pct, fill = interaction(Time, state_avg))) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.8), width = 0.7) +  # Increase spacing
  scale_fill_manual(values = c("pre_mean_pct.Conditions" = "blue", 
                               "post_mean_pct.Conditions" = "orange",
                               "pre_mean_pct.Overall Average" = "lightskyblue", 
                               "post_mean_pct.Overall Average" = "lightgreen")) +
  geom_text(aes(label = round(Mean_Pct, 1)), 
            position = position_dodge(width = 0.8),  # Adjust text position to align with the new dodge width
            vjust = -0.5) +  # Adjust label position
  labs(x = "Condition", y = "Mean %") +
  theme_minimal() +
  theme(
    legend.title = element_blank(),
    axis.text.x = element_text(size = 12, face = "bold", angle = 45, hjust = 1),  # Rotate axis labels for better legibility
    axis.title.x = element_text(size = 14, face = "bold"),
    plot.margin = margin(10, 20, 10, 20),  # Add space around the plot
    panel.grid.major.x = element_blank(),  # Optional: remove vertical grid lines for clarity
    panel.grid.minor.x = element_blank()
  ) +
  # Add gain in knowledge as annotations below the x-axis labels
  annotate("text", 
           x = knowledge_gain_mo1$condition, 
           y = -5,  # Position slightly below the x-axis
           label = paste0(round(knowledge_gain_mo1$Gain, 1), "%"),
           size = 3.5, 
           color = "red")

# Save the plot in the "plots" directory
ggsave("plots/pre_post_mean_pct_mo1_1.png", 
       plot = pre_post_mean_pct_mo1, 
       width = 10, 
       height = 6, 
       dpi = 300)


# Create the plot object
plot_relative_change_mo1 <- ggplot(relative_change_combined_mo1, aes(x = percentage, y = condition, fill = rc_positive_negative_code)) +
  geom_bar(stat = "identity", position = "dodge", width = 0.7) +
  geom_text(aes(label = sprintf("%.1f%%", percentage)), 
            position = position_dodge(width = 0.9), 
            hjust = -0.2, 
            size = 3) +
  labs(x = "Percentage (%)", y = "Condition") +
  scale_fill_manual(values = c("Positive change" = "darkgreen", 
                               "Negative change" = "red", 
                               "No Change" = "orange")) +
  scale_x_continuous(expand = expansion(mult = c(0, 0.1))) +
  theme_minimal(base_size = 12) +
  theme(
    axis.text.y = element_text(size = 10),
    axis.text.x = element_text(size = 10),
    axis.title.x = element_text(size = 12, face = "bold"),
    axis.title.y = element_text(size = 12, face = "bold"),
    plot.title = element_text(size = 14, face = "bold", hjust = 0.5),
    legend.title = element_blank(),
    legend.text = element_text(size = 10)
  )

# Save the plot in the "plots" directory
ggsave("plots/plot_relative_change_mo1_1.png", 
       plot = plot_relative_change_mo1, 
       width = 10, 
       height = 6, 
       dpi = 300)

# Add condition names
relative_change_combined_mo1 <- relative_change_combined_mo1 %>%
  mutate(condition_name = case_when(
    condition == "qanc" ~ "Quality ANC",
    condition == "ane" ~ "Anaemia",
    condition == "gdm" ~ "Gestational Diabetes",
    condition == "aph" ~ "Antepartum Hemorrhage",
    condition == "htn" ~ "Hypertension",
    TRUE ~ condition
  ))

# Filter for 'Positive change'
positive_changes_mo1 <- relative_change_combined_mo1 %>% 
  filter(rc_positive_negative_code == "Positive change")

# Find the index of the maximum percentage
max_index_mo1 <- which.max(positive_changes_mo1$percentage)

# Extract the row with the highest percentage
highest_positive_change_mo1 <- positive_changes_mo1[max_index_mo1, ]

# Extract the corresponding condition name
condition_name1_mo1 <- highest_positive_change_mo1$condition_name

# Filter for 'Negative change'
negative_changes_mo1 <- relative_change_combined_mo1 %>% 
  filter(rc_positive_negative_code == "Negative change")

# Find the index of the maximum percentage
max_index_mo1 <- which.max(negative_changes_mo1$percentage)

# Extract the row with the highest percentage
highest_negative_change_mo1 <- negative_changes_mo1[max_index_mo1, ]

# Extract the corresponding condition name
condition_name_neg_mo1 <- highest_negative_change_mo1$condition_name

# Calculate the district-wise mean percentage for pre and post test scores
district_wise_combined_mo1 <- df_mo1 |>
  group_by(district_name) |>
  summarise(mean_pre_test = mean(pre_total_correct, na.rm = TRUE) * 100 / max(pre_total_correct, na.rm = TRUE), 
            mean_post_test = mean(post_total_correct, na.rm = TRUE) * 100 / max(post_total_correct, na.rm = TRUE))

# Calculate Overall Average and add it to the data
overall_avg_mo1 <- df_mo1 |>
  summarise(mean_pre_test = mean(pre_total_correct, na.rm = TRUE) * 100 / max(pre_total_correct, na.rm = TRUE), 
            mean_post_test = mean(post_total_correct, na.rm = TRUE) * 100 / max(post_total_correct, na.rm = TRUE)) |>
  mutate(district_name = "Overall Average")

# Combine the overall average with the district-wise data
district_wise_combined_mo1 <- bind_rows(district_wise_combined_mo1, overall_avg_mo1)

# Reorder district_name factor by post-test mean percentage in descending order
district_wise_combined_mo1 <- district_wise_combined_mo1 |>
  arrange(desc(mean_post_test)) |>
  mutate(district_name = factor(district_name, levels = district_name))

# Reshape the data to long format
district_wise_combined_long_mo1 <- district_wise_combined_mo1 |>
  pivot_longer(cols = starts_with("mean_"), names_to = "test_type", values_to = "mean_percentage")

# Reorder 'test_type' factor levels to ensure 'pre' comes before 'post'
district_wise_combined_long_mo1$test_type <- factor(district_wise_combined_long_mo1$test_type, 
                                                    levels = c("mean_pre_test", "mean_post_test"),
                                                    labels = c("pre", "post"))

# Create a new column for color mapping based on test type and overall average
district_wise_combined_long_mo1 <- district_wise_combined_long_mo1 |>
  mutate(color_group = case_when(
    district_name == "Overall Average" & test_type == "pre" ~ "Overall Average Pre",
    district_name == "Overall Average" & test_type == "post" ~ "Overall Average Post",
    test_type == "pre" ~ "Pre",
    test_type == "post" ~ "Post",
    TRUE ~ "Other"
  ))


# Reorder district names based on "Post" mean percentage in descending order
district_wise_combined_long_mo1 <- district_wise_combined_long_mo1 %>%
  # Create a temporary column to store "Post" mean percentage
  dplyr::mutate(post_percentage = ifelse(color_group == "Post", mean_percentage, NA)) %>%
  # Group by district_name and get the max of post_percentage (for sorting)
  dplyr::group_by(district_name) %>%
  dplyr::mutate(post_percentage_max = max(post_percentage, na.rm = TRUE)) %>%
  # Arrange districts based on the max post_percentage in descending order
  dplyr::arrange(dplyr::desc(post_percentage_max)) %>%
  # Set district_name as a factor in the order of the arranged rows
  dplyr::mutate(district_name = factor(district_name, levels = unique(district_name))) %>%
  # Clean up the temporary columns
  dplyr::select(-post_percentage, -post_percentage_max)

# Set factor levels to ensure 'Pre' comes before 'Post' for each district
district_wise_combined_long_mo1$color_group <- factor(district_wise_combined_long_mo1$color_group, 
                                                     levels = c("Pre", "Post", "Overall Average Pre", "Overall Average Post"))

# Create the ggplot bar chart
districtwise_combined_percentage_plot_mo1 <- ggplot(district_wise_combined_long_mo1, aes(x = district_name, y = mean_percentage, fill = color_group)) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.7), width = 0.7) +
  geom_text(aes(label = round(mean_percentage, 1)), 
            position = position_dodge(width = 0.9), 
            vjust = -0.5,
            size = 3) +  # Reduce the data label size
  labs(x = "District Name",
       y = "Mean Percentage Score",
       fill = "Test Type") +  # Add legend title
  scale_fill_manual(values = c("Pre" = "coral", "Post" = "cyan3", 
                               "Overall Average Pre" = "purple", "Overall Average Post" = "blue")) +  # Different colors for Overall Average
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 10, face = "bold"),
    axis.title.x = element_text(size = 12, face = "bold"),
    axis.title.y = element_text(size = 12, face = "bold"),
    legend.title = element_text(size = 10, face = "bold"),
    legend.text = element_text(size = 9)
  )

# Save the plot in the "plots" directory
ggsave("plots/districtwise_combined_percentage_plot_mo1_1.png", 
       plot = districtwise_combined_percentage_plot_mo1, 
       width = 10, 
       height = 6, 
       dpi = 300)


####Question wise analysis

#QANC
# Assuming df has a 'condition' column and we're filtering for rows where condition is 'qanc'
df_qanc_mo1 <- subset(df_mo1, condition == "qanc")

# Calculate total_n for the filtered data
total_n_mo1 <- nrow(df_qanc_mo1)

# Create the data frame with pre and post percentages for each question
st3_qanc_mo1 <- data.frame(
  question = paste("Q", 1:10),
  qanc_pre = c(
    (sum(df_qanc_mo1$q1_pre) / total_n_mo1) * 100,
    (sum(df_qanc_mo1$q2_pre) / total_n_mo1) * 100,
    (sum(df_qanc_mo1$q3_pre) / total_n_mo1) * 100,
    (sum(df_qanc_mo1$q4_pre) / total_n_mo1) * 100,
    (sum(df_qanc_mo1$q5_pre) / total_n_mo1) * 100,
    (sum(df_qanc_mo1$q6_pre) / total_n_mo1) * 100,
    (sum(df_qanc_mo1$q7_pre) / total_n_mo1) * 100,
    (sum(df_qanc_mo1$q8_pre) / total_n_mo1) * 100,
    (sum(df_qanc_mo1$q9_pre) / total_n_mo1) * 100,
    (sum(df_qanc_mo1$q10_pre) / total_n_mo1) * 100
  ),
  qanc_post = c(
    (sum(df_qanc_mo1$q1_post) / total_n_mo1) * 100,
    (sum(df_qanc_mo1$q2_post) / total_n_mo1) * 100,
    (sum(df_qanc_mo1$q3_post) / total_n_mo1) * 100,
    (sum(df_qanc_mo1$q4_post) / total_n_mo1) * 100,
    (sum(df_qanc_mo1$q5_post) / total_n_mo1) * 100,
    (sum(df_qanc_mo1$q6_post) / total_n_mo1) * 100,
    (sum(df_qanc_mo1$q7_post) / total_n_mo1) * 100,
    (sum(df_qanc_mo1$q8_post) / total_n_mo1) * 100,
    (sum(df_qanc_mo1$q9_post) / total_n_mo1) * 100,
    (sum(df_qanc_mo1$q10_post) / total_n_mo1) * 100
  )
)

# Anaemia
df_ane_mo1 <- subset(df_mo1, condition == "ane")

# Calculate total_n for the filtered data
total_n_mo1 <- nrow(df_ane_mo1)

# Create the data frame with pre and post percentages for each question
st3_ane_mo1 <- data.frame(
  question = paste("Q", 1:10),
  ane_pre = c(
    (sum(df_ane_mo1$q1_pre) / total_n_mo1) * 100,
    (sum(df_ane_mo1$q2_pre) / total_n_mo1) * 100,
    (sum(df_ane_mo1$q3_pre) / total_n_mo1) * 100,
    (sum(df_ane_mo1$q4_pre) / total_n_mo1) * 100,
    (sum(df_ane_mo1$q5_pre) / total_n_mo1) * 100,
    (sum(df_ane_mo1$q6_pre) / total_n_mo1) * 100,
    (sum(df_ane_mo1$q7_pre) / total_n_mo1) * 100,
    (sum(df_ane_mo1$q8_pre) / total_n_mo1) * 100,
    (sum(df_ane_mo1$q9_pre) / total_n_mo1) * 100,
    (sum(df_ane_mo1$q10_pre) / total_n_mo1) * 100
  ),
  ane_post = c(
    (sum(df_ane_mo1$q1_post) / total_n_mo1) * 100,
    (sum(df_ane_mo1$q2_post) / total_n_mo1) * 100,
    (sum(df_ane_mo1$q3_post) / total_n_mo1) * 100,
    (sum(df_ane_mo1$q4_post) / total_n_mo1) * 100,
    (sum(df_ane_mo1$q5_post) / total_n_mo1) * 100,
    (sum(df_ane_mo1$q6_post) / total_n_mo1) * 100,
    (sum(df_ane_mo1$q7_post) / total_n_mo1) * 100,
    (sum(df_ane_mo1$q8_post) / total_n_mo1) * 100,
    (sum(df_ane_mo1$q9_post) / total_n_mo1) * 100,
    (sum(df_ane_mo1$q10_post) / total_n_mo1) * 100
  )
)

# Hypertension
df_htn_mo1 <- subset(df_mo1, condition == "htn")
total_n_mo1 <- nrow(df_htn_mo1)

# Create the data frame with pre and post percentages for each question
st3_htn_mo1 <- data.frame(
  question = paste("Q", 1:10),
  htn_pre = c(
    (sum(df_htn_mo1$q1_pre) / total_n_mo1) * 100,
    (sum(df_htn_mo1$q2_pre) / total_n_mo1) * 100,
    (sum(df_htn_mo1$q3_pre) / total_n_mo1) * 100,
    (sum(df_htn_mo1$q4_pre) / total_n_mo1) * 100,
    (sum(df_htn_mo1$q5_pre) / total_n_mo1) * 100,
    (sum(df_htn_mo1$q6_pre) / total_n_mo1) * 100,
    (sum(df_htn_mo1$q7_pre) / total_n_mo1) * 100,
    (sum(df_htn_mo1$q8_pre) / total_n_mo1) * 100,
    (sum(df_htn_mo1$q9_pre) / total_n_mo1) * 100,
    (sum(df_htn_mo1$q10_pre) / total_n_mo1) * 100
  ),
  htn_post = c(
    (sum(df_htn_mo1$q1_post) / total_n_mo1) * 100,
    (sum(df_htn_mo1$q2_post) / total_n_mo1) * 100,
    (sum(df_htn_mo1$q3_post) / total_n_mo1) * 100,
    (sum(df_htn_mo1$q4_post) / total_n_mo1) * 100,
    (sum(df_htn_mo1$q5_post) / total_n_mo1) * 100,
    (sum(df_htn_mo1$q6_post) / total_n_mo1) * 100,
    (sum(df_htn_mo1$q7_post) / total_n_mo1) * 100,
    (sum(df_htn_mo1$q8_post) / total_n_mo1) * 100,
    (sum(df_htn_mo1$q9_post) / total_n_mo1) * 100,
    (sum(df_htn_mo1$q10_post) / total_n_mo1) * 100
  )
)

# Gestational Diabetes
df_gdm_mo1 <- subset(df_mo1, condition == "gdm")
total_n_mo1 <- nrow(df_gdm_mo1)

# Create the data frame with pre and post percentages for each question
st3_gdm_mo1 <- data.frame(
  question = paste("Q", 1:10),
  gdm_pre = c(
    (sum(df_gdm_mo1$q1_pre) / total_n_mo1) * 100,
    (sum(df_gdm_mo1$q2_pre) / total_n_mo1) * 100,
    (sum(df_gdm_mo1$q3_pre) / total_n_mo1) * 100,
    (sum(df_gdm_mo1$q4_pre) / total_n_mo1) * 100,
    (sum(df_gdm_mo1$q5_pre) / total_n_mo1) * 100,
    (sum(df_gdm_mo1$q6_pre) / total_n_mo1) * 100,
    (sum(df_gdm_mo1$q7_pre) / total_n_mo1) * 100,
    (sum(df_gdm_mo1$q8_pre) / total_n_mo1) * 100,
    (sum(df_gdm_mo1$q9_pre) / total_n_mo1) * 100,
    (sum(df_gdm_mo1$q10_pre) / total_n_mo1) * 100
  ),
  gdm_post = c(
    (sum(df_gdm_mo1$q1_post) / total_n_mo1) * 100,
    (sum(df_gdm_mo1$q2_post) / total_n_mo1) * 100,
    (sum(df_gdm_mo1$q3_post) / total_n_mo1) * 100,
    (sum(df_gdm_mo1$q4_post) / total_n_mo1) * 100,
    (sum(df_gdm_mo1$q5_post) / total_n_mo1) * 100,
    (sum(df_gdm_mo1$q6_post) / total_n_mo1) * 100,
    (sum(df_gdm_mo1$q7_post) / total_n_mo1) * 100,
    (sum(df_gdm_mo1$q8_post) / total_n_mo1) * 100,
    (sum(df_gdm_mo1$q9_post) / total_n_mo1) * 100,
    (sum(df_gdm_mo1$q10_post) / total_n_mo1) * 100
  )
)

# Antepartum Hemorrhage
df_aph_mo1 <- subset(df_mo1, condition == "aph")
total_n_mo1 <- nrow(df_aph_mo1)

# Create the data frame with pre and post percentages for each question
st3_aph_mo1 <- data.frame(
  question = paste("Q", 1:10),
  aph_pre = c(
    (sum(df_aph_mo1$q1_pre) / total_n_mo1) * 100,
    (sum(df_aph_mo1$q2_pre) / total_n_mo1) * 100,
    (sum(df_aph_mo1$q3_pre) / total_n_mo1) * 100,
    (sum(df_aph_mo1$q4_pre) / total_n_mo1) * 100,
    (sum(df_aph_mo1$q5_pre) / total_n_mo1) * 100,
    (sum(df_aph_mo1$q6_pre) / total_n_mo1) * 100,
    (sum(df_aph_mo1$q7_pre) / total_n_mo1) * 100,
    (sum(df_aph_mo1$q8_pre) / total_n_mo1) * 100,
    (sum(df_aph_mo1$q9_pre) / total_n_mo1) * 100,
    (sum(df_aph_mo1$q10_pre) / total_n_mo1) * 100
  ),
  aph_post = c(
    (sum(df_aph_mo1$q1_post) / total_n_mo1) * 100,
    (sum(df_aph_mo1$q2_post) / total_n_mo1) * 100,
    (sum(df_aph_mo1$q3_post) / total_n_mo1) * 100,
    (sum(df_aph_mo1$q4_post) / total_n_mo1) * 100,
    (sum(df_aph_mo1$q5_post) / total_n_mo1) * 100,
    (sum(df_aph_mo1$q6_post) / total_n_mo1) * 100,
    (sum(df_aph_mo1$q7_post) / total_n_mo1) * 100,
    (sum(df_aph_mo1$q8_post) / total_n_mo1) * 100,
    (sum(df_aph_mo1$q9_post) / total_n_mo1) * 100,
    (sum(df_aph_mo1$q10_post) / total_n_mo1) * 100
  )
)


# Combine the data frames using cbind
df_questions_combined_mo1 <- cbind(
  st3_qanc_mo1[, c("question", "qanc_pre", "qanc_post")],
  st3_ane_mo1[, c("ane_pre", "ane_post")],
  st3_htn_mo1[, c("htn_pre", "htn_post")],
  st3_gdm_mo1[, c("gdm_pre", "gdm_post")],
  st3_aph_mo1[, c("aph_pre", "aph_post")]
)

# Round all percentage columns to 1 decimal place
df_questions_combined_mo1[, 2:ncol(df_questions_combined_mo1)] <- round(df_questions_combined_mo1[, 2:ncol(df_questions_combined_mo1)], 1)

# Create a gt table and apply some custom formatting
df_questions_combined_mo1_gt <- df_questions_combined_mo1 %>%
  gt() %>%
  cols_label(
    question = "Question",
    qanc_pre = "QANC Pre",
    qanc_post = "QANC Post",
    ane_pre = "ANE Pre",
    ane_post = "ANE Post",
    htn_pre = "HTN Pre",
    htn_post = "HTN Post",
    gdm_pre = "GDM Pre",
    gdm_post = "GDM Post",
    aph_pre = "APH Pre",
    aph_post = "APH Post"
  ) %>%
  tab_spanner(
    label = "Pre-Post Score Percentage ",
    columns = c("qanc_pre", "qanc_post", "ane_pre", "ane_post", 
                "htn_pre", "htn_post", "gdm_pre", "gdm_post", 
                "aph_pre", "aph_post")
  ) 
# Apply tab_style() to highlight cells with values < 50
for (col in c("qanc_pre", "qanc_post", "ane_pre", "ane_post", 
                "htn_pre", "htn_post", "gdm_pre", "gdm_post", 
                "aph_pre", "aph_post")) {
  df_questions_combined_mo1_gt <- df_questions_combined_mo1_gt %>%
    tab_style(
      style = list(
        cell_fill(color = "yellow"),  # Highlight only the specific cells
        cell_text(weight = "bold")    # Make text bold
      ),
      locations = cells_body(
        columns = col, 
        rows = df_questions_combined_mo1[[col]] < 50  # Apply condition per column
      )
    )
}
# Save the data frame to a CSV file
write.csv(df_questions_combined_mo1_gt, "tables/df_questions_combined_mo1_ts_gt_1.csv", row.names = FALSE)

```

```{r}
#| echo: false
#| warning: false
#| message: false

# Define the file paths
filepaths <- c(
  here::here('data','ts_cleaned_data','mo_cleaned_tb_ts.csv'),
  here::here('data','ts_cleaned_data','mo_cleaned_sob_ts.csv'),
  here::here('data','ts_cleaned_data','mo_cleaned_lscs_ts.csv'),
  here::here('data','ts_cleaned_data','mo_cleaned_jau_ts.csv'),
  here::here('data','ts_cleaned_data','mo_cleaned_hrt_ts.csv'),
  here::here('data','ts_cleaned_data','mo_cleaned_epi_ts.csv')
   )
# Import all files as data frames
data_frames_mo2 <- lapply(filepaths, read.csv)

# Bind all data frames into a single data frame
df_mo2 <- do.call(rbind, data_frames_mo2)

# Cleaning the data
df_mo2 <-
  df_mo2 |>
  janitor::clean_names()

# Remove unwanted columns
df_mo2 <- df_mo2 |> 
  select(-c("number",
            "name_post", 
            "age_post", 
            "entry_post", 
            "districts_post", 
            "phc_name_post", 
            "experience_post", 
            "mobile_no_post",
            "date_post"))

# Districts with district names
df_mo2$age_pre <- df_mo2$age_pre |> as.character()

# Ensure `age_pre` is numeric
df_mo2$age_pre <- as.numeric(df_mo2$age_pre)

# Current year
current_year <- as.numeric(format(Sys.Date(), "%Y"))

# Identify values in `age_pre` that are in the year format and convert them to age
df_mo2$age_pre <- ifelse(df_mo2$age_pre >= 1900 & df_mo2$age_pre <= current_year,  # Assuming any value between 1900 and the current year is a year
                     current_year - df_mo2$age_pre,  # Convert year to age
                     df_mo2$age_pre)  # Leave other values unchanged

df_mo2 <- df_mo2 %>%
  mutate(districts_number = case_when(
    districts_pre == "Adilabad" ~ 1,
    districts_pre == "Bhadradri Kothagudem" ~ 2,
    districts_pre == "Hyderabad" ~ 3,
    districts_pre == "Jagityal" ~ 4,
    districts_pre == "Jangaon" ~ 5,
    districts_pre == "Jayashankar Bhupalapally" ~ 6,
    districts_pre == "Jogulamba Gadwal" ~ 7,
    districts_pre == "Kamareddy" ~ 8,
    districts_pre == "Karimnagar" ~ 9,
    districts_pre == "Khammam" ~ 10,
    districts_pre == "Komarambheem Asifabad" ~ 11,
    districts_pre == "Mahabubabad" ~ 12,
    districts_pre == "Mahabubnagar" ~ 13,
    districts_pre == "Mancheriyal" ~ 14,
    districts_pre == "Medak" ~ 15,
    districts_pre == "Medchal Malkajgiri" ~ 16,
    districts_pre == "Mulugu" ~ 17,
    districts_pre == "Nagarkurnool" ~ 18,
    districts_pre == "Nalgonda" ~ 19,
    districts_pre == "Narayanpet" ~ 20,
    districts_pre == "Nirmal" ~ 21,
    districts_pre == "Nizamabad" ~ 22,
    districts_pre == "Peddapally" ~ 23,
    districts_pre == "Rajanna Siricilla" ~ 24,
    districts_pre == "Rangareddy" ~ 25,
    districts_pre == "Sangareddy" ~ 26,
    districts_pre == "Siddipet" ~ 27,
    districts_pre == "Suryapet" ~ 28,
    districts_pre == "Vikarabad" ~ 29,
    districts_pre == "Wanaparthy" ~ 30,
    districts_pre == "Warangal Rural" ~ 31,
    districts_pre == "Warangal Urban" ~ 32,
    districts_pre == "Yadadri Bhuvanagiri" ~ 33,
    TRUE ~ NA_integer_
  ))

# Change the district names and mutate a column with the concerned district names
df_mo2 <- df_mo2 %>%
  mutate(district_name = case_when(
    districts_number == 1 ~ "Adilabad",
    districts_number == 2 ~ "Bhadradri Kothagudem",
    districts_number == 3 ~ "Hyderabad",
    districts_number == 4 ~ "Jagtial",
    districts_number == 5 ~ "Jangaon",
    districts_number == 6 ~ "Jayashankar Bhupalpally",
    districts_number == 7 ~ "Jogulamba Gadwal",
    districts_number == 8 ~ "Kamareddy",
    districts_number == 9 ~ "Karimnagar",
    districts_number == 10 ~ "Khammam",
    districts_number == 11 ~ "Komaram Bheem Asifabad",
    districts_number == 12 ~ "Mahabubabad",
    districts_number == 13 ~ "Mahabubnagar",
    districts_number == 14 ~ "Mancherial",
    districts_number == 15 ~ "Medak",
    districts_number == 16 ~ "Medchal Malkajgiri",
    districts_number == 17 ~ "Mulugu",
    districts_number == 18 ~ "Nagarkurnool",
    districts_number == 19 ~ "Nalgonda",
    districts_number == 20 ~ "Narayanpet",
    districts_number == 21 ~ "Nirmal",
    districts_number == 22 ~ "Nizamabad",
    districts_number == 23 ~ "Peddapalli",
    districts_number == 24 ~ "Rajanna Sircilla",
    districts_number == 25 ~ "Rangareddy",
    districts_number == 26 ~ "Sangareddy",
    districts_number == 27 ~ "Siddipet",
    districts_number == 28 ~ "Suryapet",
    districts_number == 29 ~ "Vikarabad",
    districts_number == 30 ~ "Wanaparthy",
    districts_number == 31 ~ "Warangal Rural",
    districts_number == 32 ~ "Warangal Urban",
    districts_number == 33 ~ "Yadadri Bhuvanagiri",
    TRUE ~ NA_character_
  ))

# TB - Pre
df_mo2 <- df_mo2 %>%
  mutate(
    q1_pre = ifelse(condition == "tb", ifelse(q1_pre == 4, 1, 0), q1_pre),
    q2_pre = ifelse(condition == "tb", ifelse(q2_pre == 3, 1, 0), q2_pre),
    q3_pre = ifelse(condition == "tb", ifelse(q3_pre == 2, 1, 0), q3_pre),
    q4_pre = ifelse(condition == "tb", ifelse(q4_pre == 3, 1, 0), q4_pre),
    q5_pre = ifelse(condition == "tb", ifelse(q5_pre == 1, 1, 0), q5_pre),
    q6_pre = ifelse(condition == "tb", ifelse(q6_pre == 4, 1, 0), q6_pre),
    q7_pre = ifelse(condition == "tb", ifelse(q7_pre == 3, 1, 0), q7_pre),
    q8_pre = ifelse(condition == "tb", ifelse(q8_pre == 4, 1, 0), q8_pre),
    q9_pre = ifelse(condition == "tb", ifelse(q9_pre == 1, 1, 0), q9_pre),
    q10_pre = ifelse(condition == "tb", ifelse(q10_pre == 2, 1, 0), q10_pre))

# Post
df_mo2 <- df_mo2 %>%
  mutate(
    q1_post = ifelse(condition == "tb", ifelse(q1_post == 4, 1, 0), q1_post),
    q2_post = ifelse(condition == "tb", ifelse(q2_post == 3, 1, 0), q2_post),
    q3_post = ifelse(condition == "tb", ifelse(q3_post == 2, 1, 0), q3_post),
    q4_post = ifelse(condition == "tb", ifelse(q4_post == 3, 1, 0), q4_post),
    q5_post = ifelse(condition == "tb", ifelse(q5_post == 1, 1, 0), q5_post),
    q6_post = ifelse(condition == "tb", ifelse(q6_post == 4, 1, 0), q6_post),
    q7_post = ifelse(condition == "tb", ifelse(q7_post == 3, 1, 0), q7_post),
    q8_post = ifelse(condition == "tb", ifelse(q8_post == 4, 1, 0), q8_post),
    q9_post = ifelse(condition == "tb", ifelse(q9_post == 1, 1, 0), q9_post),
    q10_post = ifelse(condition == "tb", ifelse(q10_post == 2, 1, 0), q10_post))

# SOB - Pre
df_mo2 <- df_mo2 %>%
  mutate(
    q1_pre = ifelse(condition == "sob", ifelse(q1_pre == 4, 1, 0), q1_pre),
    q2_pre = ifelse(condition == "sob", ifelse(q2_pre == 3, 1, 0), q2_pre),
    q3_pre = ifelse(condition == "sob", ifelse(q3_pre == 2, 1, 0), q3_pre),
    q4_pre = ifelse(condition == "sob", ifelse(q4_pre == 4, 1, 0), q4_pre),
    q5_pre = ifelse(condition == "sob", ifelse(q5_pre == 3, 1, 0), q5_pre),
    q6_pre = ifelse(condition == "sob", ifelse(q6_pre == 4, 1, 0), q6_pre),
    q7_pre = ifelse(condition == "sob", ifelse(q7_pre == 4, 1, 0), q7_pre),
    q8_pre = ifelse(condition == "sob", ifelse(q8_pre == 4, 1, 0), q8_pre),
    q9_pre = ifelse(condition == "sob", ifelse(q9_pre == 3, 1, 0), q9_pre),
    q10_pre = ifelse(condition == "sob", ifelse(q10_pre == 4, 1, 0), q10_pre))

# Post
df_mo2 <- df_mo2 %>%
  mutate(
    q1_post = ifelse(condition == "sob", ifelse(q1_post == 4, 1, 0), q1_post),
    q2_post = ifelse(condition == "sob", ifelse(q2_post == 3, 1, 0), q2_post),
    q3_post = ifelse(condition == "sob", ifelse(q3_post == 2, 1, 0), q3_post),
    q4_post = ifelse(condition == "sob", ifelse(q4_post == 4, 1, 0), q4_post),
    q5_post = ifelse(condition == "sob", ifelse(q5_post == 3, 1, 0), q5_post),
    q6_post = ifelse(condition == "sob", ifelse(q6_post == 4, 1, 0), q6_post),
    q7_post = ifelse(condition == "sob", ifelse(q7_post == 4, 1, 0), q7_post),
    q8_post = ifelse(condition == "sob", ifelse(q8_post == 4, 1, 0), q8_post),
    q9_post = ifelse(condition == "sob", ifelse(q9_post == 3, 1, 0), q9_post),
    q10_post = ifelse(condition == "sob", ifelse(q10_post == 4, 1, 0), q10_post))

#LSCS-
# Pre
df_mo2 <- df_mo2 %>%
  mutate(
    q1_pre = ifelse(condition == "lscs", ifelse(q1_pre == 4, 1, 0), q1_pre),
    q2_pre = ifelse(condition == "lscs", ifelse(q2_pre == 4, 1, 0), q2_pre),
    q3_pre = ifelse(condition == "lscs", ifelse(q3_pre == 3, 1, 0), q3_pre),
    q4_pre = ifelse(condition == "lscs", ifelse(q4_pre == 3, 1, 0), q4_pre),
    q5_pre = ifelse(condition == "lscs", ifelse(q5_pre == 1, 1, 0), q5_pre),
    q6_pre = ifelse(condition == "lscs", ifelse(q6_pre == 2, 1, 0), q6_pre),
    q7_pre = ifelse(condition == "lscs", ifelse(q7_pre == 4, 1, 0), q7_pre),
    q8_pre = ifelse(condition == "lscs", ifelse(q8_pre == 3, 1, 0), q8_pre),
    q9_pre = ifelse(condition == "lscs", ifelse(q9_pre == 1, 1, 0), q9_pre),
    q10_pre = ifelse(condition == "lscs", ifelse(q10_pre == 4, 1, 0), q10_pre))

# Post
df_mo2 <- df_mo2 %>%
  mutate(
    q1_post = ifelse(condition == "lscs", ifelse(q1_post == 4, 1, 0), q1_post),
    q2_post = ifelse(condition == "lscs", ifelse(q2_post == 4, 1, 0), q2_post),
    q3_post = ifelse(condition == "lscs", ifelse(q3_post == 3, 1, 0), q3_post),
    q4_post = ifelse(condition == "lscs", ifelse(q4_post == 3, 1, 0), q4_post),
    q5_post = ifelse(condition == "lscs", ifelse(q5_post == 1, 1, 0), q5_post),
    q6_post = ifelse(condition == "lscs", ifelse(q6_post == 2, 1, 0), q6_post),
    q7_post = ifelse(condition == "lscs", ifelse(q7_post == 4, 1, 0), q7_post),
    q8_post = ifelse(condition == "lscs", ifelse(q8_post == 3, 1, 0), q8_post),
    q9_post = ifelse(condition == "lscs", ifelse(q9_post == 1, 1, 0), q9_post),
    q10_post = ifelse(condition == "lscs", ifelse(q10_post == 4, 1, 0), q10_post))

#JAU-
# Pre
df_mo2 <- df_mo2 %>%
  mutate(
    q1_pre = ifelse(condition == "jau", ifelse(q1_pre == 2, 1, 0), q1_pre),
    q2_pre = ifelse(condition == "jau", ifelse(q2_pre == 1, 1, 0), q2_pre),
    q3_pre = ifelse(condition == "jau", ifelse(q3_pre == 4, 1, 0), q3_pre),
    q4_pre = ifelse(condition == "jau", ifelse(q4_pre == 3, 1, 0), q4_pre),
    q5_pre = ifelse(condition == "jau", ifelse(q5_pre == 3, 1, 0), q5_pre),
    q6_pre = ifelse(condition == "jau", ifelse(q6_pre == 4, 1, 0), q6_pre),
    q7_pre = ifelse(condition == "jau", ifelse(q7_pre == 3, 1, 0), q7_pre),
    q8_pre = ifelse(condition == "jau", ifelse(q8_pre == 4, 1, 0), q8_pre),
    q9_pre = ifelse(condition == "jau", ifelse(q9_pre == 4, 1, 0), q9_pre),
    q10_pre = ifelse(condition == "jau", ifelse(q10_pre == 3, 1, 0), q10_pre))

# Post
df_mo2 <- df_mo2 %>%
  mutate(
    q1_post = ifelse(condition == "jau", ifelse(q1_post == 2, 1, 0), q1_post),
    q2_post = ifelse(condition == "jau", ifelse(q2_post == 1, 1, 0), q2_post),
    q3_post = ifelse(condition == "jau", ifelse(q3_post == 4, 1, 0), q3_post),
    q4_post = ifelse(condition == "jau", ifelse(q4_post == 3, 1, 0), q4_post),
    q5_post = ifelse(condition == "jau", ifelse(q5_post == 3, 1, 0), q5_post),
    q6_post = ifelse(condition == "jau", ifelse(q6_post == 4, 1, 0), q6_post),
    q7_post = ifelse(condition == "jau", ifelse(q7_post == 3, 1, 0), q7_post),
    q8_post = ifelse(condition == "jau", ifelse(q8_post == 4, 1, 0), q8_post),
    q9_post = ifelse(condition == "jau", ifelse(q9_post == 4, 1, 0), q9_post),
    q10_post = ifelse(condition == "jau", ifelse(q10_post == 3, 1, 0), q10_post))

#HRT-
# Pre
df_mo2 <- df_mo2 %>%
  mutate(
    q1_pre = ifelse(condition == "hrt", ifelse(q1_pre == 3, 1, 0), q1_pre),
    q2_pre = ifelse(condition == "hrt", ifelse(q2_pre == 3, 1, 0), q2_pre),
    q3_pre = ifelse(condition == "hrt", ifelse(q3_pre == 2, 1, 0), q3_pre),
    q4_pre = ifelse(condition == "hrt", ifelse(q4_pre == 3, 1, 0), q4_pre),
    q5_pre = ifelse(condition == "hrt", ifelse(q5_pre == 3, 1, 0), q5_pre),
    q6_pre = ifelse(condition == "hrt", ifelse(q6_pre == 4, 1, 0), q6_pre),
    q7_pre = ifelse(condition == "hrt", ifelse(q7_pre == 1, 1, 0), q7_pre),
    q8_pre = ifelse(condition == "hrt", ifelse(q8_pre == 4, 1, 0), q8_pre),
    q9_pre = ifelse(condition == "hrt", ifelse(q9_pre == 3, 1, 0), q9_pre),
    q10_pre = ifelse(condition == "hrt", ifelse(q10_pre == 2, 1, 0), q10_pre))

# Post
df_mo2 <- df_mo2 %>%
  mutate(
    q1_post = ifelse(condition == "hrt", ifelse(q1_post == 3, 1, 0), q1_post),
    q2_post = ifelse(condition == "hrt", ifelse(q2_post == 3, 1, 0), q2_post),
    q3_post = ifelse(condition == "hrt", ifelse(q3_post == 2, 1, 0), q3_post),
    q4_post = ifelse(condition == "hrt", ifelse(q4_post == 3, 1, 0), q4_post),
    q5_post = ifelse(condition == "hrt", ifelse(q5_post == 3, 1, 0), q5_post),
    q6_post = ifelse(condition == "hrt", ifelse(q6_post == 4, 1, 0), q6_post),
    q7_post = ifelse(condition == "hrt", ifelse(q7_post == 1, 1, 0), q7_post),
    q8_post = ifelse(condition == "hrt", ifelse(q8_post == 4, 1, 0), q8_post),
    q9_post = ifelse(condition == "hrt", ifelse(q9_post == 3, 1, 0), q9_post),
    q10_post = ifelse(condition == "hrt", ifelse(q10_post == 2, 1, 0), q10_post))

#EPI-
# Pre
df_mo2 <- df_mo2 %>%
  mutate(
    q1_pre = ifelse(condition == "epi", ifelse(q1_pre == 3, 1, 0), q1_pre),
    q2_pre = ifelse(condition == "epi", ifelse(q2_pre == 4, 1, 0), q2_pre),
    q3_pre = ifelse(condition == "epi", ifelse(q3_pre == 4, 1, 0), q3_pre),
    q4_pre = ifelse(condition == "epi", ifelse(q4_pre == 2, 1, 0), q4_pre),
    q5_pre = ifelse(condition == "epi", ifelse(q5_pre == 4, 1, 0), q5_pre),
    q6_pre = ifelse(condition == "epi", ifelse(q6_pre == 4, 1, 0), q6_pre),
    q7_pre = ifelse(condition == "epi", ifelse(q7_pre == 2, 1, 0), q7_pre),
    q8_pre = ifelse(condition == "epi", ifelse(q8_pre == 3, 1, 0), q8_pre),
    q9_pre = ifelse(condition == "epi", ifelse(q9_pre == 4, 1, 0), q9_pre),
    q10_pre = ifelse(condition == "epi", ifelse(q10_pre == 2, 1, 0), q10_pre))

# Post
df_mo2 <- df_mo2 %>%
  mutate(
    q1_post = ifelse(condition == "epi", ifelse(q1_post == 3, 1, 0), q1_post),
    q2_post = ifelse(condition == "epi", ifelse(q2_post == 4, 1, 0), q2_post),
    q3_post = ifelse(condition == "epi", ifelse(q3_post == 4, 1, 0), q3_post),
    q4_post = ifelse(condition == "epi", ifelse(q4_post == 2, 1, 0), q4_post),
    q5_post = ifelse(condition == "epi", ifelse(q5_post == 4, 1, 0), q5_post),
    q6_post = ifelse(condition == "epi", ifelse(q6_post == 4, 1, 0), q6_post),
    q7_post = ifelse(condition == "epi", ifelse(q7_post == 2, 1, 0), q7_post),
    q8_post = ifelse(condition == "epi", ifelse(q8_post == 3, 1, 0), q8_post),
    q9_post = ifelse(condition == "epi", ifelse(q9_post == 4, 1, 0), q9_post),
    q10_post = ifelse(condition == "epi", ifelse(q10_post == 2, 1, 0), q10_post))


#Sum of Pre and post total correct scores

df_mo2 <- df_mo2 %>%
  mutate(
    pre_total_correct = rowSums(select(., starts_with("q") & ends_with("pre"))),
    post_total_correct = rowSums(select(., starts_with("q") & ends_with("post")))
  )

df_mo2 <- df_mo2 |> 
  mutate(relative_change = post_total_correct - pre_total_correct)

#Adding relative change column and creating code for the same

df_mo2 <- df_mo2 %>%
  mutate(rc_code = case_when(
    relative_change == 0 ~ "No Change",
    relative_change %in% c(-1, -2) ~ "-1 to -2",
    relative_change %in% c(1, 2) ~ "1 to 2",
    relative_change >= 3 ~ "+3 and above",
    relative_change <= -3 ~ "-3 and below",
    TRUE ~ NA_character_  # Ensure that the NA type is character to match the other outcomes
  ))

df_mo2 <- df_mo2 %>%
  mutate(rc_positive_negative_code = case_when(
    relative_change == 0 ~ "No Change",
    relative_change %in% c(-1, -2) ~ "Negative change",
    relative_change %in% c(1, 2) ~ "Positive change",
    relative_change >= 3 ~ "Positive change",
    relative_change <= -3 ~ "Negative change",
    TRUE ~ NA_character_  # Ensure that the NA type is character to match the other outcomes
  ))

# Create summary statistics grouped by district_name and condition
sta1_mo2 <- df_mo2 %>%
  group_by(district_name, condition) %>%
  summarise(
    pre_mean = round(mean(pre_total_correct, na.rm = TRUE), 1),
    pre_std = round(sd(pre_total_correct, na.rm = TRUE), 1),
    pre_mean_pct = round((mean(pre_total_correct, na.rm = TRUE) / 10) * 100, 1),  # Pre-test percentage
    post_mean = round(mean(post_total_correct, na.rm = TRUE), 1),
    post_std = round(sd(post_total_correct, na.rm = TRUE), 1),
    post_mean_pct = round((mean(post_total_correct, na.rm = TRUE) / 10) * 100, 1),  # Post-test percentage
    p_value = ifelse(
      sum(!is.na(pre_total_correct)) > 1 & sum(!is.na(post_total_correct)) > 1, 
      round(t.test(pre_total_correct, post_total_correct)$p.value, 6), 
      NA )
  )

# Calculate state average (overall mean, std, and percentage grouped by condition)
state_avg_mo2 <- df_mo2 %>%
  group_by(condition) %>%
  summarise(
    pre_mean = round(mean(pre_total_correct, na.rm = TRUE), 1),
    pre_std = round(sd(pre_total_correct, na.rm = TRUE), 1),
    pre_mean_pct = round((mean(pre_total_correct, na.rm = TRUE) / 10) * 100, 1),  # Pre-test percentage
    post_mean = round(mean(post_total_correct, na.rm = TRUE), 1),
    post_std = round(sd(post_total_correct, na.rm = TRUE), 1),
    post_mean_pct = round((mean(post_total_correct, na.rm = TRUE) / 10) * 100, 1)  # Post-test percentage
  ) %>%
  mutate(district_name = "Overall Average")  # Add state average label

# Combine district-level and state-level data
sta1_mo2 <- bind_rows(sta1_mo2, state_avg_mo2)

# Save sta1 as a CSV file
write.csv(sta1_mo2, "tables/sta1_summary_mo2_ts_2.csv", row.names = FALSE)

# Overall mean, std, and percentage grouped by condition
sta2_mo2 <- df_mo2 %>%
  group_by(condition) %>%
  summarise(
    n = n(),  # Count of rows for each condition
    pre_mean = round(mean(pre_total_correct, na.rm = TRUE), 1),
    pre_std = round(sd(pre_total_correct, na.rm = TRUE), 1),
    pre_mean_pct = round((mean(pre_total_correct, na.rm = TRUE) / 10) * 100, 1),  # Pre-test percentage
    post_mean = round(mean(post_total_correct, na.rm = TRUE), 1),
    post_std = round(sd(post_total_correct, na.rm = TRUE), 1),
    post_mean_pct = round((mean(post_total_correct, na.rm = TRUE) / 10) * 100, 1)  # Post-test percentage
  )

# Calculate state average (same as above)
state_avg_mo2 <- df_mo2 %>%
  summarise(
    pre_mean = round(mean(pre_total_correct, na.rm = TRUE), 1),
    pre_std = round(sd(pre_total_correct, na.rm = TRUE), 1),
    pre_mean_pct = round((mean(pre_total_correct, na.rm = TRUE) / 10) * 100, 1),  # Pre-test percentage
    post_mean = round(mean(post_total_correct, na.rm = TRUE), 1),
    post_std = round(sd(post_total_correct, na.rm = TRUE), 1),
    post_mean_pct = round((mean(post_total_correct, na.rm = TRUE) / 10) * 100, 1)  # Post-test percentage
  ) %>%
  mutate(condition = "Overall Average")  # Add state average label

# Combine condition-level and state-level data
sta2_mo2 <- bind_rows(sta2_mo2, state_avg_mo2)

# Save sta2 as a CSV file
write.csv(sta2_mo2, "tables/sta2_summary_mo2_ts_2.csv", row.names = FALSE)

# Reorder condition factor based on post-test mean percentage in descending order
sta2_mo2 <- sta2_mo2 %>%
  arrange(desc(post_mean_pct)) %>%
  mutate(condition = factor(condition, levels = condition))

# Reshape the data from wide to long format using tidyr's pivot_longer
sta2_long_mo2 <- tidyr::pivot_longer(sta2_mo2, 
                                 cols = c("pre_mean_pct", "post_mean_pct"), 
                                 names_to = "Time", 
                                 values_to = "Mean_Pct")


# Calculate the gain in knowledge for each condition
knowledge_gain_mo2 <- sta2_mo2 %>%
  mutate(Gain = post_mean_pct - pre_mean_pct) %>%
  select(condition, Gain)

# Reorder 'Time' factor levels to ensure 'pre' comes before 'post'
sta2_long_mo2$Time <- factor(sta2_long_mo2$Time, levels = c("pre_mean_pct", "post_mean_pct"))

# Combine data for all conditions
relative_change_combined_mo2 <- df_mo2 %>%
  count(condition, rc_positive_negative_code) %>%  # Count occurrences for each condition and change type
  group_by(condition) %>%  # Group by condition
  mutate(percentage = n / sum(n) * 100)  # Calculate percentage

# Reorder 'condition' based on descending percentage of "Positive change"
positive_order_mo2 <- relative_change_combined_mo2 %>%
  filter(rc_positive_negative_code == "Positive change") %>%
  arrange(percentage) %>%  # Sort in ascending order
  pull(condition)  # Extract the ordered conditions

relative_change_combined_mo2 <- relative_change_combined_mo2 %>%
  mutate(condition = factor(condition, levels = positive_order_mo2))  # Reorder factor levels


# Replace condition abbreviations with full names
sta2_mo2 <- sta2_mo2 %>%
  mutate(condition_name = case_when(
    condition == "tb" ~ "Tuberculosis",
    condition == "sob" ~ "Shortness of Breath",
    condition == "lscs" ~ "Lower Segment Caesarean Section",
    condition == "jau" ~ "Jaundice",
    condition == "hrt" ~ "Heart Disease",
    condition == "epi" ~ "Epilepsy",
    TRUE ~ condition  # Keep other values unchanged (if any)
  ))

#Map - Trainings happening in districts

library(sf)

# Load the GeoJSON file
telangana_sf_mo2 <- st_read(here::here("data", "ts_cleaned_data", "telangana.json"), quiet = TRUE)

# Create district responses from your dataset (df)
#Pull number of responses
district_responses_mo2 <- df_mo2 %>%
  group_by(district_name) %>%
  summarise(no_of_responses = n())

# Mutate the District column in telangana_sf to match district_responses
telangana_sf_mo2 <- telangana_sf_mo2 %>%
  mutate(district_name = case_when(
    District == "ADILABAD" ~ "Adilabad",
    District == "BHADRADRI KOTHAGUDEM" ~ "Bhadradri Kothagudem",
    District == "HYDERABAD" ~ "Hyderabad",
    District == "JAGTIAL" ~ "Jagtial",
    District == "JANGAON" ~ "Jangaon",
    District == "JAYASHANKAR BHUPALAPALLY" ~ "Jayashankar Bhupalpally",
    District == "JOGULAMBA GADWAL" ~ "Jogulamba Gadwal",
    District == "KAMAREDDY" ~ "Kamareddy",
    District == "KARIMNAGAR" ~ "Karimnagar",
    District == "KHAMMAM" ~ "Khammam",
    District == "KUMURAM BHEEM" ~ "Komaram Bheem Asifabad",
    District == "MAHABUBABAD" ~ "Mahabubabad",
    District == "MAHABUBNAGAR" ~ "Mahabubnagar",
    District == "MANCHERIAL" ~ "Mancherial",
    District == "MEDAK" ~ "Medak",
    District == "MEDCHAL-MALKAJGIRI" ~ "Medchal Malkajgiri",
    District == "MULUGU" ~ "Mulugu",
    District == "NAGARKURNOOL" ~ "Nagarkurnool",
    District == "NALGONDA" ~ "Nalgonda",
    District == "NARAYANPET" ~ "Narayanpet",
    District == "NIRMAL" ~ "Nirmal",
    District == "NIZAMABAD" ~ "Nizamabad",
    District == "PEDDAPALLI" ~ "Peddapalli",
    District == "RANJANNA SIRCILLA" ~ "Rajanna Sircilla",
    District == "RANGAREDDY" ~ "Rangareddy",
    District == "SANGAREDDY" ~ "Sangareddy",
    District == "SIDDIPET" ~ "Siddipet",
    District == "SURYAPET" ~ "Suryapet",
    District == "VIKARABAD" ~ "Vikarabad",
    District == "WANAPARTHY" ~ "Wanaparthy",
    District == "WARANGAL (RURAL)" ~ "Warangal Rural",
    District == "WARANGAL (URBAN)" ~ "Warangal Urban",
    District == "YADADRI BHUVANAGIRI" ~ "Yadadri Bhuvanagiri",
    TRUE ~ District  # Keep original value if no match
  ))

# Join the standardized district_responses with telangana_sf
merged_tg_sf_mo2 <- telangana_sf_mo2 %>%
  left_join(district_responses_mo2, by = "district_name")

# Identify districts with responses
merged_tg_sf_mo2 <- merged_tg_sf_mo2 %>%
  mutate(map = ifelse(!is.na(no_of_responses), 1, 0))

# Plot the map
telangana_map_plot_mo2 <- ggplot(merged_tg_sf_mo2) +
  geom_sf(aes(fill = factor(map)), color = "black") +
  scale_fill_manual(values = c("0" = "grey90", "1" = "lightgreen")) +
  geom_sf_text(data = merged_tg_sf_mo2 %>% filter(map == 1), aes(label = District), size = 3) + 
  theme_void() +
  theme(legend.position = "none")

# Save the plot in the "images" folder using ggsave
ggsave("plots/telangana_map_plot_mo2_2.png", plot = telangana_map_plot_mo2, width = 8, height = 6, dpi = 300)


# Create a new column to differentiate the state average from other conditions
sta2_long_mo2 <- sta2_long_mo2 %>%
  mutate(state_avg = ifelse(condition == "Overall Average", "Overall Average", "Conditions"))

# Create the ggplot bar chart with adjustments for spacing and legibility
pre_post_mean_pct_mo2 <- ggplot(sta2_long_mo2, aes(x = condition, y = Mean_Pct, fill = interaction(Time, state_avg))) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.8), width = 0.7) +  # Increase spacing
  scale_fill_manual(values = c("pre_mean_pct.Conditions" = "blue", 
                               "post_mean_pct.Conditions" = "orange",
                               "pre_mean_pct.Overall Average" = "lightskyblue", 
                               "post_mean_pct.Overall Average" = "lightgreen")) +
  geom_text(aes(label = round(Mean_Pct, 1)), 
            position = position_dodge(width = 0.8),  # Adjust text position to align with the new dodge width
            vjust = -0.5) +  # Adjust label position
  labs(x = "Condition", y = "Mean %") +
  theme_minimal() +
  theme(
    legend.title = element_blank(),
    axis.text.x = element_text(size = 12, face = "bold", angle = 45, hjust = 1),  # Rotate axis labels for better legibility
    axis.title.x = element_text(size = 14, face = "bold"),
    plot.margin = margin(10, 20, 10, 20),  # Add space around the plot
    panel.grid.major.x = element_blank(),  # Optional: remove vertical grid lines for clarity
    panel.grid.minor.x = element_blank()
  ) +
  # Add gain in knowledge as annotations below the x-axis labels
  annotate("text", 
           x = knowledge_gain_mo2$condition, 
           y = -5,  # Position slightly below the x-axis
           label = paste0(round(knowledge_gain_mo2$Gain, 1), "%"),
           size = 3.5, 
           color = "red")

# Save the plot in the "plots" directory
ggsave("plots/pre_post_mean_pct_mo2_2.png", 
       plot = pre_post_mean_pct_mo2, 
       width = 10, 
       height = 6, 
       dpi = 300)


# Create the plot object
plot_relative_change_mo2 <- ggplot(relative_change_combined_mo2, aes(x = percentage, y = condition, fill = rc_positive_negative_code)) +
  geom_bar(stat = "identity", position = "dodge", width = 0.7) +
  geom_text(aes(label = sprintf("%.1f%%", percentage)), 
            position = position_dodge(width = 0.9), 
            hjust = -0.2, 
            size = 3) +
  labs(x = "Percentage (%)", y = "Condition") +
  scale_fill_manual(values = c("Positive change" = "darkgreen", 
                               "Negative change" = "red", 
                               "No Change" = "orange")) +
  scale_x_continuous(expand = expansion(mult = c(0, 0.1))) +
  theme_minimal(base_size = 12) +
  theme(
    axis.text.y = element_text(size = 10),
    axis.text.x = element_text(size = 10),
    axis.title.x = element_text(size = 12, face = "bold"),
    axis.title.y = element_text(size = 12, face = "bold"),
    plot.title = element_text(size = 14, face = "bold", hjust = 0.5),
    legend.title = element_blank(),
    legend.text = element_text(size = 10)
  )

# Save the plot in the "plots" directory
ggsave("plots/plot_relative_change_mo2_2.png", 
       plot = plot_relative_change_mo2, 
       width = 10, 
       height = 6, 
       dpi = 300)


# Add condition names
relative_change_combined_mo2 <- relative_change_combined_mo2 %>%
  mutate(condition_name = case_when(
    condition == "tb" ~ "Tuberculosis",
    condition == "sob" ~ "Shortness of Breath",
    condition == "lscs" ~ "Lower Segment Caesarean Section",
    condition == "jau" ~ "Jaundice",
    condition == "hrt" ~ "Heart Disease",
    condition == "epi" ~ "Epilepsy",
    TRUE ~ condition
  ))

# Filter for 'Positive change'
positive_changes_mo2 <- relative_change_combined_mo2 %>% 
  filter(rc_positive_negative_code == "Positive change")

# Find the index of the maximum percentage
max_index_mo2 <- which.max(positive_changes_mo2$percentage)

# Extract the row with the highest percentage
highest_positive_change_mo2 <- positive_changes_mo2[max_index_mo2, ]

# Extract the corresponding condition name
condition_name1_mo2 <- highest_positive_change_mo2$condition_name

# Filter for 'Negative change'
negative_changes_mo2 <- relative_change_combined_mo2 %>% 
  filter(rc_positive_negative_code == "Negative change")

# Find the index of the maximum percentage
max_index_mo2 <- which.max(negative_changes_mo2$percentage)

# Extract the row with the highest percentage
highest_negative_change_mo2 <- negative_changes_mo2[max_index_mo2, ]

# Extract the corresponding condition name
condition_name_neg_mo2 <- highest_negative_change_mo2$condition_name


# Calculate the district-wise mean percentage for pre and post test scores
district_wise_combined_mo2 <- df_mo2 |>
  group_by(district_name) |>
  summarise(mean_pre_test = mean(pre_total_correct, na.rm = TRUE) * 100 / max(pre_total_correct, na.rm = TRUE), 
            mean_post_test = mean(post_total_correct, na.rm = TRUE) * 100 / max(post_total_correct, na.rm = TRUE))

# Calculate Overall Average and add it to the data
overall_avg_mo2 <- df_mo2 |>
  summarise(mean_pre_test = mean(pre_total_correct, na.rm = TRUE) * 100 / max(pre_total_correct, na.rm = TRUE), 
            mean_post_test = mean(post_total_correct, na.rm = TRUE) * 100 / max(post_total_correct, na.rm = TRUE)) |>
  mutate(district_name = "Overall Average")

# Combine the overall average with the district-wise data
district_wise_combined_mo2 <- bind_rows(district_wise_combined_mo2, overall_avg_mo2)

# Reorder district_name factor by post-test mean percentage in descending order
district_wise_combined_mo2 <- district_wise_combined_mo2 |>
  arrange(desc(mean_post_test)) |>
  mutate(district_name = factor(district_name, levels = district_name))

# Reshape the data to long format
district_wise_combined_long_mo2 <- district_wise_combined_mo2 |>
  pivot_longer(cols = starts_with("mean_"), names_to = "test_type", values_to = "mean_percentage")

# Reorder 'test_type' factor levels to ensure 'pre' comes before 'post'
district_wise_combined_long_mo2$test_type <- factor(district_wise_combined_long_mo2$test_type, 
                                                levels = c("mean_pre_test", "mean_post_test"),
                                                labels = c("pre", "post"))

# Create a new column for color mapping based on test type and overall average
district_wise_combined_long_mo2 <- district_wise_combined_long_mo2 |>
  mutate(color_group = case_when(
    district_name == "Overall Average" & test_type == "pre" ~ "Overall Average Pre",
    district_name == "Overall Average" & test_type == "post" ~ "Overall Average Post",
    test_type == "pre" ~ "Pre",
    test_type == "post" ~ "Post",
    TRUE ~ "Other"
  ))


# Reorder district names based on "Post" mean percentage in descending order
district_wise_combined_long_mo2 <- district_wise_combined_long_mo2 %>%
  # Create a temporary column to store "Post" mean percentage
  dplyr::mutate(post_percentage = ifelse(color_group == "Post", mean_percentage, NA)) %>%
  # Group by district_name and get the max of post_percentage (for sorting)
  dplyr::group_by(district_name) %>%
  dplyr::mutate(post_percentage_max = max(post_percentage, na.rm = TRUE)) %>%
  # Arrange districts based on the max post_percentage in descending order
  dplyr::arrange(dplyr::desc(post_percentage_max)) %>%
  # Set district_name as a factor in the order of the arranged rows
  dplyr::mutate(district_name = factor(district_name, levels = unique(district_name))) %>%
  # Clean up the temporary columns
  dplyr::select(-post_percentage, -post_percentage_max)

# Set factor levels to ensure 'Pre' comes before 'Post' for each district
district_wise_combined_long_mo2$color_group <- factor(district_wise_combined_long_mo2$color_group, 
                                                     levels = c("Pre", "Post", "Overall Average Pre", "Overall Average Post"))

# Create the ggplot bar chart
districtwise_combined_percentage_plot_mo2 <- ggplot(district_wise_combined_long_mo2, aes(x = district_name, y = mean_percentage, fill = color_group)) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.7), width = 0.7) +
  geom_text(aes(label = round(mean_percentage, 1)), 
            position = position_dodge(width = 0.9), 
            vjust = -0.5,
            size = 3) +  # Reduce the data label size
  labs(x = "District Name",
       y = "Mean Percentage Score",
       fill = "Test Type") +  # Add legend title
  scale_fill_manual(values = c("Pre" = "coral", "Post" = "cyan3", 
                               "Overall Average Pre" = "purple", "Overall Average Post" = "blue")) +  # Different colors for Overall Average
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 10, face = "bold"),
    axis.title.x = element_text(size = 12, face = "bold"),
    axis.title.y = element_text(size = 12, face = "bold"),
    legend.title = element_text(size = 10, face = "bold"),
    legend.text = element_text(size = 9)
  )

# Save the plot in the "plots" directory
ggsave("plots/districtwise_combined_percentage_plot_mo2_2.png", 
       plot = districtwise_combined_percentage_plot_mo2, 
       width = 10, 
       height = 6, 
       dpi = 300)


####Question wise analysis

# Create the data frame with pre and post percentages for each question
# TB
# Assuming df has a 'condition' column and we're filtering for rows where condition is 'tb'
# TB
df_tb_mo2 <- subset(df_mo2, condition == "tb")

# Calculate total_n for the filtered data
total_n_mo2 <- nrow(df_tb_mo2)

# Create the data frame with pre and post percentages for each question
st3_tb_mo2 <- data.frame(
  question = paste("Q", 1:10),
  tb_pre = c(
    (sum(df_tb_mo2$q1_pre) / total_n_mo2) * 100,
    (sum(df_tb_mo2$q2_pre) / total_n_mo2) * 100,
    (sum(df_tb_mo2$q3_pre) / total_n_mo2) * 100,
    (sum(df_tb_mo2$q4_pre) / total_n_mo2) * 100,
    (sum(df_tb_mo2$q5_pre) / total_n_mo2) * 100,
    (sum(df_tb_mo2$q6_pre) / total_n_mo2) * 100,
    (sum(df_tb_mo2$q7_pre) / total_n_mo2) * 100,
    (sum(df_tb_mo2$q8_pre) / total_n_mo2) * 100,
    (sum(df_tb_mo2$q9_pre) / total_n_mo2) * 100,
    (sum(df_tb_mo2$q10_pre) / total_n_mo2) * 100
  ),
  tb_post = c(
    (sum(df_tb_mo2$q1_post) / total_n_mo2) * 100,
    (sum(df_tb_mo2$q2_post) / total_n_mo2) * 100,
    (sum(df_tb_mo2$q3_post) / total_n_mo2) * 100,
    (sum(df_tb_mo2$q4_post) / total_n_mo2) * 100,
    (sum(df_tb_mo2$q5_post) / total_n_mo2) * 100,
    (sum(df_tb_mo2$q6_post) / total_n_mo2) * 100,
    (sum(df_tb_mo2$q7_post) / total_n_mo2) * 100,
    (sum(df_tb_mo2$q8_post) / total_n_mo2) * 100,
    (sum(df_tb_mo2$q9_post) / total_n_mo2) * 100,
    (sum(df_tb_mo2$q10_post) / total_n_mo2) * 100
  )
)

# SOB
df_sob_mo2 <- subset(df_mo2, condition == "sob")

# Calculate total_n for the filtered data
total_n_mo2 <- nrow(df_sob_mo2)

# Create the data frame with pre and post percentages for each question
st3_sob_mo2 <- data.frame(
  question = paste("Q", 1:10),
  sob_pre = c(
    (sum(df_sob_mo2$q1_pre) / total_n_mo2) * 100,
    (sum(df_sob_mo2$q2_pre) / total_n_mo2) * 100,
    (sum(df_sob_mo2$q3_pre) / total_n_mo2) * 100,
    (sum(df_sob_mo2$q4_pre) / total_n_mo2) * 100,
    (sum(df_sob_mo2$q5_pre) / total_n_mo2) * 100,
    (sum(df_sob_mo2$q6_pre) / total_n_mo2) * 100,
    (sum(df_sob_mo2$q7_pre) / total_n_mo2) * 100,
    (sum(df_sob_mo2$q8_pre) / total_n_mo2) * 100,
    (sum(df_sob_mo2$q9_pre) / total_n_mo2) * 100,
    (sum(df_sob_mo2$q10_pre) / total_n_mo2) * 100
  ),
  sob_post = c(
    (sum(df_sob_mo2$q1_post) / total_n_mo2) * 100,
    (sum(df_sob_mo2$q2_post) / total_n_mo2) * 100,
    (sum(df_sob_mo2$q3_post) / total_n_mo2) * 100,
    (sum(df_sob_mo2$q4_post) / total_n_mo2) * 100,
    (sum(df_sob_mo2$q5_post) / total_n_mo2) * 100,
    (sum(df_sob_mo2$q6_post) / total_n_mo2) * 100,
    (sum(df_sob_mo2$q7_post) / total_n_mo2) * 100,
    (sum(df_sob_mo2$q8_post) / total_n_mo2) * 100,
    (sum(df_sob_mo2$q9_post) / total_n_mo2) * 100,
    (sum(df_sob_mo2$q10_post) / total_n_mo2) * 100
  )
)

# LSCS
df_lscs_mo2 <- subset(df_mo2, condition == "lscs")

# Calculate total_n for the filtered data
total_n_mo2 <- nrow(df_lscs_mo2)

# Create the data frame with pre and post percentages for each question
st3_lscs_mo2 <- data.frame(
  question = paste("Q", 1:10),
  lscs_pre = c(
    (sum(df_lscs_mo2$q1_pre) / total_n_mo2) * 100,
    (sum(df_lscs_mo2$q2_pre) / total_n_mo2) * 100,
    (sum(df_lscs_mo2$q3_pre) / total_n_mo2) * 100,
    (sum(df_lscs_mo2$q4_pre) / total_n_mo2) * 100,
    (sum(df_lscs_mo2$q5_pre) / total_n_mo2) * 100,
    (sum(df_lscs_mo2$q6_pre) / total_n_mo2) * 100,
    (sum(df_lscs_mo2$q7_pre) / total_n_mo2) * 100,
    (sum(df_lscs_mo2$q8_pre) / total_n_mo2) * 100,
    (sum(df_lscs_mo2$q9_pre) / total_n_mo2) * 100,
    (sum(df_lscs_mo2$q10_pre) / total_n_mo2) * 100
  ),
  lscs_post = c(
    (sum(df_lscs_mo2$q1_post) / total_n_mo2) * 100,
    (sum(df_lscs_mo2$q2_post) / total_n_mo2) * 100,
    (sum(df_lscs_mo2$q3_post) / total_n_mo2) * 100,
    (sum(df_lscs_mo2$q4_post) / total_n_mo2) * 100,
    (sum(df_lscs_mo2$q5_post) / total_n_mo2) * 100,
    (sum(df_lscs_mo2$q6_post) / total_n_mo2) * 100,
    (sum(df_lscs_mo2$q7_post) / total_n_mo2) * 100,
    (sum(df_lscs_mo2$q8_post) / total_n_mo2) * 100,
    (sum(df_lscs_mo2$q9_post) / total_n_mo2) * 100,
    (sum(df_lscs_mo2$q10_post) / total_n_mo2) * 100
  )
)

# Jaundice (Jau)
df_jau_mo2 <- subset(df_mo2, condition == "jau")

# Calculate total_n for the filtered data
total_n_mo2 <- nrow(df_jau_mo2)

# Create the data frame with pre and post percentages for each question
st3_jau_mo2 <- data.frame(
  question = paste("Q", 1:10),
  jau_pre = c(
    (sum(df_jau_mo2$q1_pre) / total_n_mo2) * 100,
    (sum(df_jau_mo2$q2_pre) / total_n_mo2) * 100,
    (sum(df_jau_mo2$q3_pre) / total_n_mo2) * 100,
    (sum(df_jau_mo2$q4_pre) / total_n_mo2) * 100,
    (sum(df_jau_mo2$q5_pre) / total_n_mo2) * 100,
    (sum(df_jau_mo2$q6_pre) / total_n_mo2) * 100,
    (sum(df_jau_mo2$q7_pre) / total_n_mo2) * 100,
    (sum(df_jau_mo2$q8_pre) / total_n_mo2) * 100,
    (sum(df_jau_mo2$q9_pre) / total_n_mo2) * 100,
    (sum(df_jau_mo2$q10_pre) / total_n_mo2) * 100
  ),
  jau_post = c(
    (sum(df_jau_mo2$q1_post) / total_n_mo2) * 100,
    (sum(df_jau_mo2$q2_post) / total_n_mo2) * 100,
    (sum(df_jau_mo2$q3_post) / total_n_mo2) * 100,
    (sum(df_jau_mo2$q4_post) / total_n_mo2) * 100,
    (sum(df_jau_mo2$q5_post) / total_n_mo2) * 100,
    (sum(df_jau_mo2$q6_post) / total_n_mo2) * 100,
    (sum(df_jau_mo2$q7_post) / total_n_mo2) * 100,
    (sum(df_jau_mo2$q8_post) / total_n_mo2) * 100,
    (sum(df_jau_mo2$q9_post) / total_n_mo2) * 100,
    (sum(df_jau_mo2$q10_post) / total_n_mo2) * 100
  )
)
# HRT
# Assuming df has a 'condition' column and we're filtering for rows where condition is 'hrt'
df_hrt_mo2 <- subset(df_mo2, condition == "hrt")

# Calculate total_n for the filtered data
total_n_mo2 <- nrow(df_hrt_mo2)

# Create the data frame with pre and post percentages for each question
st3_hrt_mo2 <- data.frame(
  question = paste("Q", 1:10),
  hrt_pre = c(
    (sum(df_hrt_mo2$q1_pre) / total_n_mo2) * 100,
    (sum(df_hrt_mo2$q2_pre) / total_n_mo2) * 100,
    (sum(df_hrt_mo2$q3_pre) / total_n_mo2) * 100,
    (sum(df_hrt_mo2$q4_pre) / total_n_mo2) * 100,
    (sum(df_hrt_mo2$q5_pre) / total_n_mo2) * 100,
    (sum(df_hrt_mo2$q6_pre) / total_n_mo2) * 100,
    (sum(df_hrt_mo2$q7_pre) / total_n_mo2) * 100,
    (sum(df_hrt_mo2$q8_pre) / total_n_mo2) * 100,
    (sum(df_hrt_mo2$q9_pre) / total_n_mo2) * 100,
    (sum(df_hrt_mo2$q10_pre) / total_n_mo2) * 100
  ),
  hrt_post = c(
    (sum(df_hrt_mo2$q1_post) / total_n_mo2) * 100,
    (sum(df_hrt_mo2$q2_post) / total_n_mo2) * 100,
    (sum(df_hrt_mo2$q3_post) / total_n_mo2) * 100,
    (sum(df_hrt_mo2$q4_post) / total_n_mo2) * 100,
    (sum(df_hrt_mo2$q5_post) / total_n_mo2) * 100,
    (sum(df_hrt_mo2$q6_post) / total_n_mo2) * 100,
    (sum(df_hrt_mo2$q7_post) / total_n_mo2) * 100,
    (sum(df_hrt_mo2$q8_post) / total_n_mo2) * 100,
    (sum(df_hrt_mo2$q9_post) / total_n_mo2) * 100,
    (sum(df_hrt_mo2$q10_post) / total_n_mo2) * 100
  )
)

# EPI
# Assuming df has a 'condition' column and we're filtering for rows where condition is 'epi'
df_epi_mo2 <- subset(df_mo2, condition == "epi")

# Calculate total_n for the filtered data
total_n_mo2 <- nrow(df_epi_mo2)

# Create the data frame with pre and post percentages for each question
st3_epi_mo2 <- data.frame(
  question = paste("Q", 1:10),
  epi_pre = c(
    (sum(df_epi_mo2$q1_pre) / total_n_mo2) * 100,
    (sum(df_epi_mo2$q2_pre) / total_n_mo2) * 100,
    (sum(df_epi_mo2$q3_pre) / total_n_mo2) * 100,
    (sum(df_epi_mo2$q4_pre) / total_n_mo2) * 100,
    (sum(df_epi_mo2$q5_pre) / total_n_mo2) * 100,
    (sum(df_epi_mo2$q6_pre) / total_n_mo2) * 100,
    (sum(df_epi_mo2$q7_pre) / total_n_mo2) * 100,
    (sum(df_epi_mo2$q8_pre) / total_n_mo2) * 100,
    (sum(df_epi_mo2$q9_pre) / total_n_mo2) * 100,
    (sum(df_epi_mo2$q10_pre) / total_n_mo2) * 100
  ),
  epi_post = c(
    (sum(df_epi_mo2$q1_post) / total_n_mo2) * 100,
    (sum(df_epi_mo2$q2_post) / total_n_mo2) * 100,
    (sum(df_epi_mo2$q3_post) / total_n_mo2) * 100,
    (sum(df_epi_mo2$q4_post) / total_n_mo2) * 100,
    (sum(df_epi_mo2$q5_post) / total_n_mo2) * 100,
    (sum(df_epi_mo2$q6_post) / total_n_mo2) * 100,
    (sum(df_epi_mo2$q7_post) / total_n_mo2) * 100,
    (sum(df_epi_mo2$q8_post) / total_n_mo2) * 100,
    (sum(df_epi_mo2$q9_post) / total_n_mo2) * 100,
    (sum(df_epi_mo2$q10_post) / total_n_mo2) * 100
  )
)

# Combine the data frames using cbind
df_questions_combined_mo2 <- cbind(
  st3_tb_mo2[, c("question", "tb_pre", "tb_post")],
  st3_sob_mo2[, c("sob_pre", "sob_post")],
  st3_lscs_mo2[, c("lscs_pre", "lscs_post")],
  st3_jau_mo2[, c("jau_pre", "jau_post")],
  st3_hrt_mo2[, c("hrt_pre", "hrt_post")],
  st3_epi_mo2[, c("epi_pre", "epi_post")]
)

# Round all percentage columns to 1 decimal place
df_questions_combined_mo2[, 2:ncol(df_questions_combined_mo2)] <- round(df_questions_combined_mo2[, 2:ncol(df_questions_combined_mo2)], 1)

# Create a gt table and apply some custom formatting
df_questions_combined_mo2_gt <- df_questions_combined_mo2 %>%
  gt() %>%
  cols_label(
    question = "Question",
    tb_pre = "TB Pre",
    tb_post = "TB Post",
    sob_pre = "SOB Pre",
    sob_post = "SOB Post",
    lscs_pre = "LSCS Pre",
    lscs_post = "LSCS Post",
    jau_pre = "JAU Pre",
    jau_post = "JAU Post",
    hrt_pre = "HRT Pre",
    hrt_post = "HRT Post",
    epi_pre = "EPI Pre",
    epi_post = "EPI Post"
  ) %>%
  tab_spanner(
    label = "Pre-Post Score Percentage ",
    columns = c("tb_pre", "tb_post", 
                "sob_pre", "sob_post", "lscs_pre", "lscs_post", 
                "jau_pre", "jau_post", "hrt_pre", "hrt_post", 
                "epi_pre", "epi_post")
  )

# Apply tab_style() to highlight cells with values < 50
for (col in c("tb_pre", "tb_post", "sob_pre", "sob_post", "lscs_pre", "lscs_post",
              "jau_pre", "jau_post", "hrt_pre", "hrt_post", "epi_pre", "epi_post")) {
  df_questions_combined_mo2_gt <- df_questions_combined_mo2_gt %>%
    tab_style(
      style = list(
        cell_fill(color = "yellow"),  # Highlight only the specific cells
        cell_text(weight = "bold")    # Make text bold
      ),
      locations = cells_body(
        columns = col, 
        rows = df_questions_combined_mo2[[col]] < 50  # Apply condition per column
      )
    )
}

# Save the data frame to a CSV file
write.csv(df_questions_combined_mo2, "tables/df_questions_combined_mo2_gt_2.csv", row.names = FALSE)


```

```{r}
#| echo: false
#| warning: false
#| message: false

# Define the file paths
filepaths <- c(
  here::here('data','ts_cleaned_data','sn_cleaned_qanc_ts.csv'),
  here::here('data','ts_cleaned_data','sn_cleaned_ane_ts.csv'),
  here::here('data','ts_cleaned_data','sn_cleaned_htn_ts.csv'),
  here::here('data','ts_cleaned_data','sn_cleaned_gdm_ts.csv'),
  here::here('data','ts_cleaned_data','sn_cleaned_aph_ts.csv'))
# Import all files as data frames
data_frames_sn1 <- lapply(filepaths, read.csv)

# Bind all data frames into a single data frame
df_sn1 <- do.call(rbind, data_frames_sn1)

# Cleaning the data

df_sn1 <-
  df_sn1 |>
  janitor::clean_names()

# Remove unwanted columns

df_sn1 <- df_sn1 |> 
  select(-c("number",
            "name_post", 
            "age_post", 
            "entry_post", 
            "districts_post", 
            "phc_name_post", 
            "experience_post", 
            "mobile_no_post",
            "date_post"))

# Districts with district names

df_sn1$age_pre <- df_sn1$age_pre |> as.character()

# Ensure `age_pre` is numeric
df_sn1$age_pre <- as.numeric(df_sn1$age_pre)

# Current year
current_year <- as.numeric(format(Sys.Date(), "%Y"))

# Identify values in `age_pre` that are in the year format and convert them to age
df_sn1$age_pre <- ifelse(df_sn1$age_pre >= 1900 & df_sn1$age_pre <= current_year,  # Assuming any value between 1900 and the current year is a year
                     current_year - df_sn1$age_pre,  # Convert year to age
                     df_sn1$age_pre)  # Leave other values unchanged

df_sn1 <- df_sn1 %>%
  mutate(districts_number = case_when(
    districts_pre == "Adilabad" ~ 1,
    districts_pre == "Bhadradri Kothagudem" ~ 2,
    districts_pre == "Hyderabad" ~ 3,
    districts_pre == "Jagityal" ~ 4,
    districts_pre == "Jangaon" ~ 5,
    districts_pre == "Jayashankar Bhupalapally" ~ 6,
    districts_pre == "Jogulamba Gadwal" ~ 7,
    districts_pre == "Kamareddy" ~ 8,
    districts_pre == "Karimnagar" ~ 9,
    districts_pre == "Khammam" ~ 10,
    districts_pre == "Komarambheem Asifabad" ~ 11,
    districts_pre == "Mahabubabad" ~ 12,
    districts_pre == "Mahabubnagar" ~ 13,
    districts_pre == "Mancheriyal" ~ 14,
    districts_pre == "Medak" ~ 15,
    districts_pre == "Medchal Malkajgiri" ~ 16,
    districts_pre == "Mulugu" ~ 17,
    districts_pre == "Nagarkurnool" ~ 18,
    districts_pre == "Nalgonda" ~ 19,
    districts_pre == "Narayanpet" ~ 20,
    districts_pre == "Nirmal" ~ 21,
    districts_pre == "Nizambad" ~ 22,
    districts_pre == "Peddapally" ~ 23,
    districts_pre == "Rajanna Siricilla" ~ 24,
    districts_pre == "Rangareddy" ~ 25,
    districts_pre == "Sangareddy" ~ 26,
    districts_pre == "Siddipet" ~ 27,
    districts_pre == "Suryapet" ~ 28,
    districts_pre == "Vikarabad" ~ 29,
    districts_pre == "Wanaparthy" ~ 30,
    districts_pre == "Warangal Rural" ~ 31,
    districts_pre == "Warangal Urban" ~ 32,
    districts_pre == "Yadadri Bhuvanagiri" ~ 33,
    TRUE ~ NA_integer_
  ))

# Change the district names and mutate a column with the concerned district names

df_sn1 <- df_sn1 %>%
  mutate(district_name = case_when(
    districts_number == 1 ~ "Adilabad",
    districts_number == 2 ~ "Bhadradri Kothagudem",
    districts_number == 3 ~ "Hyderabad",
    districts_number == 4 ~ "Jagtial",
    districts_number == 5 ~ "Jangaon",
    districts_number == 6 ~ "Jayashankar Bhupalpally",
    districts_number == 7 ~ "Jogulamba Gadwal",
    districts_number == 8 ~ "Kamareddy",
    districts_number == 9 ~ "Karimnagar",
    districts_number == 10 ~ "Khammam",
    districts_number == 11 ~ "Komaram Bheem Asifabad",
    districts_number == 12 ~ "Mahabubabad",
    districts_number == 13 ~ "Mahabubnagar",
    districts_number == 14 ~ "Mancherial",
    districts_number == 15 ~ "Medak",
    districts_number == 16 ~ "Medchal Malkajgiri",
    districts_number == 17 ~ "Mulugu",
    districts_number == 18 ~ "Nagarkurnool",
    districts_number == 19 ~ "Nalgonda",
    districts_number == 20 ~ "Narayanpet",
    districts_number == 21 ~ "Nirmal",
    districts_number == 22 ~ "Nizamabad",
    districts_number == 23 ~ "Peddapalli",
    districts_number == 24 ~ "Rajanna Sircilla",
    districts_number == 25 ~ "Rangareddy",
    districts_number == 26 ~ "Sangareddy",
    districts_number == 27 ~ "Siddipet",
    districts_number == 28 ~ "Suryapet",
    districts_number == 29 ~ "Vikarabad",
    districts_number == 30 ~ "Wanaparthy",
    districts_number == 31 ~ "Warangal Rural",
    districts_number == 32 ~ "Warangal Urban",
    districts_number == 33 ~ "Yadadri Bhuvanagiri",
    TRUE ~ NA_character_
  ))

# QANC Correct answers
# Pre
df_sn1 <- df_sn1 %>%
  mutate(
    q1_pre = ifelse(condition == "qanc", ifelse(q1_pre == 4, 1, 0), q1_pre),
    q2_pre = ifelse(condition == "qanc", ifelse(q2_pre == 3, 1, 0), q2_pre),
    q3_pre = ifelse(condition == "qanc", ifelse(q3_pre == 1, 1, 0), q3_pre),
    q4_pre = ifelse(condition == "qanc", ifelse(q4_pre == 1, 1, 0), q4_pre),
    q5_pre = ifelse(condition == "qanc", ifelse(q5_pre == 2, 1, 0), q5_pre),
    q6_pre = ifelse(condition == "qanc", ifelse(q6_pre == 4, 1, 0), q6_pre),
    q7_pre = ifelse(condition == "qanc", ifelse(q7_pre == 1, 1, 0), q7_pre),
    q8_pre = ifelse(condition == "qanc", ifelse(q8_pre == 2, 1, 0), q8_pre),
    q9_pre = ifelse(condition == "qanc", ifelse(q9_pre == 4, 1, 0), q9_pre),
    q10_pre = ifelse(condition == "qanc", ifelse(q10_pre == 1, 1, 0), q10_pre))

# Post
df_sn1 <- df_sn1 %>%
  mutate(
    q1_post = ifelse(condition == "qanc", ifelse(q1_post == 4, 1, 0), q1_post),
    q2_post = ifelse(condition == "qanc", ifelse(q2_post == 3, 1, 0), q2_post),
    q3_post = ifelse(condition == "qanc", ifelse(q3_post == 1, 1, 0), q3_post),
    q4_post = ifelse(condition == "qanc", ifelse(q4_post == 1, 1, 0), q4_post),
    q5_post = ifelse(condition == "qanc", ifelse(q5_post == 2, 1, 0), q5_post),
    q6_post = ifelse(condition == "qanc", ifelse(q6_post == 4, 1, 0), q6_post),
    q7_post = ifelse(condition == "qanc", ifelse(q7_post == 1, 1, 0), q7_post),
    q8_post = ifelse(condition == "qanc", ifelse(q8_post == 2, 1, 0), q8_post),
    q9_post = ifelse(condition == "qanc", ifelse(q9_post == 4, 1, 0), q9_post),
    q10_post = ifelse(condition == "qanc", ifelse(q10_post == 1, 1, 0), q10_post))

# Anaemia correct answers
# Pre
df_sn1 <- df_sn1 %>%
  mutate(
    q1_pre = ifelse(condition == "ane", ifelse(q1_pre == 1, 1, 0), q1_pre),
    q2_pre = ifelse(condition == "ane", ifelse(q2_pre == 1, 1, 0), q2_pre),
    q3_pre = ifelse(condition == "ane", ifelse(q3_pre == 4, 1, 0), q3_pre),
    q4_pre = ifelse(condition == "ane", ifelse(q4_pre == 4, 1, 0), q4_pre),
    q5_pre = ifelse(condition == "ane", ifelse(q5_pre == 3, 1, 0), q5_pre),
    q6_pre = ifelse(condition == "ane", ifelse(q6_pre == 1, 1, 0), q6_pre),
    q7_pre = ifelse(condition == "ane", ifelse(q7_pre == 2, 1, 0), q7_pre),
    q8_pre = ifelse(condition == "ane", ifelse(q8_pre == 4, 1, 0), q8_pre),
    q9_pre = ifelse(condition == "ane", ifelse(q9_pre == 1, 1, 0), q9_pre),
    q10_pre = ifelse(condition == "ane", ifelse(q10_pre == 4, 1, 0), q10_pre))

# Post
df_sn1 <- df_sn1 %>%
  mutate(
    q1_post = ifelse(condition == "ane", ifelse(q1_post == 1, 1, 0), q1_post),
    q2_post = ifelse(condition == "ane", ifelse(q2_post == 1, 1, 0), q2_post),
    q3_post = ifelse(condition == "ane", ifelse(q3_post == 4, 1, 0), q3_post),
    q4_post = ifelse(condition == "ane", ifelse(q4_post == 4, 1, 0), q4_post),
    q5_post = ifelse(condition == "ane", ifelse(q5_post == 3, 1, 0), q5_post),
    q6_post = ifelse(condition == "ane", ifelse(q6_post == 1, 1, 0), q6_post),
    q7_post = ifelse(condition == "ane", ifelse(q7_post == 2, 1, 0), q7_post),
    q8_post = ifelse(condition == "ane", ifelse(q8_post == 4, 1, 0), q8_post),
    q9_post = ifelse(condition == "ane", ifelse(q9_post == 1, 1, 0), q9_post),
    q10_post = ifelse(condition == "ane", ifelse(q10_post == 4, 1, 0), q10_post))
# HTN correct answers
# Pre
df_sn1 <- df_sn1 %>%
  mutate(
    q1_pre = ifelse(condition == "htn", ifelse(q1_pre == 1, 1, 0), q1_pre),
    q2_pre = ifelse(condition == "htn", ifelse(q2_pre == 4, 1, 0), q2_pre),
    q3_pre = ifelse(condition == "htn", ifelse(q3_pre == 2, 1, 0), q3_pre),
    q4_pre = ifelse(condition == "htn", ifelse(q4_pre == 1, 1, 0), q4_pre),
    q5_pre = ifelse(condition == "htn", ifelse(q5_pre == 4, 1, 0), q5_pre),
    q6_pre = ifelse(condition == "htn", ifelse(q6_pre == 4, 1, 0), q6_pre),
    q7_pre = ifelse(condition == "htn", ifelse(q7_pre == 3, 1, 0), q7_pre),
    q8_pre = ifelse(condition == "htn", ifelse(q8_pre == 4, 1, 0), q8_pre),
    q9_pre = ifelse(condition == "htn", ifelse(q9_pre == 2, 1, 0), q9_pre),
    q10_pre = ifelse(condition == "htn", ifelse(q10_pre == 4, 1, 0), q10_pre))

# Post
df_sn1 <- df_sn1 %>%
  mutate(
    q1_post = ifelse(condition == "htn", ifelse(q1_post == 1, 1, 0), q1_post),
    q2_post = ifelse(condition == "htn", ifelse(q2_post == 4, 1, 0), q2_post),
    q3_post = ifelse(condition == "htn", ifelse(q3_post == 2, 1, 0), q3_post),
    q4_post = ifelse(condition == "htn", ifelse(q4_post == 1, 1, 0), q4_post),
    q5_post = ifelse(condition == "htn", ifelse(q5_post == 4, 1, 0), q5_post),
    q6_post = ifelse(condition == "htn", ifelse(q6_post == 4, 1, 0), q6_post),
    q7_post = ifelse(condition == "htn", ifelse(q7_post == 3, 1, 0), q7_post),
    q8_post = ifelse(condition == "htn", ifelse(q8_post == 4, 1, 0), q8_post),
    q9_post = ifelse(condition == "htn", ifelse(q9_post == 2, 1, 0), q9_post),
    q10_post = ifelse(condition == "htn", ifelse(q10_post == 4, 1, 0), q10_post))

# GDM Correct answers 
# Pre 
df_sn1 <- df_sn1 %>%
  mutate(
    q1_pre = ifelse(condition == "gdm", ifelse(q1_pre == 1, 1, 0), q1_pre),
    q2_pre = ifelse(condition == "gdm", ifelse(q2_pre == 3, 1, 0), q2_pre),
    q3_pre = ifelse(condition == "gdm", ifelse(q3_pre == 3, 1, 0), q3_pre),
    q4_pre = ifelse(condition == "gdm", ifelse(q4_pre == 1, 1, 0), q4_pre),
    q5_pre = ifelse(condition == "gdm", ifelse(q5_pre == 2, 1, 0), q5_pre),
    q6_pre = ifelse(condition == "gdm", ifelse(q6_pre == 1, 1, 0), q6_pre),
    q7_pre = ifelse(condition == "gdm", ifelse(q7_pre == 1, 1, 0), q7_pre),
    q8_pre = ifelse(condition == "gdm", ifelse(q8_pre == 2, 1, 0), q8_pre),
    q9_pre = ifelse(condition == "gdm", ifelse(q9_pre == 4, 1, 0), q9_pre),
    q10_pre = ifelse(condition == "gdm", ifelse(q10_pre == 1, 1, 0), q10_pre))

# Post
df_sn1 <- df_sn1 %>%
  mutate(
    q1_post = ifelse(condition == "gdm", ifelse(q1_post == 1, 1, 0), q1_post),
    q2_post = ifelse(condition == "gdm", ifelse(q2_post == 3, 1, 0), q2_post),
    q3_post = ifelse(condition == "gdm", ifelse(q3_post == 3, 1, 0), q3_post),
    q4_post = ifelse(condition == "gdm", ifelse(q4_post == 1, 1, 0), q4_post),
    q5_post = ifelse(condition == "gdm", ifelse(q5_post == 2, 1, 0), q5_post),
    q6_post = ifelse(condition == "gdm", ifelse(q6_post == 1, 1, 0), q6_post),
    q7_post = ifelse(condition == "gdm", ifelse(q7_post == 1, 1, 0), q7_post),
    q8_post = ifelse(condition == "gdm", ifelse(q8_post == 2, 1, 0), q8_post),
    q9_post = ifelse(condition == "gdm", ifelse(q9_post == 4, 1, 0), q9_post),
    q10_post = ifelse(condition == "gdm", ifelse(q10_post == 1, 1, 0), q10_post))

# APH Correct answers 
# Pre
df_sn1 <- df_sn1 %>%
  mutate(
    q1_pre = ifelse(condition == "aph", ifelse(q1_pre == 2, 1, 0), q1_pre),
    q2_pre = ifelse(condition == "aph", ifelse(q2_pre == 4, 1, 0), q2_pre),
    q3_pre = ifelse(condition == "aph", ifelse(q3_pre == 2, 1, 0), q3_pre),
    q4_pre = ifelse(condition == "aph", ifelse(q4_pre == 2, 1, 0), q4_pre),
    q5_pre = ifelse(condition == "aph", ifelse(q5_pre == 3, 1, 0), q5_pre),
    q6_pre = ifelse(condition == "aph", ifelse(q6_pre == 2, 1, 0), q6_pre),
    q7_pre = ifelse(condition == "aph", ifelse(q7_pre == 4, 1, 0), q7_pre),
    q8_pre = ifelse(condition == "aph", ifelse(q8_pre == 4, 1, 0), q8_pre),
    q9_pre = ifelse(condition == "aph", ifelse(q9_pre == 1, 1, 0), q9_pre),
    q10_pre = ifelse(condition == "aph", ifelse(q10_pre == 2, 1, 0), q10_pre))

# Post
df_sn1 <- df_sn1 %>%
  mutate(
    q1_post = ifelse(condition == "aph", ifelse(q1_post == 2, 1, 0), q1_post),
    q2_post = ifelse(condition == "aph", ifelse(q2_post == 4, 1, 0), q2_post),
    q3_post = ifelse(condition == "aph", ifelse(q3_post == 2, 1, 0), q3_post),
    q4_post = ifelse(condition == "aph", ifelse(q4_post == 2, 1, 0), q4_post),
    q5_post = ifelse(condition == "aph", ifelse(q5_post == 3, 1, 0), q5_post),
    q6_post = ifelse(condition == "aph", ifelse(q6_post == 2, 1, 0), q6_post),
    q7_post = ifelse(condition == "aph", ifelse(q7_post == 4, 1, 0), q7_post),
    q8_post = ifelse(condition == "aph", ifelse(q8_post == 4, 1, 0), q8_post),
    q9_post = ifelse(condition == "aph", ifelse(q9_post == 1, 1, 0), q9_post),
    q10_post = ifelse(condition == "aph", ifelse(q10_post == 2, 1, 0), q10_post))

# Sum of Pre and post total correct scores
df_sn1 <- df_sn1 %>%
  mutate(
    pre_total_correct = rowSums(select(., starts_with("q") & ends_with("pre"))),
    post_total_correct = rowSums(select(., starts_with("q") & ends_with("post")))
  )

df_sn1 <- df_sn1 |> 
  mutate(relative_change = post_total_correct - pre_total_correct)

# Adding relative change column and creating code for the same
df_sn1 <- df_sn1 %>%
  mutate(rc_code = case_when(
    relative_change == 0 ~ "No Change",
    relative_change %in% c(-1, -2) ~ "-1 to -2",
    relative_change %in% c(1, 2) ~ "1 to 2",
    relative_change >= 3 ~ "+3 and above",
    relative_change <= -3 ~ "-3 and below",
    TRUE ~ NA_character_  # Ensure that the NA type is character to match the other outcomes
  ))

df_sn1 <- df_sn1 %>%
  mutate(rc_positive_negative_code = case_when(
    relative_change == 0 ~ "No Change",
    relative_change %in% c(-1, -2) ~ "Negative change",
    relative_change %in% c(1, 2) ~ "Positive change",
    relative_change >= 3 ~ "Positive change",
    relative_change <= -3 ~ "Negative change",
    TRUE ~ NA_character_  # Ensure that the NA type is character to match the other outcomes
  ))
# Create summary statistics grouped by district_name and condition
sta1_sn1 <- df_sn1 %>%
  group_by(district_name, condition) %>%
  summarise(
    pre_mean = round(mean(pre_total_correct, na.rm = TRUE), 1),
    pre_std = round(sd(pre_total_correct, na.rm = TRUE), 1),
    pre_mean_pct = round((mean(pre_total_correct, na.rm = TRUE) / 10) * 100, 1),  
    # Pre-test percentage
    post_mean = round(mean(post_total_correct, na.rm = TRUE), 1),
    post_std = round(sd(post_total_correct, na.rm = TRUE), 1),
    post_mean_pct = round((mean(post_total_correct, na.rm = TRUE) / 10) * 100, 1), 
    # Post-test percentage
    p_value = ifelse(
      sum(!is.na(pre_total_correct) & !is.na(post_total_correct)) > 1 && 
      sd(pre_total_correct, na.rm = TRUE) > 0 && sd(post_total_correct, na.rm = TRUE) > 0, 
      round(t.test(pre_total_correct, post_total_correct, paired = TRUE)$p.value, 6), 
      NA )
  )

# Calculate state average (overall mean, std, and percentage grouped by condition)
state_avg_sn1 <- df_sn1 %>%
  group_by(condition) %>%
  summarise(
    pre_mean = round(mean(pre_total_correct, na.rm = TRUE), 1),
    pre_std = round(sd(pre_total_correct, na.rm = TRUE), 1),
    pre_mean_pct = round((mean(pre_total_correct, na.rm = TRUE) / 10) * 100, 1),  # Pre-test percentage
    post_mean = round(mean(post_total_correct, na.rm = TRUE), 1),
    post_std = round(sd(post_total_correct, na.rm = TRUE), 1),
    post_mean_pct = round((mean(post_total_correct, na.rm = TRUE) / 10) * 100, 1)  # Post-test percentage
  ) %>%
  mutate(district_name = "Overall Average")  # Add state average label

# Combine district-level and state-level data
sta1_sn1 <- bind_rows(sta1_sn1, state_avg_sn1)

# Save sta1 as a CSV file
write.csv(sta1_sn1, "tables/sta1_summary_sn1_ts.csv", row.names = FALSE)

# Overall mean, std and percentage grouped by condition
sta2_sn1 <- df_sn1 %>%
  group_by(condition) %>%
  summarise(
    n = n(),  # Count of rows for each condition
    pre_mean = round(mean(pre_total_correct, na.rm = TRUE), 1),
    pre_std = round(sd(pre_total_correct, na.rm = TRUE), 1),
    pre_mean_pct = round((mean(pre_total_correct, na.rm = TRUE) / 10) * 100, 1),  # Pre-test percentage
    post_mean = round(mean(post_total_correct, na.rm = TRUE), 1),
    post_std = round(sd(post_total_correct, na.rm = TRUE), 1),
    post_mean_pct = round((mean(post_total_correct, na.rm = TRUE) / 10) * 100, 1)  # Post-test percentage
  )

# Calculate state average (same as above)
state_avg_sn1 <- df_sn1 %>%
  summarise(
    pre_mean = round(mean(pre_total_correct, na.rm = TRUE), 1),
    pre_std = round(sd(pre_total_correct, na.rm = TRUE), 1),
    pre_mean_pct = round((mean(pre_total_correct, na.rm = TRUE) / 10) * 100, 1),  # Pre-test percentage
    post_mean = round(mean(post_total_correct, na.rm = TRUE), 1),
    post_std = round(sd(post_total_correct, na.rm = TRUE), 1),
    post_mean_pct = round((mean(post_total_correct, na.rm = TRUE) / 10) * 100, 1)  # Post-test percentage
  ) %>%
  mutate(condition = "Overall Average")  # Add state average label

# Combine condition-level and state-level data
sta2_sn1 <- bind_rows(sta2_sn1, state_avg_sn1)

# Save sta2 as a CSV file
write.csv(sta2_sn1, "tables/sta2_summary_sn1_ts.csv", row.names = FALSE)

# Reorder condition factor based on post-test mean percentage in descending order
sta2_sn1 <- sta2_sn1 %>%
  arrange(desc(post_mean_pct)) %>%
  mutate(condition = factor(condition, levels = condition))

# Reshape the data from wide to long format using tidyr's pivot_longer
sta2_long_sn1 <- tidyr::pivot_longer(sta2_sn1, 
                                      cols = c("pre_mean_pct", "post_mean_pct"), 
                                      names_to = "Time", 
                                      values_to = "Mean_Pct")

# Calculate the gain in knowledge for each condition
knowledge_gain_sn1 <- sta2_sn1 %>%
  mutate(Gain = post_mean_pct - pre_mean_pct) %>%
  select(condition, Gain)

# Reorder 'Time' factor levels to ensure 'pre' comes before 'post'
sta2_long_sn1$Time <- factor(sta2_long_sn1$Time, levels = c("pre_mean_pct", "post_mean_pct"))

# Combine data for all conditions
relative_change_combined_sn1 <- df_sn1 %>%
  count(condition, rc_positive_negative_code) %>%  # Count occurrences for each condition and change type
  group_by(condition) %>%  # Group by condition
  mutate(percentage = n / sum(n) * 100)  # Calculate percentage

# Reorder 'condition' based on descending percentage of "Positive change"
positive_order_sn1 <- relative_change_combined_sn1 %>%
  filter(rc_positive_negative_code == "Positive change") %>%
  arrange(percentage) %>%  # Sort in ascending order
  pull(condition)  # Extract the ordered conditions

relative_change_combined_sn1 <- relative_change_combined_sn1 %>%
  mutate(condition = factor(condition, levels = positive_order_sn1))  # Reorder factor levels


# Replace condition abbreviations with full names
sta2_sn1 <- sta2_sn1 %>%
  mutate(condition_name = case_when(
    condition == "ane" ~ "Anaemia",
    condition == "aph" ~ "Antepartum Haemorrhage",
    condition == "gdm" ~ "Gestational Diabetes",
    condition == "htn" ~ "Hypertension",
    condition == "qanc" ~ "Quality ANC",
    TRUE ~ condition )) # Keep other values unchanged (if any)

# Map - Trainings happening in districts

library(sf)

# Load the GeoJSON file
telangana_sf_sn1 <- st_read(here::here("data", "ts_cleaned_data", "telangana.json"), quiet = TRUE)

# Create district responses from your dataset (df1)
district_responses_sn1 <- df_sn1 %>%
  group_by(district_name) %>%
  summarise(no_of_responses = n())

# Mutate the District column in telangana_sf1 to match district_responses
telangana_sf_sn1 <- telangana_sf_sn1 %>%
  mutate(district_name = case_when(
    District == "ADILABAD" ~ "Adilabad",
    District == "BHADRADRI KOTHAGUDEM" ~ "Bhadradri Kothagudem",
    District == "HYDERABAD" ~ "Hyderabad",
    District == "JAGTIAL" ~ "Jagtial",
    District == "JANGAON" ~ "Jangaon",
    District == "JAYASHANKAR BHUPALAPALLY" ~ "Jayashankar Bhupalapally",
    District == "JOGULAMBA GADWAL" ~ "Jogulamba Gadwal",
    District == "KAMAREDDY" ~ "Kamareddy",
    District == "KARIMNAGAR" ~ "Karimnagar",
    District == "KHAMMAM" ~ "Khammam",
    District == "KUMURAM BHEEM" ~ "Komaram Bheem Asifabad",
    District == "MAHABUBABAD" ~ "Mahabubabad",
    District == "MAHABUBNAGAR" ~ "Mahabubnagar",
    District == "MANCHERIAL" ~ "Mancherial",
    District == "MEDAK" ~ "Medak",
    District == "MEDCHAL-MALKAJGIRI" ~ "Medchal Malkajgiri",
    District == "MULUGU" ~ "Mulugu",
    District == "NAGARKURNOOL" ~ "Nagarkurnool",
    District == "NALGONDA" ~ "Nalgonda",
    District == "NARAYANPET" ~ "Narayanpet",
    District == "NIRMAL" ~ "Nirmal",
    District == "NIZAMABAD" ~ "Nizamabad",
    District == "PEDDAPALLI" ~ "Peddapalli",
    District == "RANJANNA SIRCILLA" ~ "Rajanna Sircilla",
    District == "RANGAREDDY" ~ "Rangareddy",
    District == "SANGAREDDY" ~ "Sangareddy",
    District == "SIDDIPET" ~ "Siddipet",
    District == "SURYAPET" ~ "Suryapet",
    District == "VIKARABAD" ~ "Vikarabad",
    District == "WANAPARTHY" ~ "Wanaparthy",
    District == "WARANGAL (RURAL)" ~ "Warangal Rural",
    District == "WARANGAL (URBAN)" ~ "Warangal Urban",
    District == "YADADRI BHUVANAGIRI" ~ "Yadadri Bhuvanagiri",
    TRUE ~ District  # Keep original value if no match
  ))

# Join the standardized district_responses with telangana_sf1
merged_tg_sf_sn1 <- telangana_sf_sn1 %>%
  left_join(district_responses_sn1, by = "district_name")

# Identify districts with responses
merged_tg_sf_sn1 <- merged_tg_sf_sn1 %>%
  mutate(map = ifelse(!is.na(no_of_responses), 1, 0))

# Plot the map
telangana_map_plot_sn1 <- ggplot(merged_tg_sf_sn1) +
  geom_sf(aes(fill = factor(map)), color = "black") +
  scale_fill_manual(values = c("0" = "grey90", "1" = "lightgreen")) +
  geom_sf_text(data = merged_tg_sf_sn1 %>% filter(map == 1), aes(label = District), size = 3) + 
  theme_void() +
  theme(legend.position = "none")

# Plot the map
telangana_map_plot_sn1 <- ggplot(merged_tg_sf_sn1) +
  geom_sf(aes(fill = factor(map)), color = "black") +
  scale_fill_manual(values = c("0" = "grey90", "1" = "lightgreen")) +
  geom_sf_text(data = merged_tg_sf_sn1 %>% filter(map == 1), aes(label = District), size = 3) + 
  theme_void() +
  theme(legend.position = "none")

# Save the plot in the "images" folder using ggsave
ggsave("plots/telangana_map_plot_sn1.png", plot = telangana_map_plot_sn1, width = 8, height = 6, dpi = 300)


# Create a new column to differentiate the state average from other conditions

sta2_long_sn1 <- sta2_long_sn1 %>%
  mutate(state_avg = ifelse(condition == "Overall Average", "Overall Average", "Conditions"))

# Create the ggplot bar chart with adjustments for spacing and legibility
pre_post_mean_pct_sn1 <- ggplot(sta2_long_sn1, aes(x = condition, y = Mean_Pct, fill = interaction(Time, state_avg))) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.8), width = 0.7) +  # Increase spacing
  scale_fill_manual(values = c("pre_mean_pct.Conditions" = "blue", 
                               "post_mean_pct.Conditions" = "orange",
                               "pre_mean_pct.Overall Average" = "lightskyblue", 
                               "post_mean_pct.Overall Average" = "lightgreen")) +
  geom_text(aes(label = round(Mean_Pct, 1)), 
            position = position_dodge(width = 0.8),  # Adjust text position to align with the new dodge width
            vjust = -0.5) +  # Adjust label position
  labs(x = "Condition", y = "Mean %") +
  theme_minimal() +
  theme(
    legend.title = element_blank(),
    axis.text.x = element_text(size = 12, face = "bold", angle = 45, hjust = 1),  # Rotate axis labels for better legibility
    axis.title.x = element_text(size = 14, face = "bold"),
    plot.margin = margin(10, 20, 10, 20),  # Add space around the plot
    panel.grid.major.x = element_blank(),  # Optional: remove vertical grid lines for clarity
    panel.grid.minor.x = element_blank()
  ) +
  # Add gain in knowledge as annotations below the x-axis labels
  annotate("text", 
           x = knowledge_gain_sn1$condition, 
           y = -5,  # Position slightly below the x-axis
           label = paste0(round(knowledge_gain_sn1$Gain, 1), "%"),
           size = 3.5, 
           color = "red")

# Save the plot in the "plots" directory
ggsave("plots/pre_post_mean_pct_sn1.png", 
       plot = pre_post_mean_pct_sn1, 
       width = 10, 
       height = 6, 
       dpi = 300)

# Create the plot object
plot_relative_change_sn1 <- ggplot(relative_change_combined_sn1, aes(x = percentage, y = condition, fill = rc_positive_negative_code)) +
  geom_bar(stat = "identity", position = "dodge", width = 0.7) +
  geom_text(aes(label = sprintf("%.1f%%", percentage)), 
            position = position_dodge(width = 0.9), 
            hjust = -0.2, 
            size = 3) +
  labs(x = "Percentage (%)", y = "Condition") +
  scale_fill_manual(values = c("Positive change" = "darkgreen", 
                               "Negative change" = "red", 
                               "No Change" = "orange")) +
  scale_x_continuous(expand = expansion(mult = c(0, 0.1))) +
  theme_minimal(base_size = 12) +
  theme(
    axis.text.y = element_text(size = 10),
    axis.text.x = element_text(size = 10),
    axis.title.x = element_text(size = 12, face = "bold"),
    axis.title.y = element_text(size = 12, face = "bold"),
    plot.title = element_text(size = 14, face = "bold", hjust = 0.5),
    legend.title = element_blank(),
    legend.text = element_text(size = 10)
  )

# Save the plot in the "images" folder using ggsave
ggsave("plots/plot_relative_change_sn1.png", plot = plot_relative_change_sn1, width = 8, height = 6, dpi = 300)

# Add condition names
relative_change_combined_sn1 <- relative_change_combined_sn1 %>%
  mutate(condition_name = case_when(
    condition == "qanc" ~ "Quality ANC",
    condition == "ane" ~ "Anaemia",
    condition == "gdm" ~ "Gestational Diabetes",
    condition == "aph" ~ "Antepartum Hemorrhage",
    condition == "htn" ~ "Hypertension",
    TRUE ~ condition
  ))

# Filter for 'Positive change'
positive_changes_sn1 <- relative_change_combined_sn1 %>% 
  filter(rc_positive_negative_code == "Positive change")

# Find the index of the maximum percentage
max_index_sn1 <- which.max(positive_changes_sn1$percentage)

# Extract the row with the highest percentage
highest_positive_change_sn1 <- positive_changes_sn1[max_index_sn1, ]

# Extract the corresponding condition name
condition_name1_sn1 <- highest_positive_change_sn1$condition_name

# Filter for 'Negative change'
negative_changes_sn1 <- relative_change_combined_sn1 %>% 
  filter(rc_positive_negative_code == "Negative change")

# Find the index of the maximum percentage
max_index_sn1 <- which.max(negative_changes_sn1$percentage)

# Extract the row with the highest percentage
highest_negative_change_sn1 <- negative_changes_sn1[max_index_sn1, ]

# Extract the corresponding condition name
condition_name_neg_sn1 <- highest_negative_change_sn1$condition_name

# Calculate the district-wise mean percentage for pre and post test scores
district_wise_combined_sn1 <- df_sn1 |>
  group_by(district_name) |>
  summarise(mean_pre_test = mean(pre_total_correct, na.rm = TRUE) * 100 / max(pre_total_correct, na.rm = TRUE), 
            mean_post_test = mean(post_total_correct, na.rm = TRUE) * 100 / max(post_total_correct, na.rm = TRUE))

# Calculate Overall Average and add it to the data
overall_avg_sn1 <- df_sn1 |>
  summarise(mean_pre_test = mean(pre_total_correct, na.rm = TRUE) * 100 / max(pre_total_correct, na.rm = TRUE), 
            mean_post_test = mean(post_total_correct, na.rm = TRUE) * 100 / max(post_total_correct, na.rm = TRUE)) |>
  mutate(district_name = "Overall Average")

# Combine the overall average with the district-wise data
district_wise_combined_sn1 <- bind_rows(district_wise_combined_sn1, overall_avg_sn1)

# Reorder district_name factor by post-test mean percentage in descending order
district_wise_combined_sn1 <- district_wise_combined_sn1 |>
  arrange(desc(mean_post_test)) |>
  mutate(district_name = factor(district_name, levels = district_name))

# Reshape the data to long format
district_wise_combined_long_sn1 <- district_wise_combined_sn1 |>
  pivot_longer(cols = starts_with("mean_"), names_to = "test_type", values_to = "mean_percentage")

# Reorder 'test_type' factor levels to ensure 'pre' comes before 'post'
district_wise_combined_long_sn1$test_type <- factor(district_wise_combined_long_sn1$test_type, 
                                                    levels = c("mean_pre_test", "mean_post_test"),
                                                    labels = c("pre", "post"))

# Create a new column for color mapping based on test type and overall average
district_wise_combined_long_sn1 <- district_wise_combined_long_sn1 |>
  mutate(color_group = case_when(
    district_name == "Overall Average" & test_type == "pre" ~ "Overall Average Pre",
    district_name == "Overall Average" & test_type == "post" ~ "Overall Average Post",
    test_type == "pre" ~ "Pre",
    test_type == "post" ~ "Post",
    TRUE ~ "Other"
  ))


# Reorder district names based on "Post" mean percentage in descending order
district_wise_combined_long_sn1 <- district_wise_combined_long_sn1 %>%
  # Create a temporary column to store "Post" mean percentage
  dplyr::mutate(post_percentage = ifelse(color_group == "Post", mean_percentage, NA)) %>%
  # Group by district_name and get the max of post_percentage (for sorting)
  dplyr::group_by(district_name) %>%
  dplyr::mutate(post_percentage_max = max(post_percentage, na.rm = TRUE)) %>%
  # Arrange districts based on the max post_percentage in descending order
  dplyr::arrange(dplyr::desc(post_percentage_max)) %>%
  # Set district_name as a factor in the order of the arranged rows
  dplyr::mutate(district_name = factor(district_name, levels = unique(district_name))) %>%
  # Clean up the temporary columns
  dplyr::select(-post_percentage, -post_percentage_max)

# Set factor levels to ensure 'Pre' comes before 'Post' for each district
district_wise_combined_long_sn1$color_group <- factor(district_wise_combined_long_sn1$color_group, 
                                                     levels = c("Pre", "Post", "Overall Average Pre", "Overall Average Post"))

# Create the ggplot bar chart
districtwise_combined_percentage_plot_sn1 <- ggplot(district_wise_combined_long_sn1, aes(x = district_name, y = mean_percentage, fill = color_group)) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.7), width = 0.7) +
  geom_text(aes(label = round(mean_percentage, 1)), 
            position = position_dodge(width = 0.9), 
            vjust = -0.5,
            size = 3) +  # Reduce the data label size
  labs(x = "District Name",
       y = "Mean Percentage Score",
       fill = "Test Type") +  # Add legend title
  scale_fill_manual(values = c("Pre" = "coral", "Post" = "cyan3", 
                               "Overall Average Pre" = "purple", "Overall Average Post" = "blue")) +  # Different colors for Overall Average
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 10, face = "bold"),
    axis.title.x = element_text(size = 12, face = "bold"),
    axis.title.y = element_text(size = 12, face = "bold"),
    legend.title = element_text(size = 10, face = "bold"),
    legend.text = element_text(size = 9)
  )

# Save the plot in the "plots" directory
ggsave("plots/districtwise_combined_percentage_plot_sn1.png", 
       plot = districtwise_combined_percentage_plot_sn1, 
       width = 8, 
       height = 6, 
       dpi = 300)


####Question wise analysis

#QANC
# Assuming df has a 'condition' column and we're filtering for rows where condition is 'qanc'
df_qanc_sn1 <- subset(df_sn1, condition == "qanc")

# Calculate total_n for the filtered data
total_n_sn1 <- nrow(df_qanc_sn1)

# Create the data frame with pre and post percentages for each question
st3_qanc_sn1 <- data.frame(
  question = paste("Q", 1:10),
  qanc_pre = c(
    (sum(df_qanc_sn1$q1_pre) / total_n_sn1) * 100,
    (sum(df_qanc_sn1$q2_pre) / total_n_sn1) * 100,
    (sum(df_qanc_sn1$q3_pre) / total_n_sn1) * 100,
    (sum(df_qanc_sn1$q4_pre) / total_n_sn1) * 100,
    (sum(df_qanc_sn1$q5_pre) / total_n_sn1) * 100,
    (sum(df_qanc_sn1$q6_pre) / total_n_sn1) * 100,
    (sum(df_qanc_sn1$q7_pre) / total_n_sn1) * 100,
    (sum(df_qanc_sn1$q8_pre) / total_n_sn1) * 100,
    (sum(df_qanc_sn1$q9_pre) / total_n_sn1) * 100,
    (sum(df_qanc_sn1$q10_pre) / total_n_sn1) * 100
  ),
  qanc_post = c(
    (sum(df_qanc_sn1$q1_post) / total_n_sn1) * 100,
    (sum(df_qanc_sn1$q2_post) / total_n_sn1) * 100,
    (sum(df_qanc_sn1$q3_post) / total_n_sn1) * 100,
    (sum(df_qanc_sn1$q4_post) / total_n_sn1) * 100,
    (sum(df_qanc_sn1$q5_post) / total_n_sn1) * 100,
    (sum(df_qanc_sn1$q6_post) / total_n_sn1) * 100,
    (sum(df_qanc_sn1$q7_post) / total_n_sn1) * 100,
    (sum(df_qanc_sn1$q8_post) / total_n_sn1) * 100,
    (sum(df_qanc_sn1$q9_post) / total_n_sn1) * 100,
    (sum(df_qanc_sn1$q10_post) / total_n_sn1) * 100
  )
)

# Anaemia
# Assuming df has a 'condition' column and we're filtering for rows where condition is 'ane'
df_ane_sn1 <- subset(df_sn1, condition == "ane")

# Calculate total_n for the filtered data
total_n_sn1 <- nrow(df_ane_sn1)

# Create the data frame with pre and post percentages for each question
st3_ane_sn1 <- data.frame(
  question = paste("Q", 1:10),
  ane_pre = c(
    (sum(df_ane_sn1$q1_pre) / total_n_sn1) * 100,
    (sum(df_ane_sn1$q2_pre) / total_n_sn1) * 100,
    (sum(df_ane_sn1$q3_pre) / total_n_sn1) * 100,
    (sum(df_ane_sn1$q4_pre) / total_n_sn1) * 100,
    (sum(df_ane_sn1$q5_pre) / total_n_sn1) * 100,
    (sum(df_ane_sn1$q6_pre) / total_n_sn1) * 100,
    (sum(df_ane_sn1$q7_pre) / total_n_sn1) * 100,
    (sum(df_ane_sn1$q8_pre) / total_n_sn1) * 100,
    (sum(df_ane_sn1$q9_pre) / total_n_sn1) * 100,
    (sum(df_ane_sn1$q10_pre) / total_n_sn1) * 100
  ),
  ane_post = c(
    (sum(df_ane_sn1$q1_post) / total_n_sn1) * 100,
    (sum(df_ane_sn1$q2_post) / total_n_sn1) * 100,
    (sum(df_ane_sn1$q3_post) / total_n_sn1) * 100,
    (sum(df_ane_sn1$q4_post) / total_n_sn1) * 100,
    (sum(df_ane_sn1$q5_post) / total_n_sn1) * 100,
    (sum(df_ane_sn1$q6_post) / total_n_sn1) * 100,
    (sum(df_ane_sn1$q7_post) / total_n_sn1) * 100,
    (sum(df_ane_sn1$q8_post) / total_n_sn1) * 100,
    (sum(df_ane_sn1$q9_post) / total_n_sn1) * 100,
    (sum(df_ane_sn1$q10_post) / total_n_sn1) * 100
  )
)

# Hypertension
df_htn_sn1 <- subset(df_sn1, condition == "htn")
total_n_sn1 <- nrow(df_htn_sn1)

# Create the data frame with pre and post percentages for each question
st3_htn_sn1 <- data.frame(
  question = paste("Q", 1:10),
  htn_pre = c(
    (sum(df_htn_sn1$q1_pre) / total_n_sn1) * 100,
    (sum(df_htn_sn1$q2_pre) / total_n_sn1) * 100,
    (sum(df_htn_sn1$q3_pre) / total_n_sn1) * 100,
    (sum(df_htn_sn1$q4_pre) / total_n_sn1) * 100,
    (sum(df_htn_sn1$q5_pre) / total_n_sn1) * 100,
    (sum(df_htn_sn1$q6_pre) / total_n_sn1) * 100,
    (sum(df_htn_sn1$q7_pre) / total_n_sn1) * 100,
    (sum(df_htn_sn1$q8_pre) / total_n_sn1) * 100,
    (sum(df_htn_sn1$q9_pre) / total_n_sn1) * 100,
    (sum(df_htn_sn1$q10_pre) / total_n_sn1) * 100
  ),
  htn_post = c(
    (sum(df_htn_sn1$q1_post) / total_n_sn1) * 100,
    (sum(df_htn_sn1$q2_post) / total_n_sn1) * 100,
    (sum(df_htn_sn1$q3_post) / total_n_sn1) * 100,
    (sum(df_htn_sn1$q4_post) / total_n_sn1) * 100,
    (sum(df_htn_sn1$q5_post) / total_n_sn1) * 100,
    (sum(df_htn_sn1$q6_post) / total_n_sn1) * 100,
    (sum(df_htn_sn1$q7_post) / total_n_sn1) * 100,
    (sum(df_htn_sn1$q8_post) / total_n_sn1) * 100,
    (sum(df_htn_sn1$q9_post) / total_n_sn1) * 100,
    (sum(df_htn_sn1$q10_post) / total_n_sn1) * 100
  )
)

# Gestational Diabetes
df_gdm_sn1 <- subset(df_sn1, condition == "gdm")
total_n_sn1 <- nrow(df_gdm_sn1)

# Create the data frame with pre and post percentages for each question
st3_gdm_sn1 <- data.frame(
  question = paste("Q", 1:10),
  gdm_pre = c(
    (sum(df_gdm_sn1$q1_pre) / total_n_sn1) * 100,
    (sum(df_gdm_sn1$q2_pre) / total_n_sn1) * 100,
    (sum(df_gdm_sn1$q3_pre) / total_n_sn1) * 100,
    (sum(df_gdm_sn1$q4_pre) / total_n_sn1) * 100,
    (sum(df_gdm_sn1$q5_pre) / total_n_sn1) * 100,
    (sum(df_gdm_sn1$q6_pre) / total_n_sn1) * 100,
    (sum(df_gdm_sn1$q7_pre) / total_n_sn1) * 100,
    (sum(df_gdm_sn1$q8_pre) / total_n_sn1) * 100,
    (sum(df_gdm_sn1$q9_pre) / total_n_sn1) * 100,
    (sum(df_gdm_sn1$q10_pre) / total_n_sn1) * 100
  ),
  gdm_post = c(
    (sum(df_gdm_sn1$q1_post) / total_n_sn1) * 100,
    (sum(df_gdm_sn1$q2_post) / total_n_sn1) * 100,
    (sum(df_gdm_sn1$q3_post) / total_n_sn1) * 100,
    (sum(df_gdm_sn1$q4_post) / total_n_sn1) * 100,
    (sum(df_gdm_sn1$q5_post) / total_n_sn1) * 100,
    (sum(df_gdm_sn1$q6_post) / total_n_sn1) * 100,
    (sum(df_gdm_sn1$q7_post) / total_n_sn1) * 100,
    (sum(df_gdm_sn1$q8_post) / total_n_sn1) * 100,
    (sum(df_gdm_sn1$q9_post) / total_n_sn1) * 100,
    (sum(df_gdm_sn1$q10_post) / total_n_sn1) * 100
  )
)

# Antepartum Hemorrhage
df_aph_sn1 <- subset(df_sn1, condition == "aph")
total_n_sn1 <- nrow(df_aph_sn1)

# Create the data frame with pre and post percentages for each question
st3_aph_sn1 <- data.frame(
  question = paste("Q", 1:10),
  aph_pre = c(
    (sum(df_aph_sn1$q1_pre) / total_n_sn1) * 100,
    (sum(df_aph_sn1$q2_pre) / total_n_sn1) * 100,
    (sum(df_aph_sn1$q3_pre) / total_n_sn1) * 100,
    (sum(df_aph_sn1$q4_pre) / total_n_sn1) * 100,
    (sum(df_aph_sn1$q5_pre) / total_n_sn1) * 100,
    (sum(df_aph_sn1$q6_pre) / total_n_sn1) * 100,
    (sum(df_aph_sn1$q7_pre) / total_n_sn1) * 100,
    (sum(df_aph_sn1$q8_pre) / total_n_sn1) * 100,
    (sum(df_aph_sn1$q9_pre) / total_n_sn1) * 100,
    (sum(df_aph_sn1$q10_pre) / total_n_sn1) * 100
  ),
  aph_post = c(
    (sum(df_aph_sn1$q1_post) / total_n_sn1) * 100,
    (sum(df_aph_sn1$q2_post) / total_n_sn1) * 100,
    (sum(df_aph_sn1$q3_post) / total_n_sn1) * 100,
    (sum(df_aph_sn1$q4_post) / total_n_sn1) * 100,
    (sum(df_aph_sn1$q5_post) / total_n_sn1) * 100,
    (sum(df_aph_sn1$q6_post) / total_n_sn1) * 100,
    (sum(df_aph_sn1$q7_post) / total_n_sn1) * 100,
    (sum(df_aph_sn1$q8_post) / total_n_sn1) * 100,
    (sum(df_aph_sn1$q9_post) / total_n_sn1) * 100,
    (sum(df_aph_sn1$q10_post) / total_n_sn1) * 100
  )
)

# Combine the data frames using cbind
df_questions_combined_sn1 <- cbind(
  st3_qanc_sn1[, c("question", "qanc_pre", "qanc_post")],
  st3_ane_sn1[, c("ane_pre", "ane_post")],
  st3_htn_sn1[, c("htn_pre", "htn_post")],
  st3_gdm_sn1[, c("gdm_pre", "gdm_post")],
  st3_aph_sn1[, c("aph_pre", "aph_post")]
)

# Round all percentage columns to 2 decimal places
df_questions_combined_sn1[, 2:ncol(df_questions_combined_sn1)] <- round(df_questions_combined_sn1[, 2:ncol(df_questions_combined_sn1)], 1)

# Create a gt table and apply some custom formatting
df_questions_combined_sn1_gt <- df_questions_combined_sn1 %>%
  gt() %>%
  cols_label(
    question = "Question",
    qanc_pre = "QANC Pre",
    qanc_post = "QANC Post",
    ane_pre = "ANE Pre",
    ane_post = "ANE Post",
    htn_pre = "HTN Pre",
    htn_post = "HTN Post",
    gdm_pre = "GDM Pre",
    gdm_post = "GDM Post",
    aph_pre = "APH Pre",
    aph_post = "APH Post"
  ) %>%
  tab_spanner(
    label = "Pre-Post Score Percentage ",
    columns = c("qanc_pre", "qanc_post", "ane_pre", "ane_post", 
                "htn_pre", "htn_post", "gdm_pre", "gdm_post", 
                "aph_pre", "aph_post")
  ) 

# Apply tab_style() to highlight cells with values < 50
for (col in c("qanc_pre", "qanc_post", "ane_pre", "ane_post", 
                "htn_pre", "htn_post", "gdm_pre", "gdm_post", 
                "aph_pre", "aph_post")) {
  df_questions_combined_sn1_gt <- df_questions_combined_sn1_gt %>%
    tab_style(
      style = list(
        cell_fill(color = "yellow"),  # Highlight only the specific cells
        cell_text(weight = "bold")    # Make text bold
      ),
      locations = cells_body(
        columns = col, 
        rows = df_questions_combined_sn1[[col]] < 50  # Apply condition per column
      )
    )
}

# Save the data frame to a CSV file
write.csv(df_questions_combined_sn1_gt, "tables/df_questions_combined_sn1_ts_gt.csv", row.names = FALSE)


```

# Phase 1 {.tabset}

## Row {.flow.small}

```{r}
#| content: valuebox
#| color: primary
#| title: "Topics"
#| font-size-content: 5

"Quality ANC"

```

```{r}
#| content: valuebox
#| color: primary
#| title: "Topics"
#| font-size-content: 5

"Anaemia"

```

```{r}
#| content: valuebox
#| color: primary
#| title: "Topics"
#| font-size-content: 5

"GDM"

```

```{r}
#| content: valuebox
#| color: primary
#| title: "Topics"
#| font-size-content: 5

"Hypertension"

```

```{r}
#| content: valuebox
#| color: primary
#| font-size-content: 5
#| title: "Topics"

"APH"

```

```{r}
#| content: valuebox
#| title: "MO (Approx.)"
#| color: success
#| font-size-content: 5

nrow(df_mo1[df_mo1$condition == 'qanc', ])
```

```{r}
#| content: valuebox
#| title: "ANM (Approx.)"
#| color: success
#| font-size-content: 5

nrow(df_anm1[df_anm1$condition == 'qanc', ])
```

```{r}
#| content: valuebox
#| title: "SN (Approx.)"
#| color: success
#| font-size-content: 5

nrow(df_sn1[df_sn1$condition == 'qanc', ])
```

## Row {.flow}

### Column {.tabset}

#### MO
```{r}
#| echo: false
#| warning: false
#| title: "<span style='font-size:14px;'>Districts Covered</span>"

# MO1 Telangana map
telangana_map_plot_mo1
```
#### ANM
```{r}
#| echo: false
#| warning: false
#| title: "<span style='font-size:14px;'>Districts Covered</span>"
#| asis: true

# ANM1 Telangana map
telangana_map_plot_anm1
```
#### SN
```{r}
#| echo: false
#| warning: false
#| title: "<span style='font-size:14px;'>Districts Covered</span>"

# SN1 Telangana map
telangana_map_plot_sn1
```

### Column {.tabset}

#### MO
```{r}
#| echo: false
#| warning: false
#| title: "<span style='font-size:14px;'>Mean Pre - Post Percentage</span>"
#| fig-cap: "<span style='font-size:12px;'>*Red- % Knowledge gain</span>"

# MO1 mean pre post
print(pre_post_mean_pct_mo1)
```
#### ANM
```{r}
#| echo: false
#| warning: false
#| title: "<span style='font-size:14px;'>Mean Pre - Post Percentage</span>"
#| fig-cap: "<span style='font-size:12px;'>*Red- % Knowledge gain</span>"

# ANM1 mean pre post
print(pre_post_mean_pct_anm1)
```
#### SN
```{r}
#| echo: false
#| warning: false
#| title: "<span style='font-size:14px;'>Mean Pre - Post Percentage</span>"
#| fig-cap: "<span style='font-size:12px;'>*Red- % Knowledge gain</span>"

# SN1 mean pre post
print(pre_post_mean_pct_sn1)
```

### Column {.tabset}

#### MO
```{r}
#| echo: false
#| warning: false
#| title: "<span style='font-size:14px;'>Relative Percentage Change</span>"
#| fig-cap: "<span style='font-size:10px;'><span style='font-weight:bold;'>Relative percentage change:</span> Shows increase or decrease in post test scores compared to pre test scores.<br><span style='font-weight:bold;'>Positive change:</span> Participants scored higher in post test than in pretest.<br> <span style='font-weight:bold;'>Negative change:</span> Participants scored lower in post test than in pretest.</span>"

# MO1 relative change
print(plot_relative_change_mo1)
```

#### ANM
```{r}
#| echo: false
#| warning: false
#| title: "<span style='font-size:14px;'>Relative Percentage Change</span>"
#| fig-cap: "<span style='font-size:10px;'><span style='font-weight:bold;'>Relative percentage change:</span> Shows increase or decrease in post test scores compared to pre test scores.<br><span style='font-weight:bold;'>Positive change:</span> Participants scored higher in post test than in pretest.<br> <span style='font-weight:bold;'>Negative change:</span> Participants scored lower in post test than in pretest.</span>"

# ANM1 relative change
print(plot_relative_change_anm1)
```

#### SN
```{r}
#| echo: false
#| warning: false
#| title: "<span style='font-size:14px;'>Relative Percentage Change</span>"
#| fig-cap: "<span style='font-size:10px;'><span style='font-weight:bold;'>Relative percentage change:</span> Shows increase or decrease in post test scores compared to pre test scores.<br><span style='font-weight:bold;'>Positive change:</span> Participants scored higher in post test than in pretest.<br> <span style='font-weight:bold;'>Negative change:</span> Participants scored lower in post test than in pretest.</span>"

# SN1 relative change
print(plot_relative_change_sn1)
```

## Row {.flow}

### Column {.tabset}
#### MO
```{r}
#| echo: false
#| warning: false
#| title: "<span style='font-size:14px;'>District-wise Analysis</span>"

# MO1 district wise
print(districtwise_combined_percentage_plot_mo1)
```
#### ANM
```{r}
#| echo: false
#| warning: false
#| title: "<span style='font-size:14px;'>District-wise Analysis</span>"

# ANM1 district wise
print(districtwise_combined_percentage_plot_anm1)
```
#### SN
```{r}
#| echo: false
#| warning: false
#| title: "<span style='font-size:14px;'>District-wise Analysis</span>"

# SN1 district wise
print(districtwise_combined_percentage_plot_sn1)
```

### Column {.tabset}
#### MO
```{r}
#| echo: false
#| warning: false
#| title: "<span style='font-size:14px;'>Question-wise Analysis</span>"
#| fig-cap: "<span style='font-size:12px;'>*Yellow- Test score below 50%</span>"

# MO1 district wise
df_questions_combined_mo1_gt
```
#### ANM
```{r}
#| echo: false
#| warning: false
#| title: "<span style='font-size:14px;'>Question-wise Analysis</span>"
#| fig-cap: "<span style='font-size:12px;'>*Yellow- Test score below 50%</span>"

# ANM1 district wise
df_questions_combined_anm1_gt
```
#### SN
```{r}
#| echo: false
#| warning: false
#| title: "<span style='font-size:14px;'>Question-wise Analysis</span>"
#| fig-cap: "<span style='font-size:12px;'>*Yellow- Test score below 50%</span>"

# SN1 district wise
df_questions_combined_sn1_gt
```

# Phase 2 {.tabset}

## Row {.flow.small}

```{r}
#| content: valuebox
#| color: primary
#| title: "Topics"
#| font-size-content: 5

"Prev LSCS"

```

```{r}
#| content: valuebox
#| color: primary
#| title: "Topics"
#| font-size-content: 5

"SOB"

```

```{r}
#| content: valuebox
#| color: primary
#| title: "Topics"
#| font-size-content: 5

"TB"

```

```{r}
#| content: valuebox
#| color: primary
#| title: "Topics"
#| font-size-content: 5

"Jaundice"

```

```{r}
#| content: valuebox
#| color: primary
#| font-size-content: 5
#| title: "Topics"

"Epilepsy"

```

```{r}
#| content: valuebox
#| color: primary
#| font-size-content: 5
#| title: "Topics"

"Heart Disease"

```

```{r}
#| content: valuebox
#| title: "MO (Approx.)"
#| color: success
#| font-size-content: 5

nrow(df_mo2[df_mo2$condition == 'jau', ])
```

```{r}
#| content: valuebox
#| title: "ANM (Approx.)"
#| color: success
#| font-size-content: 5

nrow(df_anm2[df_anm2$condition == 'jau', ])
```

## Row {.flow}

### Districts Covered {.tabset}

#### MO
```{r}
#| echo: false
#| warning: false
#| title: "<span style='font-size:14px;'>Districts Covered</span>"

# MO2 Telangana map
print(telangana_map_plot_mo2)
```
#### ANM
```{r}
#| echo: false
#| warning: false
#| title: "<span style='font-size:14px;'>Districts Covered</span>"

# ANM1 Telangana map
print(telangana_map_plot_anm2)
```

### Column {.tabset}

#### MO
```{r}
#| echo: false
#| warning: false
#| title: "<span style='font-size:14px;'>Mean Pre - Post Percentage</span>"
#| fig-cap: "<span style='font-size:12px;'>*Red- % Knowledge gain</span>"

# MO1 mean pre post
print(pre_post_mean_pct_mo2)
```
#### ANM
```{r}
#| echo: false
#| warning: false
#| title: "<span style='font-size:14px;'>Mean Pre - Post Percentage</span>"
#| fig-cap: "<span style='font-size:12px;'>*Red- % Knowledge gain</span>"

# ANM1 mean pre post
print(pre_post_mean_pct_anm2)
```

### Column {.tabset}

#### MO
```{r}
#| echo: false
#| warning: false
#| title: "<span style='font-size:14px;'>Relative Percentage Change</span>"
#| fig-cap: "<span style='font-size:10px;'><span style='font-weight:bold;'>Relative percentage change:</span> Shows increase or decrease in post test scores compared to pre test scores.<br><span style='font-weight:bold;'>Positive change:</span> Participants scored higher in post test than in pretest.<br> <span style='font-weight:bold;'>Negative change:</span> Participants scored lower in post test than in pretest.</span>"

# MO1 relative change
print(plot_relative_change_mo2)
```

#### ANM
```{r}
#| echo: false
#| warning: false
#| title: "<span style='font-size:14px;'>Relative Percentage Change</span>"
#| fig-cap: "<span style='font-size:10px;'><span style='font-weight:bold;'>Relative percentage change:</span> Shows increase or decrease in post test scores compared to pre test scores.<br><span style='font-weight:bold;'>Positive change:</span> Participants scored higher in post test than in pretest.<br> <span style='font-weight:bold;'>Negative change:</span> Participants scored lower in post test than in pretest.</span>"

# ANM1 relative change
print(plot_relative_change_anm2)
```

## Row {.flow}

### Column {.tabset}
#### MO
```{r}
#| echo: false
#| warning: false
#| title: "<span style='font-size:14px;'>District-wise Analysis</span>"

# MO1 district wise
print(districtwise_combined_percentage_plot_mo2)
```
#### ANM
```{r}
#| echo: false
#| warning: false
#| title: "<span style='font-size:14px;'>District-wise Analysis</span>"

# ANM1 district wise
print(districtwise_combined_percentage_plot_anm2)
```

### Column {.tabset}
#### MO
```{r}
#| echo: false
#| warning: false
#| title: "<span style='font-size:14px;'>Question-wise Analysis</span>"
#| fig-cap: "<span style='font-size:12px;'>*Yellow- Test score below 50%</span>"

# MO1 district wise
df_questions_combined_mo2_gt
```
#### ANM
```{r}
#| echo: false
#| warning: false
#| title: "<span style='font-size:14px;'>Question-wise Analysis</span>"
#| fig-cap: "<span style='font-size:12px;'>*Yellow- Test score below 50%</span>"

# ANM1 district wise
df_questions_combined_anm2_gt
```

